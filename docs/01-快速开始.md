# 快速开始

本指南将帮助你快速上手 OCORM，在 5 分钟内完成一个基本的数据库操作示例。

## 前置要求

- HarmonyOS NEXT (API 17+) 或 OpenHarmony 5.0+
- ArkTS 开发环境
- TypeScript 5.0+

## 步骤 1：安装依赖

在项目的 `oh-package.json5` 中添加 OCORM 依赖：

```json5
{
  "dependencies": {
    "ocorm": "file:../OCORM"
  }
}
```

然后执行安装命令：

```bash
npm install
```

## 步骤 2：定义实体

创建一个实体类来映射数据库表。OCORM 使用**装饰器 + 手动注册**的方式定义实体。

```typescript
// entities/User.ts
import {
  ColumnMetadata,
  ColumnType,
  registerEntity,
  registerAutoIncrementPrimaryKey,
  createEntityOptions
} from 'ocorm'

// 注册实体（表名默认为 'users'）
registerEntity('User', createEntityOptions('users'))

// 注册自增主键
registerAutoIncrementPrimaryKey('User', 'id', 'id')

// 注册列元数据
const storage = MetadataStorage.getInstance()

// name 列
const nameColumn = new ColumnMetadata('name', 'name')
nameColumn.columnType = ColumnType.TEXT
nameColumn.isNullable = false
storage.registerColumn('User', nameColumn)

// email 列
const emailColumn = new ColumnMetadata('email', 'email')
emailColumn.columnType = ColumnType.TEXT
emailColumn.isUnique = true
storage.registerColumn('User', emailColumn)

// age 列
const ageColumn = new ColumnMetadata('age', 'age')
ageColumn.columnType = ColumnType.INTEGER
ageColumn.defaultValue = 0
storage.registerColumn('User', ageColumn)
```

> **提示**：为了代码整洁，建议将实体定义封装成一个初始化函数。

## 步骤 3：初始化数据库

在应用启动时初始化数据库：

```typescript
// database/DBManager.ts
import { DatabaseManager, DatabaseConfig, SchemaBuilder } from 'ocorm'
import { relationalStore } from '@kit.ArkData'

export async function initDatabase(context: Context): Promise<void> {
  // 1. 配置数据库
  const config = new DatabaseConfig(
    'myapp.db',                      // 数据库文件名
    relationalStore.SecurityLevel.S1 // 安全级别
    // encrypt: false                 // 可选：是否加密
  )
  
  // 启用查询缓存
  config.enableQueryCache = true
  config.queryCacheMaxSize = 200
  
  // 2. 初始化数据库管理器
  await DatabaseManager.getInstance().initialize(context, config)
  
  // 3. 创建表结构
  const schemaBuilder = new SchemaBuilder()
  const result = await schemaBuilder.createAllTablesWithManager()
  
  if (result.success) {
    console.info(`数据库初始化成功，创建了 ${result.successCount} 张表`)
  } else {
    console.error(`数据库初始化失败: ${result.results[0]?.errorMessage}`)
  }
}
```

在应用入口调用初始化：

```typescript
// EntryAbility.ts
import { initDatabase } from './database/DBManager'

export default class EntryAbility extends Ability {
  onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    // 初始化数据库
    initDatabase(this.context)
      .then(() => console.info('数据库初始化完成'))
      .catch((err) => console.error(`数据库初始化失败: ${err.message}`))
  }
}
```

## 步骤 4：进行 CRUD 操作

现在可以进行数据库操作了：

```typescript
// services/UserService.ts
import { Repository, EntityData, ConditionOperator } from 'ocorm'

export class UserService {
  private repo: Repository
  
  constructor() {
    this.repo = new Repository('User')
  }
  
  // 创建用户
  async createUser(name: string, email: string, age: number = 18): Promise<void> {
    const userData = EntityData.from('User', {
      name: name,
      email: email,
      age: age
    })
    
    const result = await this.repo.save(userData)
    if (result.success) {
      console.info(`用户创建成功，ID: ${result.insertId}`)
    }
  }
  
  // 根据 ID 查询用户
  async getUserById(id: number): Promise<EntityData | null> {
    return await this.repo.findById(id)
  }
  
  // 查询所有用户
  async getAllUsers(): Promise<EntityData[]> {
    return await this.repo.findAll()
  }
  
  // 条件查询
  async getAdultUsers(): Promise<EntityData[]> {
    return await this.repo.createQueryBuilder()
      .where('age', ConditionOperator.GREATER_OR_EQUAL, 18)
      .orderBy('name', 'ASC')
      .getMany()
  }
  
  // 更新用户
  async updateUserAge(id: number, newAge: number): Promise<void> {
    const user = await this.repo.findById(id)
    if (user) {
      user.setPropertyValue('age', newAge)
      await this.repo.save(user)
      console.info(`用户 ${id} 年龄已更新`)
    }
  }
  
  // 删除用户
  async deleteUser(id: number): Promise<void> {
    await this.repo.removeById(id)
    console.info(`用户 ${id} 已删除`)
  }
}
```

## 步骤 5：运行验证

```typescript
// 测试代码
async function testUserService() {
  const userService = new UserService()
  
  // 创建用户
  await userService.createUser('张三', 'zhangsan@example.com', 25)
  await userService.createUser('李四', 'lisi@example.com', 30)
  
  // 查询用户
  const users = await userService.getAllUsers()
  console.info(`共有 ${users.length} 个用户`)
  
  // 条件查询
  const adults = await userService.getAdultUsers()
  console.info(`成年用户: ${adults.length} 个`)
}
```

## 完整示例项目结构

```
entry/
├── src/main/ets/
│   ├── entities/              # 实体定义
│   │   ├── User.ts
│   │   └── Order.ts
│   ├── database/              # 数据库配置
│   │   └── DBManager.ts
│   ├── services/              # 业务服务
│   │   └── UserService.ts
│   └── pages/
│       └── Index.ets          # 页面
├── module.json5
└── oh-package.json5
```

## 下一步

- [实体定义](03-实体定义.md) - 深入了解如何定义实体和列
- [CRUD 操作](04-CRUD操作.md) - 了解更多 CRUD 操作
- [查询构建器](05-查询构建器.md) - 掌握链式查询 API
- [完整示例](16-完整示例.md) - 查看完整的业务场景示例

## 常见问题

### Q: 实体类需要继承某个基类吗？

**不需要**。OCORM 采用轻量级设计，实体类可以是普通的 TypeScript 类，不需要继承任何基类。

### Q: 如何处理主键？

OCORM 支持多种主键类型，推荐使用**自增主键**：

```typescript
registerAutoIncrementPrimaryKey('User', 'id', 'id')
```

也支持**手动指定主键**：

```typescript
registerPrimaryKey('User', 'uuid', 'uuid')
```

### Q: 表名和类名可以不同吗？

可以。在注册实体时指定表名：

```typescript
registerEntity('User', createEntityOptions('t_users'))  // 表名为 t_users
```




