# 数据库迁移

本章节介绍 OCORM 的数据库迁移功能，用于管理数据库 Schema 的版本变更。

## 概述

数据库迁移（Migration）用于：

- 版本化数据库 Schema
- 安全地修改表结构
- 多人协作开发
- 生产环境部署

## MigrationManager

### 基本使用

```typescript
import { MigrationManager } from 'ocorm'

const migrationManager = new MigrationManager()

// 执行迁移到最新版本
await migrationManager.migrate()
```

### 手动执行迁移

```typescript
import { MigrationManager, Migration } from 'ocorm'

// 创建迁移
const migration = new Migration('add_user_profile', '添加用户简介表')

// 添加迁移步骤
migration.addStep('CREATE TABLE IF NOT EXISTS user_profiles (...)', async (store) => {
  await store.executeSql('CREATE TABLE IF NOT EXISTS user_profiles (...)')
})

migration.addStep('CREATE INDEX idx_user_id', async (store) => {
  await store.executeSql('CREATE INDEX idx_user_id ON user_profiles(user_id)')
})

// 注册迁移
migrationManager.addMigration(migration)

// 执行到指定版本
await migrationManager.migrateToVersion('add_user_profile')
```

## 创建迁移

### 迁移模板

```typescript
// migrations/001_add_user_status.ts
import { Migration } from 'ocorm'

export class AddUserStatusMigration extends Migration {
  constructor() {
    super('001_add_user_status', '添加用户状态字段')
  }

  async up(store: relationalStore.RdbStore): Promise<void> {
    // 添加新列
    await store.executeSql(`
      ALTER TABLE users ADD COLUMN status INTEGER DEFAULT 1
    `)
    
    // 创建索引
    await store.executeSql(`
      CREATE INDEX idx_users_status ON users(status)
    `)
  }

  async down(store: relationalStore.RdbStore): Promise<void> {
    // 回滚操作
    await store.executeSql(`DROP INDEX IF EXISTS idx_users_status`)
    await store.executeSql(`ALTER TABLE users DROP COLUMN status`)
  }
}

// 注册迁移
migrationManager.addMigration(new AddUserStatusMigration())
```

### 常见迁移操作

#### 添加列

```typescript
async up(store: relationalStore.RdbStore): Promise<void> {
  await store.executeSql(`
    ALTER TABLE users ADD COLUMN phone TEXT
  `)
}

async down(store: relationalStore.RdbStore): Promise<void> {
  await store.executeSql(`
    ALTER TABLE users DROP COLUMN phone
  `)
}
```

#### 删除列

```typescript
async up(store: relationalStore.RdbStore): Promise<void> {
  // SQLite 不支持直接删除列，需要创建新表
  await store.executeSql(`
    CREATE TABLE users_new (
      id INTEGER PRIMARY KEY,
      name TEXT,
      email TEXT
    )
  `)
  
  await store.executeSql(`
    INSERT INTO users_new (id, name, email)
    SELECT id, name, email FROM users
  `)
  
  await store.executeSql(`DROP TABLE users`)
  await store.executeSql(`ALTER TABLE users_new RENAME TO users`)
}
```

#### 重命名列

```typescript
async up(store: relationalStore.RdbStore): Promise<void> {
  await store.executeSql(`
    CREATE TABLE users_new (
      id INTEGER PRIMARY KEY,
      user_name TEXT,
      email TEXT
    )
  `)
  
  await store.executeSql(`
    INSERT INTO users_new (id, user_name, email)
    SELECT id, name, email FROM users
  `)
  
  await store.executeSql(`DROP TABLE users`)
  await store.executeSql(`ALTER TABLE users_new RENAME TO users`)
}
```

#### 创建索引

```typescript
async up(store: relationalStore.RdbStore): Promise<void> {
  await store.executeSql(`
    CREATE INDEX idx_users_email ON users(email)
  `)
}

async down(store: relationalStore.RdbStore): Promise<void> {
  await store.executeSql(`DROP INDEX IF EXISTS idx_users_email`)
}
```

#### 创建新表

```typescript
async up(store: relationalStore.RdbStore): Promise<void> {
  await store.executeSql(`
    CREATE TABLE IF NOT EXISTS user_sessions (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      user_id INTEGER NOT NULL,
      token TEXT NOT NULL,
      expired_at INTEGER,
      created_at INTEGER,
      FOREIGN KEY (user_id) REFERENCES users(id)
    )
  `)
  
  await store.executeSql(`
    CREATE INDEX idx_sessions_user_id ON user_sessions(user_id)
  `)
}

async down(store: relationalStore.RdbStore): Promise<void> {
  await store.executeSql(`DROP TABLE IF EXISTS user_sessions`)
}
```

## 版本管理

### 查看当前版本

```typescript
const currentVersion = await migrationManager.getCurrentVersion()
console.info(`当前数据库版本: ${currentVersion}`)
```

### 迁移到指定版本

```typescript
// 迁移到特定版本
await migrationManager.migrateToVersion('001_add_user_status')

// 迁移到最新版本
await migrationManager.migrate()
```

### 回滚迁移

```typescript
// 回滚到上一个版本
await migrationManager.rollback()

// 回滚到指定版本
await migrationManager.migrateToVersion('000_initial')
```

## 迁移管理器配置

### 创建迁移管理器

```typescript
import { MigrationManager } from 'ocorm'

const migrationManager = new MigrationManager({
  tableName: '_migrations',  // 迁移记录表名，默认 _migrations
  enableLog: true            // 启用迁移日志
})
```

### 注册迁移

```typescript
import { MigrationManager } from 'ocorm'
import { InitialMigration } from './migrations/000_initial'
import { AddUserStatusMigration } from './migrations/001_add_user_status'
import { AddUserProfileMigration } from './migrations/002_add_user_profile'

// 按顺序注册迁移
migrationManager.addMigration(new InitialMigration())
migrationManager.addMigration(new AddUserStatusMigration())
migrationManager.addMigration(new AddUserProfileMigration())
```

## 数据迁移

### 数据转换

在结构变更时保留数据：

```typescript
async up(store: relationalStore.RdbStore): Promise<void> {
  // 1. 创建临时表
  await store.executeSql(`
    CREATE TABLE users_new (
      id INTEGER PRIMARY KEY,
      name TEXT,
      full_name TEXT,
      email TEXT
    )
  `)
  
  // 2. 复制并转换数据
  await store.executeSql(`
    INSERT INTO users_new (id, name, full_name, email)
    SELECT 
      id,
      substr(name, 1, instr(name, ' ') - 1) as name,
      name as full_name,
      email
    FROM users
  `)
  
  // 3. 删除旧表
  await store.executeSql(`DROP TABLE users`)
  
  // 4. 重命名新表
  await store.executeSql(`ALTER TABLE users_new RENAME TO users`)
}
```

### 数据迁移示例

```typescript
// migrations/003_normalize_user_names.ts
export class NormalizeUserNamesMigration extends Migration {
  constructor() {
    super('003_normalize_user_names', '规范化用户姓名')
  }

  async up(store: relationalStore.RdbStore): Promise<void> {
    // 创建临时表
    await store.executeSql(`
      CREATE TABLE users_temp (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        first_name TEXT NOT NULL,
        last_name TEXT NOT NULL,
        email TEXT UNIQUE,
        created_at INTEGER
      )
    `)
    
    // 复制数据并进行姓名分割
    await store.executeSql(`
      INSERT INTO users_temp (id, first_name, last_name, email, created_at)
      SELECT 
        id,
        CASE 
          WHEN instr(name, ' ') > 0 
          THEN substr(name, 1, instr(name, ' ') - 1)
          ELSE name 
        END as first_name,
        CASE 
          WHEN instr(name, ' ') > 0 
          THEN substr(name, instr(name, ' ') + 1)
          ELSE ''
        END as last_name,
        email,
        created_at
      FROM users
    `)
    
    // 删除旧表
    await store.executeSql(`DROP TABLE users`)
    
    // 重命名
    await store.executeSql(`ALTER TABLE users_temp RENAME TO users`)
    
    // 创建索引
    await store.executeSql(`CREATE INDEX idx_users_email ON users(email)`)
  }

  async down(store: relationalStore.RdbStore): Promise<void> {
    // 回滚：重新组合姓名
    await store.executeSql(`
      CREATE TABLE users_backup (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT,
        email TEXT,
        created_at INTEGER
      )
    `)
    
    await store.executeSql(`
      INSERT INTO users_backup (id, name, email, created_at)
      SELECT 
        id,
        first_name || ' ' || last_name as name,
        email,
        created_at
      FROM users
    `)
    
    await store.executeSql(`DROP TABLE users`)
    await store.executeSql(`ALTER TABLE users_backup RENAME TO users`)
  }
}
```

## 最佳实践

### 1. 迁移命名规范

```typescript
// 使用序号 + 描述性名称
'm001_add_user_status'    // 添加字段
'm002_create_user_profile' // 创建新表
'm003_add_user_index'     // 添加索引
```

### 2. 迁移脚本原则

```typescript
// ✅ 正确的做法
async up(store: relationalStore.RdbStore): Promise<void> {
  // 1. 先测试在开发环境
  // 2. 确保有回滚方案
  // 3. 记录数据变更
}

// ❌ 错误的做法
async up(store: relationalStore.RdbStore): Promise<void> {
  // 不要直接删除大量数据
  // 不要在迁移中执行耗时操作
}
```

### 3. 备份数据

```typescript
// 迁移前备份数据
async up(store: relationalStore.RdbStore): Promise<void> {
  // 创建备份表
  await store.executeSql(`CREATE TABLE users_backup AS SELECT * FROM users`)
  
  // 执行迁移
  // ...
}
```

## 完整示例

```typescript
// database/MigrationManager.ts
import {
  MigrationManager as OCORMMigrationManager,
  Migration
} from 'ocorm'
import { relationalStore } from '@kit.ArkData'
import { DatabaseManager } from '../database/DatabaseManager'

// 导入所有迁移
import { InitialMigration } from './migrations/000_initial'
import { AddUserStatusMigration } from './migrations/001_add_user_status'
import { AddUserProfileMigration } from './migrations/002_add_user_profile'

class MigrationManager {
  private manager: OCORMMigrationManager

  constructor() {
    this.manager = new OCORMMigrationManager({
      tableName: '_migrations',
      enableLog: true
    })
    
    // 注册迁移
    this.registerMigrations()
  }

  private registerMigrations(): void {
    this.manager.addMigration(new InitialMigration())
    this.manager.addMigration(new AddUserStatusMigration())
    this.manager.addMigration(new AddUserProfileMigration())
  }

  async migrate(): Promise<void> {
    const dbManager = DatabaseManager.getInstance()
    if (!dbManager.isInitialized()) {
      throw new Error('数据库未初始化')
    }
    
    await this.manager.migrate()
    console.info('数据库迁移完成')
  }

  async getStatus(): Promise<{
    currentVersion: string
    latestVersion: string
    pendingMigrations: string[]
  }> {
    const current = await this.manager.getCurrentVersion()
    const latest = this.manager.getLatestVersion()
    const pending = await this.manager.getPendingMigrations()
    
    return {
      currentVersion: current,
      latestVersion: latest,
      pendingMigrations: pending
    }
  }
}

export const migrationManager = new MigrationManager()
```

## 下一步

- [日志系统](11-日志系统.md) - 了解迁移日志记录
- [错误处理](12-错误处理.md) - 处理迁移错误




