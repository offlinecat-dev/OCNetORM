# OCORM åŠŸèƒ½å¢å¼ºè·¯çº¿å›¾

> æœ¬æ–‡æ¡£åˆ—å‡º OCORM æœªæ¥ç‰ˆæœ¬å¯å¢å¼ºæˆ–æ–°å¢çš„åŠŸèƒ½å»ºè®®ã€‚æ‰€æœ‰æ–°åŠŸèƒ½å‡å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰ APIã€‚

---

## ğŸ§ª æµ‹è¯•è½ç‚¹çº¦å®š

- æœ¬è·¯çº¿å›¾æ¶‰åŠçš„åŠŸèƒ½å¢å¼ºä¸å›å½’æµ‹è¯•ï¼Œç»Ÿä¸€å†™åœ¨ `entry/src/main/ets` ç›®å½•ï¼ˆæ¨èæ”¾åœ¨ `entry/src/main/ets/suites`ï¼‰ã€‚
- `OCORM/src/test` ä¿ç•™ä¸ºåº“çº§å•å…ƒæµ‹è¯•ç›®å½•ï¼Œä¸ä½œä¸ºæœ¬è·¯çº¿å›¾å¢é‡åŠŸèƒ½çš„é»˜è®¤éªŒæ”¶è½ç‚¹ã€‚

---

## ğŸ“‹ ç°æœ‰åŠŸèƒ½æ¦‚è§ˆ

| æ¨¡å— | å·²å®ç°åŠŸèƒ½ |
|------|-----------|
| **å®ä½“å®šä¹‰** | defineEntityã€è£…é¥°å™¨ï¼ˆ@Tableã€@Columnã€@PrimaryKeyã€@CreatedAtã€@UpdatedAtã€@SoftDeleteï¼‰ã€ç±»å‹æ¨æ–­ |
| **CRUD** | saveã€findByIdã€findAllã€findAllAsyncã€removeã€forceRemoveã€restoreã€count |
| **æŸ¥è¯¢æ„å»ºå™¨** | where/andWhere/orWhereã€whereIn/whereNull/whereLike/whereBetweenã€whereExistsï¼ˆå­æŸ¥è¯¢ï¼‰ã€orderByã€limit/offsetã€selectã€paginateã€chunkã€timeout |
| **å…³è”å…³ç³»** | OneToOneã€OneToManyã€ManyToManyã€çº§è”æ“ä½œã€attach/detach/syncã€withï¼ˆé¢„åŠ è½½ï¼‰ã€withLazyï¼ˆå»¶è¿ŸåŠ è½½ï¼‰ã€withWhereï¼ˆå…³è”è¿‡æ»¤ï¼‰ã€withCountï¼ˆå…³è”è®¡æ•°ï¼‰ |
| **äº‹åŠ¡** | transactionã€transactionWithOptionsï¼ˆè¶…æ—¶/é‡è¯•/éš”ç¦»çº§åˆ«/åªè¯»ï¼‰ |
| **æ‰¹é‡æ“ä½œ** | batchInsertã€saveAll |
| **è½¯åˆ é™¤** | withDeletedã€onlyDeletedã€restore |
| **éªŒè¯** | @Requiredã€@Lengthã€@Email |
| **è¿ç§»** | MigrationManagerã€autoMigrateã€ç‰ˆæœ¬æ§åˆ¶ã€SchemaDiffer |
| **ç¼“å­˜** | QueryCacheï¼ˆä¸€çº§ç¼“å­˜ã€TTLã€LRUã€ç»Ÿè®¡ï¼‰ |
| **æ—¥å¿—** | Loggerï¼ˆå¤šçº§åˆ«æ—¥å¿—ã€æŸ¥è¯¢æ—¥å¿—ã€äº‹åŠ¡æ—¥å¿—ï¼‰ |
| **é’©å­** | beforeSaveã€afterLoadã€beforeDelete |

---

## ğŸš€ å¢å¼ºå»ºè®®ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰

### ä¸€ã€æŸ¥è¯¢å¢å¼ºï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

#### 1.1 èšåˆå‡½æ•°æ”¯æŒ âœ… å·²å®ç°
```typescript
// å·²å®ç° API
await repo.sum('price')
await repo.avg('price')
await repo.max('price')
await repo.min('price')

// æˆ–é€šè¿‡ QueryBuilder
const total = await repo.createQueryBuilder()
  .where('status', ConditionOperator.EQUAL, 'active')
  .sum('price')
```

#### 1.2 åˆ†ç»„æŸ¥è¯¢ï¼ˆGROUP BYï¼‰ âœ… å·²å®ç°
```typescript
const result = await repo.createQueryBuilder()
  .selectRaw(['category', 'COUNT(*) as count', 'SUM(price) as total'])
  .groupBy('category')
  .having('COUNT(*) > ?', [5])
  .aggregate()

// è®¿é—®ç»“æœ
for (const row of result.getRows()) {
  console.log(row.getString('category'), row.getNumber('count'))
}
```

#### 1.3 åŸç”Ÿ SQL æŸ¥è¯¢ âœ… å·²å®ç°
```typescript
// æ‰§è¡ŒåŸç”Ÿ SQLï¼ˆåªè¯»ï¼‰
const results = await repo.rawQuery(
  'SELECT * FROM users WHERE age > ?',
  [18]
)

// æ‰§è¡ŒåŸç”Ÿ SQLï¼ˆå†™æ“ä½œï¼‰
await repo.rawExecute(
  'UPDATE users SET status = ? WHERE last_login < ?',
  ['inactive', timestamp]
)
```

#### 1.4 æŸ¥è¯¢ä½œç”¨åŸŸï¼ˆQuery Scopesï¼‰ âœ… å·²å®ç°
```typescript
// å®šä¹‰å¯å¤ç”¨çš„æŸ¥è¯¢æ¡ä»¶
defineEntity('User', {
  columns: [...],
  scopes: {
    active: (qb) => qb.where('status', ConditionOperator.EQUAL, 'active'),
    adult: (qb) => qb.where('age', ConditionOperator.GREATER_EQUAL, 18),
    recent: (qb) => qb.orderBy('createdAt', 'DESC').limit(10)
  }
})

// ä½¿ç”¨å•ä¸ªä½œç”¨åŸŸ
await repo.createQueryBuilder()
  .scope('active')
  .scope('adult')
  .get()

// ä½¿ç”¨å¤šä¸ªä½œç”¨åŸŸ
await repo.createQueryBuilder()
  .scopes(['active', 'adult'])
  .get()
```

---

### äºŒã€éªŒè¯å¢å¼ºï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

#### 2.1 æ›´å¤šéªŒè¯è£…é¥°å™¨ âœ… å·²å®ç°
```typescript
@Min(0)           // æœ€å°å€¼
@Max(100)         // æœ€å¤§å€¼
@Range(0, 100)    // èŒƒå›´
@Pattern(/^\d+$/) // æ­£åˆ™åŒ¹é…
@Unique()         // å”¯ä¸€æ€§ï¼ˆæ•°æ®åº“çº§åˆ«ï¼‰
@Phone()          // æ‰‹æœºå·æ ¼å¼
@URL()            // URL æ ¼å¼
@Date()           // æ—¥æœŸæ ¼å¼
@Enum(['A','B'])  // æšä¸¾å€¼
@Custom(fn)       // è‡ªå®šä¹‰éªŒè¯å‡½æ•°
```

#### 2.2 æ¡ä»¶éªŒè¯ âœ… å·²å®ç°
```typescript
@RequiredIf('type', 'premium')  // æ¡ä»¶å¿…å¡«
@RequiredUnless('role', 'admin') // æ¡ä»¶éå¿…å¡«
```

#### 2.3 éªŒè¯åˆ†ç»„ âœ… å·²å®ç°
```typescript
// ä¸åŒåœºæ™¯ä½¿ç”¨ä¸åŒéªŒè¯è§„åˆ™
@Required({ groups: ['create'] })
@Length({ min: 6, groups: ['create', 'update'] })

// ä½¿ç”¨æ—¶æŒ‡å®šåˆ†ç»„
EntityValidator.validate(entityName, data, { groups: ['create'] })
```

---

### ä¸‰ã€å…³è”å…³ç³»å¢å¼ºï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

#### 3.1 åµŒå¥—é¢„åŠ è½½ âœ… å·²å®ç°
```typescript
// åŠ è½½å¤šå±‚å…³è”
await repo.createQueryBuilder()
  .with('posts.comments.author')  // åµŒå¥—åŠ è½½
  .with('profile')
  .get()
```

#### 3.2 å…³è”æ¡ä»¶è¿‡æ»¤ âœ… å·²å®ç°
```typescript
// åŠ è½½å…³è”æ—¶æ·»åŠ è¿‡æ»¤æ¡ä»¶
await repo.createQueryBuilder()
  .withWhere('posts', (qb) => {
    qb.where('status', '=', 'published')
      .orderBy('createdAt', 'DESC')
      .limit(5)
  })
  .get()
```

#### 3.3 å…³è”è®¡æ•° âœ… å·²å®ç°
```typescript
// åªè·å–å…³è”æ•°é‡ï¼Œä¸åŠ è½½å®é™…æ•°æ®
await repo.createQueryBuilder()
  .withCount('posts')
  .withCount('comments')
  .get()

// ç»“æœ: { id: 1, name: 'John', posts_count: 10, comments_count: 25 }
```

#### 3.4 å¤šæ€å…³è” âœ… 9.4 å·²å®ç°
```typescript
// å£°æ˜å¼æ³¨å†Œ
defineEntity('Comment', {
  columns: [...],
  morphTo: { name: 'commentable', idColumn: 'commentableId', typeColumn: 'commentableType' }
})

// æŸ¥è¯¢èƒ½åŠ›ï¼ˆå½“å‰ï¼‰
await repo.createQueryBuilder().with('commentable').get()
await repo.createQueryBuilder().with('commentable.profile').get()
await repo.createQueryBuilder().withLazy('commentable').get()
await repo.createQueryBuilder().withCount('commentable').get()
await repo.createQueryBuilder().withCount('commentable.profile').get()
await repo.createQueryBuilder().withWhere('commentable', (qb) => qb.limit(1)).get()
await repo.createQueryBuilder().withWhere('commentable.profile', (qb) => qb.limit(1)).get()
```

> è¯´æ˜ï¼š
> - éæ³•åµŒå¥—è·¯å¾„ï¼ˆå¦‚ `commentable.notExistRelation`ï¼‰åœ¨æ‰§è¡Œé˜¶æ®µæŠ›å‡º `ExecutionError`

---

### å››ã€æ€§èƒ½ä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

#### 4.1 æ‰¹é‡æ›´æ–°/åˆ é™¤ âœ… å·²å®ç°
```typescript
// æ‰¹é‡æ›´æ–°ï¼ˆä¸åŠ è½½å®ä½“ï¼‰
await repo.createQueryBuilder()
  .where('status', '=', 'pending')
  .update(
    BatchUpdateValues.create()
      .set('status', 'processed')
      .set('updatedAt', Date.now())
  )

// æ‰¹é‡åˆ é™¤
await repo.createQueryBuilder()
  .where('createdAt', '<', oneYearAgo)
  .delete()
```

#### 4.2 åˆ†å—æŸ¥è¯¢ï¼ˆå¤§æ•°æ®é‡ï¼‰ âœ… å·²å®ç°
```typescript
// åˆ†æ‰¹å¤„ç†æ•°æ®ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤š
await repo.createQueryBuilder()
  .chunk(100, async (entities) => {
    for (const entity of entities) {
      await processEntity(entity)
    }
  })
```

- çŠ¶æ€ï¼šâœ… å·²å®Œæˆï¼ˆ2026-02-10ï¼Œentry æ¨¡å— ETS æµ‹è¯•é€šè¿‡ï¼‰

---

### äº”ã€å¼€å‘ä½“éªŒå¢å¼ºï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

#### 5.1 æ›´å¤šç”Ÿå‘½å‘¨æœŸé’©å­
```typescript
// ç°æœ‰é’©å­: beforeSave, afterLoad, beforeDelete
// å»ºè®®æ–°å¢é’©å­:
beforeInsert   // ä»…æ’å…¥å‰ï¼ˆåŒºåˆ†äº beforeSaveï¼‰
afterInsert    // ä»…æ’å…¥å
beforeUpdate   // ä»…æ›´æ–°å‰ï¼ˆåŒºåˆ†äº beforeSaveï¼‰
afterUpdate    // ä»…æ›´æ–°å
afterDelete    // åˆ é™¤å
afterSave      // ä¿å­˜åï¼ˆæ’å…¥æˆ–æ›´æ–°åï¼‰
beforeRestore  // æ¢å¤å‰ï¼ˆè½¯åˆ é™¤ï¼‰
afterRestore   // æ¢å¤åï¼ˆè½¯åˆ é™¤ï¼‰
```

#### 5.2 å…¨å±€é’©å­
```typescript
// æ³¨å†Œå…¨å±€é’©å­ï¼Œå¯¹æ‰€æœ‰å®ä½“ç”Ÿæ•ˆ
OrmContext.registerGlobalHook('beforeSave', async (entityName, data) => {
  // è‡ªåŠ¨è®¾ç½® updatedBy
  data.setPropertyValue('updatedBy', getCurrentUserId())
})
```

#### 5.3 äº‹ä»¶ç³»ç»Ÿ
```typescript
// å‘å¸ƒ/è®¢é˜…æ¨¡å¼
OrmContext.on('entity:saved', (event) => {
  console.log(`${event.entityName} saved with id ${event.id}`)
})

OrmContext.on('query:slow', (event) => {
  if (event.duration > 1000) {
    logger.warn(`Slow query: ${event.sql}`)
  }
})
```

#### 5.4 è°ƒè¯•æ¨¡å¼å¢å¼º
```typescript
// è·å–å°†è¦æ‰§è¡Œçš„ SQLï¼ˆä¸å®é™…æ‰§è¡Œï¼‰
const sql = repo.createQueryBuilder()
  .where('status', '=', 'active')
  .toSQL()

// æŸ¥è¯¢åˆ†æ
const analysis = await repo.createQueryBuilder()
  .where('status', '=', 'active')
  .explain()
```

- çŠ¶æ€ï¼šâœ… å·²å®Œæˆï¼ˆ2026-02-10ï¼Œ5.1~5.4 å·²åœ¨ OCORM ä¸»ä»£ç è½åœ°ï¼Œå¹¶ç”± DeveloperExperienceSuite è¦†ç›–ï¼‰

---

### å…­ã€æ•°æ®å®Œæ•´æ€§ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

#### 6.1 ç´¢å¼•ç®¡ç†
```typescript
// è‡ªåŠ¨åŒæ­¥ç´¢å¼•åˆ°æ•°æ®åº“
defineEntity({
  name: 'User',
  columns: [
    { name: 'email', type: ColumnType.TEXT },
    { name: 'username', type: ColumnType.TEXT },
    { name: 'status', type: ColumnType.TEXT }
  ],
  indexes: [
    { columns: ['email'], unique: true },
    { columns: ['username'], unique: true },
    { columns: ['status', 'created_at'] }  // å¤åˆç´¢å¼•
  ]
})
```

#### 6.2 å”¯ä¸€çº¦æŸéªŒè¯
```typescript
// ä¿å­˜å‰è‡ªåŠ¨æ£€æŸ¥å”¯ä¸€æ€§ï¼ˆåº”ç”¨å±‚éªŒè¯ï¼Œéæ•°æ®åº“çº¦æŸï¼‰
@Unique()  // è£…é¥°å™¨æ–¹å¼
// æˆ–
{ name: 'email', type: ColumnType.TEXT, unique: true }  // Schema æ–¹å¼
```

- çŠ¶æ€ï¼šâœ… å·²å®Œæˆï¼ˆ2026-02-10ï¼Œ6.1 ç´¢å¼•å…ƒæ•°æ®+è‡ªåŠ¨åŒæ­¥å·²å®ç°ï¼›6.2 å”¯ä¸€çº¦æŸéªŒè¯å·²å®ç°ï¼‰

---

### ä¸ƒã€å·¥å…·å¢å¼ºï¼ˆä½ä¼˜å…ˆçº§ï¼‰

#### 7.1 æ•°æ®å¡«å……å™¨ï¼ˆSeederï¼‰
```typescript
// å®šä¹‰æ•°æ®å¡«å……å™¨
class UserSeeder implements Seeder {
  async run(repo: Repository): Promise<void> {
    await repo.batchInsert([
      { name: 'Admin', email: 'admin@example.com' },
      { name: 'Test', email: 'test@example.com' }
    ])
  }
}

// æ‰§è¡Œå¡«å……
await SeederManager.run([new UserSeeder()])
```

#### 7.2 æ•°æ®å·¥å‚ï¼ˆFactoryï¼‰
```typescript
// å®šä¹‰å·¥å‚
const userFactory = defineFactory('User', (faker) => ({
  name: faker.name(),
  email: faker.email(),
  age: faker.number({ min: 18, max: 65 })
}))

// ä½¿ç”¨
const user = await userFactory.create()
const users = await userFactory.createMany(10)
```

#### 7.3 è¿ç§»ç”Ÿæˆå™¨
```typescript
// æ ¹æ®å®ä½“å®šä¹‰å˜åŒ–è‡ªåŠ¨ç”Ÿæˆè¿ç§»è„šæœ¬
const migration = await MigrationGenerator.generate()
// è¾“å‡º:
// Migration_20240115_AddUserTable.ts
// - CREATE TABLE users (...)
// - ADD COLUMN email TO users
```

- çŠ¶æ€ï¼šâœ… å·²å®Œæˆï¼ˆ2026-02-10ï¼ŒSeeder/Factory/MigrationGenerator å·²å®ç°å¹¶å¯¼å‡ºï¼‰

---

## ğŸ“Š å®ç°ä¼˜å…ˆçº§çŸ©é˜µ

| åŠŸèƒ½ | ç”¨æˆ·ä»·å€¼ | å®ç°å¤æ‚åº¦ | å»ºè®®ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|---------|-----------|-----------|------|
| èšåˆå‡½æ•°(sum/avg/max/min) | â­â­â­â­â­ | â­â­ | P0 | âœ… å·²å®Œæˆ |
| æ›´å¤šéªŒè¯å™¨ | â­â­â­â­â­ | â­â­ | P0 | âœ… å·²å®Œæˆ |
| åˆ†ç»„æŸ¥è¯¢ | â­â­â­â­ | â­â­ | P1 | âœ… å·²å®Œæˆ |
| åŸç”Ÿ SQL | â­â­â­â­ | â­ | P1 | âœ… å·²å®Œæˆ |
| æ‰¹é‡æ›´æ–°/åˆ é™¤ | â­â­â­â­ | â­â­ | P1 | âœ… å·²å®Œæˆ |
| åµŒå¥—é¢„åŠ è½½ | â­â­â­â­ | â­â­â­ | P1 | âœ… å·²å®Œæˆ |
| æŸ¥è¯¢ä½œç”¨åŸŸ | â­â­â­ | â­â­ | P2 | âœ… å·²å®Œæˆ |
| å…³è”æ¡ä»¶è¿‡æ»¤ | â­â­â­ | â­â­â­ | P2 | âœ… å·²å®Œæˆ |
| æ›´å¤šé’©å­ | â­â­â­ | â­â­ | P2 | å¾…å®ç° |
| å…³è”è®¡æ•° | â­â­â­ | â­â­ | P2 | âœ… å·²å®Œæˆ |
| å¤šæ€å…³è”ï¼ˆMorphToï¼‰ | â­â­â­ | â­â­â­ | P2 | âœ… 9.4 å·²å®Œæˆï¼ˆwith/withLazy/withCount/withWhere/åµŒå¥—ï¼‰ |
| åˆ†å—æŸ¥è¯¢ | â­â­â­ | â­â­ | P2 | âœ… å·²å®Œæˆ |
| toSQL/explain | â­â­ | â­ | P3 | å¾…å®ç° |
| æ•°æ®å·¥å‚ | â­â­ | â­â­ | P3 | âœ… å·²å®Œæˆ |

---

## ğŸ”„ ç‰ˆæœ¬è§„åˆ’å»ºè®®

### v1.1.0 - æŸ¥è¯¢å¢å¼ºç‰ˆ
- [x] èšåˆå‡½æ•°ï¼ˆsum/avg/max/minï¼‰ âœ…
- [x] åˆ†ç»„æŸ¥è¯¢ï¼ˆgroupBy/having/selectRawï¼‰ âœ…
- [x] åŸç”Ÿ SQL æŸ¥è¯¢ï¼ˆrawQuery/rawExecuteï¼‰ âœ…
- [x] æŸ¥è¯¢ä½œç”¨åŸŸï¼ˆscope/scopesï¼‰ âœ…
- [x] æ‰¹é‡æ›´æ–°/åˆ é™¤ âœ…

### v1.2.0 - éªŒè¯å¢å¼ºç‰ˆ
- [x] æ–°å¢éªŒè¯è£…é¥°å™¨ï¼ˆ@Min/@Max/@Range/@Pattern ç­‰ï¼‰ âœ…
- [x] æ¡ä»¶éªŒè¯ âœ…
- [x] éªŒè¯åˆ†ç»„ âœ…
- [x] è‡ªå®šä¹‰éªŒè¯å‡½æ•° âœ…

### v1.3.0 - å…³è”å¢å¼ºç‰ˆ
- [x] åµŒå¥—é¢„åŠ è½½ âœ…
- [x] å…³è”æ¡ä»¶è¿‡æ»¤ âœ…
- [x] å…³è”è®¡æ•°ï¼ˆwithCountï¼‰ âœ…
- [ ] æŸ¥è¯¢ä½œç”¨åŸŸ

### v1.4.0 - å¼€å‘ä½“éªŒç‰ˆ
- [ ] æ›´å¤šç”Ÿå‘½å‘¨æœŸé’©å­
- [ ] å…¨å±€é’©å­
- [ ] toSQL/explain è°ƒè¯•
- [x] åˆ†å—æŸ¥è¯¢ âœ…

### v2.0.0 - æ‰©å±•ç‰¹æ€§ç‰ˆ
- [x] å¤šæ€å…³è”ï¼ˆ9.4ï¼šwith/withLazy/withCount/withWhere/åµŒå¥—åŠ è½½/å£°æ˜æ³¨å†Œï¼‰ âœ…
- [ ] äº‹ä»¶ç³»ç»Ÿ
- [x] æ•°æ®å·¥å‚/å¡«å……å™¨ âœ…

---

## ğŸ“ å‘åå…¼å®¹æ€§ä¿è¯

æ‰€æœ‰æ–°åŠŸèƒ½éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **æ–°å¢ API ä¸å½±å“ç°æœ‰ API** - ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯å‡çº§
2. **å¯é€‰å‚æ•°ä½¿ç”¨é»˜è®¤å€¼** - æ–°å‚æ•°å‡æœ‰åˆç†é»˜è®¤å€¼
3. **åºŸå¼ƒè€Œéåˆ é™¤** - æ—§ API æ ‡è®° @deprecated ä½†ä¿ç•™è‡³å°‘ä¸¤ä¸ªå¤§ç‰ˆæœ¬
4. **é…ç½®é©±åŠ¨** - æ–°åŠŸèƒ½å¯é€šè¿‡é…ç½®å¼€å…³æ§åˆ¶

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.3.2*
*æœ€åæ›´æ–°: 2026-02-10*
