# 安装配置

本章节详细介绍如何将 OCORM 集成到你的 HarmonyOS/OpenHarmony 项目中。

## 安装方式

### 方式一：本地文件引用（推荐用于开发调试）

在项目的 `oh-package.json5` 中添加本地路径引用：

```json5
{
  "dependencies": {
    "ocorm": "file:../OCORM"
  }
}
```

### 方式二：发布到 npm 仓库（用于正式发布）

```json5
{
  "dependencies": {
    "ocorm": "^2.1.19"
  }
}
```

## 项目配置

### 1. 配置模块依赖

在你的模块 `module.json5` 中添加 OCORM 模块依赖：

```json5
{
  "module": {
    "dependencies": [
      {
        "bundleName": "com.example.myapp",
        "moduleName": "OCORM",
        "moduleType": "har"
      }
    ]
  }
}
```

### 2. 导入 OCORM

在你需要使用数据库的模块中导入 OCORM：

```typescript
import {
  // 核心
  MetadataStorage,
  ColumnMetadata,
  ColumnType,
  registerEntity,
  registerAutoIncrementPrimaryKey,
  
  // 数据库
  DatabaseManager,
  DatabaseConfig,
  SchemaBuilder,
  
  // 仓储
  Repository,
  EntityData,
  
  // 查询
  ConditionOperator,
  
  // 类型
  RelationType,
  EntityHooks
} from 'ocorm'
```

## 数据库配置

### DatabaseConfig 配置项

```typescript
import { DatabaseConfig } from 'ocorm'
import { relationalStore } from '@kit.ArkData'

const config = new DatabaseConfig(
  'myapp.db',                           // 数据库文件名
  relationalStore.SecurityLevel.S1      // 安全级别
)

// 以下是可选配置
config.encrypt = false                           // 是否加密数据库
config.enableQueryCache = true                   // 是否启用查询缓存
config.queryCacheMaxSize = 200                   // 缓存最大条目数
config.queryCacheTtlMs = 60000                   // 缓存过期时间（毫秒）
config.enableLogger = true                       // 是否启用日志
config.loggerLevel = LogLevel.DEBUG              // 日志级别
config.healthCheckIntervalMs = 30000             // 健康检查间隔
```

### 安全级别说明

```typescript
import { relationalStore } from '@kit.ArkData'

// 可选的安全级别（从低到高）
relationalStore.SecurityLevel.S1  // 最低安全级别
relationalStore.SecurityLevel.S2
relationalStore.SecurityLevel.S3
relationalStore.SecurityLevel.S4  // 最高安全级别
```

> **注意**：安全级别决定了数据库的加密强度和访问权限，应根据应用需求选择合适的级别。

### 加密数据库

```typescript
const config = new DatabaseConfig(
  'encrypted.db',
  relationalStore.SecurityLevel.S3
)

// 启用加密（需要设置密码）
config.encrypt = true
// 如果需要自定义加密密钥，可以通过配置实现
```

## 初始化流程

### 标准初始化

```typescript
import { DatabaseManager, DatabaseConfig, SchemaBuilder } from 'ocorm'
import { relationalStore } from '@kit.ArkData'
import { MetadataStorage } from 'ocorm'

export async function initDatabase(context: Context): Promise<void> {
  // 1. 创建数据库配置
  const config = new DatabaseConfig(
    'myapp.db',
    relationalStore.SecurityLevel.S1
  )
  
  // 启用查询缓存
  config.enableQueryCache = true
  config.queryCacheMaxSize = 200
  
  // 2. 初始化数据库管理器
  await DatabaseManager.getInstance().initialize(context, config)
  
  // 3. 确保所有实体已注册
  // （在此之前应该已经调用了实体注册代码）
  
  // 4. 创建表结构
  const schemaBuilder = new SchemaBuilder()
  await schemaBuilder.createAllTablesWithManager()
  
  console.info('数据库初始化完成')
}
```

### 带迁移的初始化

```typescript
import { DatabaseManager, DatabaseConfig, MigrationManager } from 'ocorm'

export async function initDatabaseWithMigration(
  context: Context,
  currentVersion: number
): Promise<void> {
  const config = new DatabaseConfig(
    'myapp.db',
    relationalStore.SecurityLevel.S1
  )
  
  await DatabaseManager.getInstance().initialize(context, config)
  
  // 执行数据库迁移
  const migrationManager = new MigrationManager()
  await migrationManager.migrateToVersion(currentVersion)
}
```

## 应用入口配置

### 在 EntryAbility 中初始化

```typescript
// EntryAbility.ts
import { Ability, AbilityConstant, Want } from '@kit.abilityKit'
import { initDatabase } from '../database/DBManager'
import { registerAllEntities } from '../entities'

export default class EntryAbility extends Ability {
  onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    // 1. 注册所有实体
    registerAllEntities()
    
    // 2. 初始化数据库
    initDatabase(this.context)
      .then(() => {
        console.info('数据库初始化成功')
      })
      .catch((error: Error) => {
        console.error(`数据库初始化失败: ${error.message}`)
      })
  }
  
  onDestroy(): void {
    // 可选：在应用销毁时关闭数据库连接
    DatabaseManager.getInstance().close()
  }
}
```

## 实体注册管理

### 封装实体注册

为了更好地管理实体注册，建议封装一个统一的注册函数：

```typescript
// entities/index.ts
import { MetadataStorage, ColumnMetadata, ColumnType } from 'ocorm'
import { registerEntity, registerAutoIncrementPrimaryKey, createEntityOptions } from 'ocorm'

// User 实体注册
function registerUserEntity(): void {
  registerEntity('User', createEntityOptions('users'))
  registerAutoIncrementPrimaryKey('User', 'id', 'id')
  
  const storage = MetadataStorage.getInstance()
  
  // name 列
  const nameColumn = new ColumnMetadata('name', 'name')
  nameColumn.columnType = ColumnType.TEXT
  nameColumn.isNullable = false
  storage.registerColumn('User', nameColumn)
  
  // email 列
  const emailColumn = new ColumnMetadata('email', 'email')
  emailColumn.columnType = ColumnType.TEXT
  emailColumn.isUnique = true
  storage.registerColumn('User', emailColumn)
}

// Order 实体注册
function registerOrderEntity(): void {
  registerEntity('Order', createEntityOptions('orders'))
  registerAutoIncrementPrimaryKey('Order', 'id', 'id')
  
  const storage = MetadataStorage.getInstance()
  
  const userIdColumn = new ColumnMetadata('userId', 'user_id')
  userIdColumn.columnType = ColumnType.INTEGER
  userIdColumn.isNullable = false
  storage.registerColumn('Order', userIdColumn)
  
  // ... 其他列注册
}

// 统一注册所有实体
export function registerAllEntities(): void {
  registerUserEntity()
  registerOrderEntity()
  // 添加更多实体注册...
  
  console.info(`已注册 ${MetadataStorage.getInstance().getAllEntities().length} 个实体`)
}
```

## 配置验证

### 检查数据库状态

```typescript
import { DatabaseManager } from 'ocorm'

const dbManager = DatabaseManager.getInstance()

// 检查是否已初始化
if (dbManager.isInitialized()) {
  console.info('数据库已初始化')
  
  // 检查连接健康状态
  if (dbManager.isHealthy()) {
    console.info('数据库连接健康')
  } else {
    console.warn('数据库连接不健康')
  }
  
  // 获取当前配置
  const config = dbManager.getConfig()
  console.info(`当前数据库: ${config?.name}`)
}
```

### 健康检查

数据库管理器内置了健康检查机制：

```typescript
const config = new DatabaseConfig('myapp.db', relationalStore.SecurityLevel.S1)

// 启用健康检查（默认关闭）
config.healthCheckIntervalMs = 30000  // 每 30 秒检查一次

await DatabaseManager.getInstance().initialize(context, config)

// 手动检查健康状态
const isHealthy = await dbManager.ping()
```

## 常见配置问题

### 问题 1：数据库初始化失败

**症状**：`ConnectionError` 或数据库无法打开

**解决方案**：
1. 检查安全级别是否支持
2. 确保应用有足够的存储权限
3. 检查数据库文件名是否合法

```typescript
// 检查权限
const config = new DatabaseConfig('myapp.db', relationalStore.SecurityLevel.S1)

try {
  await DatabaseManager.getInstance().initialize(context, config)
} catch (error) {
  console.error(`初始化失败: ${error.message}`)
  // 检查是否需要申请存储权限
}
```

### 问题 2：查询缓存不生效

**症状**：重复查询没有命中缓存

**解决方案**：
1. 确保启用了查询缓存
2. 检查缓存大小限制
3. 确认没有调用 `invalidate` 方法

```typescript
const config = new DatabaseConfig('myapp.db', relationalStore.SecurityLevel.S1)

// 启用查询缓存
config.enableQueryCache = true
config.queryCacheMaxSize = 200
config.queryCacheTtlMs = 60000  // 1 分钟过期
```

### 问题 3：日志输出过多

**症状**：控制台输出大量 SQL 日志

**解决方案**：调整日志级别

```typescript
import { LogLevel } from 'ocorm'

const config = new DatabaseConfig('myapp.db', relationalStore.SecurityLevel.S1)
config.enableLogger = true
config.loggerLevel = LogLevel.WARN  // 只输出警告及以上级别
```

## 下一步

- [实体定义](03-实体定义.md) - 学习如何定义数据实体
- [数据库迁移](10-数据库迁移.md) - 了解数据库版本管理
- [日志系统](11-日志系统.md) - 配置和使用日志功能




