# 类型定义速查

本文档提供 OCORM 所有枚举类型和接口定义的快速参考。

---

## ColumnType - 列类型

数据库列类型枚举，定义 SQLite 支持的基本数据类型。

```typescript
enum ColumnType {
  TEXT = 'TEXT',       // 文本类型，对应 SQLite TEXT
  INTEGER = 'INTEGER', // 整数类型，对应 SQLite INTEGER
  REAL = 'REAL',       // 浮点数类型，对应 SQLite REAL
  BLOB = 'BLOB'        // 二进制类型，对应 SQLite BLOB
}
```

### ArkTS 类型映射

| ArkTS 类型 | 推荐 ColumnType | 说明 |
|------------|-----------------|------|
| `string` | `TEXT` | 字符串 |
| `number` (整数) | `INTEGER` | 整数值 |
| `number` (小数) | `REAL` | 浮点数 |
| `boolean` | `INTEGER` | 0 或 1 |
| `Date` | `INTEGER` | 时间戳（毫秒） |
| `Uint8Array` | `BLOB` | 二进制数据 |

---

## ConditionOperator - 条件操作符

查询条件操作符枚举，定义 QueryBuilder 支持的所有条件操作符。

```typescript
enum ConditionOperator {
  EQUAL = '=',              // 等于
  NOT_EQUAL = '!=',         // 不等于
  GREATER = '>',            // 大于
  LESS = '<',               // 小于
  GREATER_EQUAL = '>=',     // 大于等于
  LESS_EQUAL = '<=',        // 小于等于
  LIKE = 'LIKE',            // 模糊匹配
  IN = 'IN',                // 在集合中
  NOT_IN = 'NOT IN',        // 不在集合中
  BETWEEN = 'BETWEEN',      // 在范围内
  IS_NULL = 'IS NULL',      // 为空
  IS_NOT_NULL = 'IS NOT NULL' // 不为空
}
```

### 使用示例

```typescript
import { ConditionOperator } from '@aspect/ocorm'

// 等于
qb.where('status', ConditionOperator.EQUAL, 'active')

// 大于
qb.where('age', ConditionOperator.GREATER, 18)

// 模糊匹配
qb.where('name', ConditionOperator.LIKE, '%张%')

// 范围查询
qb.where('price', ConditionOperator.BETWEEN, 100)
```

---

## RelationType - 关系类型

实体间关联关系类型枚举。

```typescript
enum RelationType {
  ONE_TO_ONE = 'ONE_TO_ONE',     // 一对一关系
  ONE_TO_MANY = 'ONE_TO_MANY',   // 一对多关系
  MANY_TO_ONE = 'MANY_TO_ONE',   // 多对一关系
  MANY_TO_MANY = 'MANY_TO_MANY'  // 多对多关系
}
```

### 关系说明

| 类型 | 说明 | 示例 |
|------|------|------|
| `ONE_TO_ONE` | 一对一，双方都只能有一个关联 | 用户 ↔ 用户资料 |
| `ONE_TO_MANY` | 一对多，一方有多个关联 | 用户 → 文章列表 |
| `MANY_TO_ONE` | 多对一，多方关联到一方 | 文章 → 用户 |
| `MANY_TO_MANY` | 多对多，双方都可有多个关联 | 文章 ↔ 标签 |

---

## LogLevel - 日志级别

SQL 日志系统的日志级别枚举。

```typescript
enum LogLevel {
  ERROR = 0,  // 错误级别 - 仅记录错误日志
  INFO = 1,   // 信息级别 - 记录错误和基本操作日志（事务）
  DEBUG = 2   // 调试级别 - 记录所有日志包括详细 SQL
}
```

### 级别说明

| 级别 | 记录内容 | 适用场景 |
|------|----------|----------|
| `ERROR` | 仅错误信息 | 生产环境 |
| `INFO` | 错误 + 事务日志 | 常规运行 |
| `DEBUG` | 所有日志（含 SQL） | 开发调试 |

---

## IsolationLevel - 事务隔离级别

SQLite 支持的事务隔离级别。

```typescript
enum IsolationLevel {
  READ_UNCOMMITTED = 'READ_UNCOMMITTED', // 读未提交
  READ_COMMITTED = 'READ_COMMITTED',     // 读已提交（默认）
  REPEATABLE_READ = 'REPEATABLE_READ',   // 可重复读
  SERIALIZABLE = 'SERIALIZABLE'          // 串行化
}
```

### 隔离级别对比

| 级别 | 脏读 | 不可重复读 | 幻读 | 说明 |
|------|------|------------|------|------|
| `READ_UNCOMMITTED` | ✓ | ✓ | ✓ | 最低隔离，可能读取未提交数据 |
| `READ_COMMITTED` | ✗ | ✓ | ✓ | SQLite 默认级别 |
| `REPEATABLE_READ` | ✗ | ✗ | ✓ | 同事务内读取一致 |
| `SERIALIZABLE` | ✗ | ✗ | ✗ | 最高隔离，完全串行 |

---

## ValueType - 值类型

ORM 框架中使用的基础值类型。

```typescript
// ArkTS 值类型，可存储在实体属性中
type ValueType = string | number | boolean | null

// 数据库值类型，可存储在数据库中
type DbValueType = string | number | Uint8Array | null

// 排序方向
type SortDirection = 'ASC' | 'DESC'
```

---

## 结果类型

### SaveResult - 保存结果

```typescript
class SaveResult {
  success: boolean      // 是否成功
  affectedRows: number  // 影响行数
  insertId: number      // 插入的自增 ID（仅 INSERT）
  errorMessage: string  // 错误信息

  // 静态工厂方法
  static createSuccess(affectedRows: number, insertId?: number): SaveResult
  static createFailure(errorMessage: string): SaveResult
}
```

### DeleteResult - 删除结果

```typescript
class DeleteResult {
  success: boolean      // 是否成功
  affectedRows: number  // 影响行数
  errorMessage: string  // 错误信息

  // 静态工厂方法
  static createSuccess(affectedRows: number): DeleteResult
  static createFailure(errorMessage: string): DeleteResult
}
```

### TransactionResult - 事务结果

```typescript
class TransactionResult {
  success: boolean      // 是否成功
  errorMessage: string  // 错误信息

  // 静态工厂方法
  static createSuccess(): TransactionResult
  static createFailure(errorMessage: string): TransactionResult
}
```

### BatchInsertResult - 批量插入结果

```typescript
class BatchInsertResult {
  success: boolean           // 是否全部成功
  insertedCount: number      // 成功插入数量
  totalCount: number         // 总数量
  failedIndexes: number[]    // 失败的索引
  errorMessage: string       // 错误信息

  // 静态工厂方法
  static createSuccess(insertedCount: number, totalCount: number): BatchInsertResult
  static createFailure(errorMessage: string, failedIndexes?: number[]): BatchInsertResult
  static createPartialSuccess(insertedCount: number, totalCount: number, 
    failedIndexes: number[], errorMessage: string): BatchInsertResult
}
```

### PaginatedResult - 分页结果

```typescript
class PaginatedResult {
  data: Array<EntityData>  // 当前页数据
  total: number            // 总记录数
  page: number             // 当前页码（从 1 开始）
  pageSize: number         // 每页数量
  totalPages: number       // 总页数

  // 实例方法
  hasNextPage(): boolean      // 是否有下一页
  hasPreviousPage(): boolean  // 是否有上一页
  isFirstPage(): boolean      // 是否第一页
  isLastPage(): boolean       // 是否最后一页
  getCurrentPageSize(): number // 当前页数据量
  isEmpty(): boolean          // 是否为空

  // 静态工厂方法
  static create(data: Array<EntityData>, total: number, page: number, pageSize: number): PaginatedResult
  static createEmpty(page?: number, pageSize?: number): PaginatedResult
}
```

### CacheStatistics - 缓存统计

```typescript
interface CacheStatistics {
  hits: number      // 缓存命中次数
  misses: number    // 缓存未命中次数
  size: number      // 当前缓存条目数
  hitRate: number   // 命中率（0-1）
}
```

---

## 配置类型

### QueryCacheConfig - 缓存配置

```typescript
interface QueryCacheConfig {
  maxSize?: number   // 最大缓存条目数，默认 100
  ttlMs?: number     // 缓存生存时间（毫秒），默认 60000
  enabled?: boolean  // 是否启用缓存，默认 true
}
```

### TransactionOptions - 事务选项

```typescript
class TransactionOptions {
  isolation: IsolationLevel  // 隔离级别，默认 READ_COMMITTED
  timeout: number            // 超时时间（毫秒），默认 30000
  retries: number            // 失败重试次数，默认 0
  retryDelay: number         // 重试延迟（毫秒），默认 100
  readOnly: boolean          // 是否只读事务，默认 false

  // 静态工厂方法
  static createDefault(): TransactionOptions
  static fromConfig(config: TransactionOptionsConfig): TransactionOptions
  static readOnly(): TransactionOptions
  static withRetry(retries: number, retryDelay?: number): TransactionOptions
  static withTimeout(timeout: number): TransactionOptions
  static serializable(): TransactionOptions
}
```

### BatchInsertOptions - 批量插入选项

```typescript
class BatchInsertOptions {
  useTransaction: boolean     // 是否在事务中执行，默认 true
  executeHooks: boolean       // 是否执行 beforeSave 钩子，默认 true
  executeValidation: boolean  // 是否执行数据验证，默认 true

  // 静态工厂方法
  static create(useTransaction?: boolean, executeHooks?: boolean, 
    executeValidation?: boolean): BatchInsertOptions
  static createDefault(): BatchInsertOptions  // 使用事务，执行钩子和验证
  static createFast(): BatchInsertOptions     // 不使用事务，不执行钩子和验证
  static createSafe(): BatchInsertOptions     // 使用事务，执行钩子和验证
}
```

---

## 钩子类型

### EntityHooks - 实体钩子

```typescript
// 钩子回调函数类型
type HookCallback = (data: EntityData) => void | Promise<void>

// 实体钩子类
class EntityHooks {
  beforeSave: HookCallback | null   // 保存前钩子
  afterLoad: HookCallback | null    // 加载后钩子
  beforeDelete: HookCallback | null // 删除前钩子
}
```

---

## 映射类型

### PropertyMapper - 属性映射器

```typescript
// 从 EntityData 提取值并设置到 ViewModel
type PropertyMapper<T> = (entityData: EntityData, viewModel: T) => void

// 从 ViewModel 提取值
type ReversePropertyMapper<T> = (viewModel: T, propertyName: string) => ValueType

// ViewModel 工厂函数
type ViewModelFactory<T> = () => T
```

---

## 错误码常量

### 元数据错误 (ORM001-ORM099)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| `ORM001` | `ERROR_ENTITY_NOT_REGISTERED` | 实体未注册 |
| `ORM002` | `ERROR_DUPLICATE_ENTITY` | 重复实体定义 |
| `ORM003` | `ERROR_INVALID_COLUMN_TYPE` | 无效列类型 |
| `ORM004` | `ERROR_COLUMN_NOT_FOUND` | 列未找到 |
| `ORM005` | `ERROR_PRIMARY_KEY_NOT_DEFINED` | 未定义主键 |

### 查询错误 (ORM101-ORM199)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| `ORM101` | `ERROR_INVALID_CONDITION` | 无效条件 |
| `ORM102` | `ERROR_PREDICATE_BUILD_FAILED` | 谓词构建失败 |
| `ORM103` | `ERROR_INVALID_OPERATOR` | 无效操作符 |
| `ORM104` | `ERROR_SUB_QUERY` | 子查询错误 |

### 映射错误 (ORM201-ORM299)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| `ORM201` | `ERROR_TYPE_CONVERSION_FAILED` | 类型转换失败 |
| `ORM202` | `ERROR_NULL_VALUE_NOT_ALLOWED` | 不允许空值 |
| `ORM203` | `ERROR_MAPPING_FAILED` | 映射失败 |
| `ORM204` | `ERROR_TYPE_MISMATCH` | 类型不匹配 |

### 事务错误 (ORM301-ORM399)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| `ORM301` | `ERROR_TRANSACTION_NOT_STARTED` | 事务未开始 |
| `ORM302` | `ERROR_TRANSACTION_ROLLBACK` | 事务回滚 |
| `ORM303` | `ERROR_TRANSACTION_COMMIT_FAILED` | 事务提交失败 |

### 数据库错误 (ORM401-ORM499)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| `ORM401` | `ERROR_DATABASE_CONNECTION_FAILED` | 数据库连接失败 |
| `ORM402` | `ERROR_SQL_EXECUTION_FAILED` | SQL 执行失败 |
| `ORM403` | `ERROR_DATABASE_NOT_INITIALIZED` | 数据库未初始化 |

### 关联关系错误 (ORM501-ORM599)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| `ORM501` | `ERROR_RELATION_NOT_FOUND` | 关联关系未找到 |
| `ORM502` | `ERROR_INVALID_RELATION_TYPE` | 无效关联类型 |
| `ORM503` | `ERROR_INVALID_FOREIGN_KEY_SIDE` | 无效外键方向 |
| `ORM504` | `ERROR_JOIN_TABLE_NOT_FOUND` | 中间表未找到 |

### 钩子错误 (ORM601-ORM699)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| `ORM601` | `ERROR_HOOK_EXECUTION_FAILED` | 钩子执行失败 |

### 软删除错误 (ORM701-ORM799)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| `ORM701` | `ERROR_SOFT_DELETE_NOT_ENABLED` | 软删除未启用 |

### 验证错误 (ORM801-ORM899)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| `ORM801` | `ERROR_VALIDATION_FAILED` | 验证失败 |
| `ORM802` | `ERROR_VALIDATION_REQUIRED` | 必填验证失败 |
| `ORM803` | `ERROR_VALIDATION_LENGTH` | 长度验证失败 |
| `ORM804` | `ERROR_VALIDATION_EMAIL` | 邮箱验证失败 |
