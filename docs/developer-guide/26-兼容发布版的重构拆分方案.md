# 兼容发布版的重构拆分方案

本文档用于指导 OCORM 在已发布前提下进行内部重构，目标是拆分超大文件并降低耦合，同时不破坏现有外部调用方式。

## 1. 目标与范围

### 1.1 目标

- 拆分以下高复杂度文件，降低单文件职责数量与维护成本：
  - `query/QueryExecutor.ets`
  - `repository/Repository.ets`
  - `query/RelationLoader.ets`
  - `schema/MigrationManager.ets`
  - `mapping/DataMapper.ets`
- 保持已发布 API 兼容：
  - 类名不变
  - 方法签名不变
  - 默认行为不变
  - 错误类型不变
  - 现有导入路径可继续使用

### 1.2 非目标

- 当前阶段不做功能扩展
- 当前阶段不调整用户调用范式
- 当前阶段不要求变更测试组织（后续可补）

## 2. 兼容性红线

以下内容禁止破坏：

- 对外导出的 symbol 名称
- `index.ets` 中的导出结构
- 包入口导入可用性（`import { ... } from 'ocorm'`）
- 模块 `index.ets` 聚合导入可用性（用于库内分层导出）
- 既有运行时异常类型与关键错误文案语义

## 3. 总体设计原则

### 3.1 外观保持，内部迁移

- 保留原文件与原导出类作为 Facade（门面）
- 将复杂逻辑迁移到新组件
- 原类只负责参数校验、流程编排、结果聚合

### 3.2 委托优先

- 通过组合（composition）替代超大类内联实现
- 共享逻辑提取到可复用 helper/service，避免复制粘贴

### 3.3 渐进式拆分

- 每次仅拆一个主模块
- 每个阶段都可单独发布
- 任一阶段可回滚到上一个稳定点

## 4. 模块拆分蓝图

### 4.1 QueryExecutor 拆分

保持 `QueryExecutor` 对外 API 不变，内部委托：

- `QueryResultTransformer`：`getAsync`、TaskPool 转换、主线程转换
- `SubQueryExecutor`：子查询执行与 ID 过滤
- `AggregateExecutor`：`sum/avg/max/min/aggregate`
- `SqlClauseBuilder`（内部 helper）：`buildWhereClause`、`escapeIdentifier`

### 4.2 Repository 拆分

保持 `Repository` 为统一入口，内部委托：

- `CrudOperations`：`save/insert/update/find/remove`
- `TransactionManager`：`transaction*`、重试、超时、隔离级别
- `BatchOperations`：`saveAll/batchInsert`
- `RelationManager`：`attach/detach/sync`

结果对象独立文件化：

- `SaveResult.ets`
- `DeleteResult.ets`
- `TransactionResult.ets`

结果类型统一通过 `repository/index.ets` 对外导出，`Repository.ets` 不再回导出结果类型。

### 4.3 RelationLoader 拆分

保持 `RelationLoader.loadRelation/loadRelationsParallel` 不变，内部策略化：

- `RelationLoadStrategy`（统一策略接口）
- `OneToManyRelationLoadStrategy`
- `ManyToOneRelationLoadStrategy`
- `OneToOneRelationLoadStrategy`
- `ManyToManyRelationLoadStrategy`
- 批量查询公共逻辑通过内部 helper 收敛（`splitIntoBatches` 等）

### 4.4 MigrationManager 拆分

保持 `MigrationManager` API 不变，内部拆分：

- `MigrationRegistry`：注册、排序、版本选择
- `MigrationRunner`：`migrateTo/migrateToLatest`
- `AutoMigrationHandler`：`autoMigrate*`
- `MigrationLogService`：日志写入与安全包装

### 4.5 DataMapper 拆分

保留 `mapping/DataMapper.ets` 作为兼容出口，数据结构拆到独立文件：

- `EntityData.ets`
- `RelatedDataValue.ets`
- `EntityPropertyValue.ets`
- `ResultSetRow.ets`
- `ValuesBucket.ets`
- `DataMapperCore.ets`（可选）

## 5. 目录与导出策略

### 5.1 文件策略

- 原路径文件保留，不直接删除
- 新增 `internal` 或同级 `services` 目录承载实现

### 5.2 导出策略

- 原文件继续 `export` 旧 symbol
- `index.ets` 对外导出列表保持稳定
- 如新增内部类，默认不放入公共导出

### 5.3 官方文档依据（2026-02-09）

- HAR/HSP 官方文档均明确：对外导出应在入口文件声明，入口由 `oh-package.json5` 的 `main` 字段指定（默认 `Index.ets`）
- 使用方推荐通过包名导入（示例：`import { ... } from 'library'`），而非依赖深路径
- 本项目导出边界据此收口为：
  - 对外 ABI：`OCORM/Index.ets`（包名 `ocorm`）
  - 模块级聚合：各子模块 `index.ets`
  - 内部实现文件（如 `repository/TransactionManager.ets`、`repository/BatchOperations.ets`）不进入公共导出

参考链接：
- HAR（中文）：https://raw.githubusercontent.com/openharmony/docs/master/zh-cn/application-dev/quick-start/har-package.md
- HAR（英文）：https://raw.githubusercontent.com/openharmony/docs/master/en/application-dev/quick-start/har-package.md
- HSP（中文）：https://raw.githubusercontent.com/openharmony/docs/master/zh-cn/application-dev/quick-start/in-app-hsp.md
- HSP（英文）：https://raw.githubusercontent.com/openharmony/docs/master/en/application-dev/quick-start/in-app-hsp.md

## 6. 分阶段实施计划

### Phase 1（低风险）

- 拆 `DataMapper` 数据结构文件
- 保持 `DataMapper.ets` 导出兼容层

### Phase 2（中风险）

- 拆 `QueryExecutor` 为三执行器 + SQL helper
- `QueryExecutor` 保留原方法签名

Phase 2 当前进度（第六轮收敛）：

- 已新增并接入 `SubQueryRelationExecutor`，负责 `executeOneSubQuery` 与三种关系分支执行
- `QueryExecutor` 中旧的关系子查询实现已删除（避免双实现并存）
- `QueryExecutor` 子查询入口改为：`SubQueryExecutor -> SubQueryRelationExecutor`
- `QueryExecutor` 中子查询条件应用仅保留 `applySubQueryFilter`
- 已提取统一的 `SubQueryExecutionContext`，收敛 `get/count/getPaginated/getAsync` 的子查询预处理与回滚逻辑
- 已提取 `prepareSubQueries()` 与 `finalizeSubQueryContext()`，消除四处重复的 `hasSubQueries + limit/offset/condition restore` 代码
- 已提取 `buildPredicatesOrThrow()`，统一 `PredicateBuilder` 错误处理
- 已提取 `queryResultSet()`，统一按列查询入口
- 已提取 `queryEntities()`，收敛同步查询路径的 `ResultSet -> EntityData` 映射
- 已提取 `applyRelationProcessing()`，收敛查询后的关联加载与懒加载挂载流程
- 已提取 `runWithClearedLimitOffset()` 和 `runWithTemporaryLimit()`，统一临时 limit/offset 控制流
- 已提取 `countIdsFromResultSet()`，收敛 `countWithInMemoryFilter` 的 ResultSet 计数遍历逻辑
- 已移除 `get/count/getPaginated/getAsync` 中冗余的 `querySlotAcquired` 标志位样板

当前规模（约）：

- `query/QueryExecutor.ets`：`1530+` 行降至 `1153` 行
- `query/SubQueryRelationExecutor.ets`：`492` 行（独立承载关系子查询逻辑）

### Phase 3（中风险，已完成）

- 目标：拆 `RelationLoader` 策略类与批量查询公共能力，保持对外 API 不变
- 已新增 `RelationLoadStrategy` 与四个关系策略实现文件：
  - `OneToOneRelationLoadStrategy.ets`
  - `OneToManyRelationLoadStrategy.ets`
  - `ManyToOneRelationLoadStrategy.ets`
  - `ManyToManyRelationLoadStrategy.ets`
- `RelationLoader` 已完成策略注册与分发：
  - `loadRelation` 改为基于 `RelationType` 的策略调用
  - `loadRelationWithResult` 改为统一策略调用并保留结果统计行为
- 批量查询公共能力已统一在 `RelationLoader` 内部 helper（`splitIntoBatches`、`resolveInClauseLimit`、`toRdbValue`、`resultSetToRow`）
- 兼容性策略：保留原私有加载方法（`loadOneToMany/loadManyToOne/loadOneToOne/loadManyToMany`）作为行为承载，确保默认行为不变、可回滚

当前规模（约）：

- `query/RelationLoader.ets`：`1273` 行
- `query/RelationLoadStrategy.ets`：`12` 行
- 四个关系策略文件：`22/22/22/23` 行

### Phase 4（高风险）

- 拆 `Repository` 为 operations/managers
- 结果类型迁移到独立文件并统一由 `repository/index.ets` 导出

Phase 4 当前进度（第 6 步，2026-02-09）：

- 已新增并迁移结果类型文件：
  - `repository/SaveResult.ets`
  - `repository/DeleteResult.ets`
  - `repository/TransactionResult.ets`
- `repository/index.ets` 统一导出 `SaveResult/DeleteResult/TransactionResult`
- `Repository.ets` 已移除结果类型回导出，避免非 index 出口扩散
- `OCORM/src/test` 中仓库相关用例导入已统一为 `../../main/ets/repository/index`
- `SaveInsertUpdate.test.ets` 中原私有 `insert` 调用已替换为公开 `save()` 调用
- 已新增 `repository/RelationManager.ets`，承接多对多关联管理职责
- `Repository.attach/detach/sync` 已改为委托 `RelationManager`，对外方法签名保持不变
- 已新增 `repository/TransactionManager.ets`，承接 `transaction/transactionWithOptions` 事务编排职责
- `Repository` 中旧事务私有实现（`executeTransactionWithOptions/applyIsolationLevel/setReadOnlyMode/resetTransactionOptions/delay`）已删除，事务能力完全收口到 `TransactionManager`
- 已新增 `repository/BatchOperations.ets`，承接 `saveAll/batchInsert` 批量操作职责
- `Repository.saveAll/batchInsert` 已改为委托 `BatchOperations`，公开签名保持不变
- 已新增 `repository/CrudOperations.ets`，承接 `save/insert/update` 主流程职责
- `Repository.save` 已改为委托 `CrudOperations`，并移除 `Repository` 内部旧 `insert/update` 实现
- 已新增 `repository/DeleteOperations.ets`，承接 `remove/removeById/softDelete/hardDelete/forceRemove/forceRemoveById/restore`
- `Repository.remove/removeById/forceRemove/forceRemoveById/restore` 已改为委托 `DeleteOperations`
- 当前规模（约）：`repository/Repository.ets` 从 `1731` 行降至 `810` 行

### Phase 5（中风险）

- 拆 `MigrationManager` 自动迁移与日志职责

Phase 5 当前进度（第 1 步，2026-02-09）：

- 已新增 `schema/MigrationRegistry.ets`，承接迁移注册、排序与版本筛选
- 已新增 `schema/MigrationLogService.ets`，承接迁移日志安全写入与批量写入
- 已新增 `schema/MigrationVersionStore.ets`，承接版本表读写与版本状态同步
- 已新增 `schema/MigrationRunner.ets` + `schema/MigrationStepExecutor.ets`，承接 `migrateTo/migrateToLatest` 事务迁移执行
- 已新增 `schema/AutoMigrationHandler.ets`，承接 `autoMigrate*` 逻辑
- 已新增 `schema/MigrationManagerTypes.ets`，沉淀执行结果与选项类型定义
- `MigrationManager.ets` 已收敛为 Facade，公开 API 保持不变并改为委托上述组件
- 当前规模（约）：`schema/MigrationManager.ets` 从 `793` 行降至 `149` 行

### 6.1 Phase 3 同步 + 验证（2026-02-09）

- 构建结果同步：
  - `.hvigor/outputs/build-logs/build.log` 中 `2026-02-09T12:52:03.986` 记录 `BUILD SUCCESSFUL`
  - 构建链路包含 `OCORM`（HAR）与 `entry`（HAP）增量任务
- 兼容性静态核对：
  - `query/RelationLoader.ets` 仍导出 `RelationLoader` 类，且公开方法 `loadRelation/loadRelationsParallel` 保持
  - 深路径文件保持可用：`mapping/DataMapper.ets`、`repository/Repository.ets`、`query/RelationLoader.ets`
  - `query/index.ets` 继续导出 `RelationLoader`，未新增策略内部类公共导出
  - 根导出 `OCORM/Index.ets` 继续包含 `RelationLoader`
- 环境说明：
  - 当前终端环境未配置 `hvigor` / `ohpm` 可执行命令，本轮未重新触发命令行构建
  - 验证依据为仓库内最新增量构建日志与静态导出核对
- 收口结论：
  - Phase 3 的“代码拆分 + 同步 + 验证”已完成，可进入 Phase 4

### 6.2 Phase 4 同步 + 验证（2026-02-09）

- 官方规范对齐：
  - 已补充 HAR/HSP 官方导出规范依据（见 `5.3 官方文档依据`）
  - 对外导出边界明确为包入口 `OCORM/Index.ets`，模块内通过各自 `index.ets` 聚合
- Repository 静态核对：
  - `transaction/transactionWithOptions` 已委托 `TransactionManager`
  - `saveAll/batchInsert` 已委托 `BatchOperations`
  - `Repository.ets` 中已无旧事务私有实现（`executeTransactionWithOptions/applyIsolationLevel/setReadOnlyMode/resetTransactionOptions/delay`）
  - 结果类型仅由 `repository/index.ets` 导出，`Repository.ets` 已无回导出
  - `OCORM/src/test` 仓库用例已切换到 `repository/index` 导入路径
- ArkTS 编译约束核对：
  - `OCORM/src/main/ets` 范围内未检出 `constructor(private/public/readonly ...)` 写法
- 环境说明：
  - 当前终端环境未发现可直接执行的 `hvigor` 命令入口，本轮未执行命令行构建
  - 验证依据为静态导出与实现收口核对

### 6.3 Phase 5 同步 + 验证（2026-02-09）

- 兼容性静态核对：
  - `schema/MigrationManager.ets` 继续导出 `MigrationManager`，公开方法签名保持
  - `schema/index.ets` 导出列表保持稳定（`MigrationManager` 与相关结果/选项类型不变）
  - `AutoMigrationMode/AutoMigrationOptions/SchemaMigrationExecutionResult` 仍可从 `schema/MigrationManager` 导入
- ArkTS 编译约束核对：
  - `OCORM/src/main/ets/schema` 新增文件未使用 `constructor(private/public/readonly ...)` 写法
- 环境说明：
  - 本轮按你的要求未执行构建与测试
  - 验证依据为静态 API 与导出面核对

## 7. 发布与回滚策略

- 每个 Phase 独立发版（建议次版本号）
- 变更说明统一标注：`Internal Refactor, No API Breaking Change`
- 若线上异常，按 Phase 粒度快速回滚

## 8. 完成判定（DoD）

- 既有导入路径可编译通过
- 既有公开 API 行为与重构前一致
- 主模块文件长度与方法数显著下降
- 新增模块职责清晰、依赖方向单向
