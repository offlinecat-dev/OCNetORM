# 27-安全审查与加固建议

审查时间：2026-02-21  
审查对象：`OCORM/src/main/ets`（Repository / Query / Transaction / Schema / Logging / Context）

---

## 结论摘要

- 本轮以静态代码审查为主，未发现可直接利用的高危漏洞
- 已完成中风险 3 项、低风险 2 项修复闭环（共 5 项）
- 本文档保留“问题 -> 修复”追踪信息，便于后续回归审计

---

## 风险清单（按严重级别）

### 中风险 1：`HAVING` 片段校验不够严格

- 修复状态：已修复（2026-02-21）
- 风险描述：`having()` 允许的字符集较宽，随后被直接拼接到 SQL，存在被拼接复杂语义的空间
- 证据位置：
  - `OCORM/src/main/ets/query/QueryBuilder.ets:460`
  - `OCORM/src/main/ets/query/QueryBuilder.ets:466`
  - `OCORM/src/main/ets/query/QueryBuilder.ets:501`
  - `OCORM/src/main/ets/query/AggregateExecutor.ets:77`
  - `OCORM/src/main/ets/query/AggregateExecutor.ets:88`
- 影响：如果业务层将外部输入传入 `having()`，可能导致查询语义被篡改（越权读取、条件绕过、异常探测）
- 加固建议：
  - 对 `HAVING` 实施关键字白名单或表达式 AST 解析
  - 明确禁止 `UNION`、子查询入口等高风险结构
  - 继续强制占位符参数化，不允许内联值

### 中风险 2：`orderBy` 方向缺少运行时兜底校验

- 修复状态：已修复（2026-02-21）
- 风险描述：`direction` 主要靠类型约束，运行时未做 `ASC/DESC` 强校验
- 证据位置：
  - `OCORM/src/main/ets/query/QueryBuilder.ets:353`
  - `OCORM/src/main/ets/query/QueryBuilder.ets:358`
  - `OCORM/src/main/ets/query/AggregateExecutor.ets:83`
  - `OCORM/src/main/ets/query/QueryExecutor.ets:1340`
- 影响：类型被绕过（如动态入参、`as` 强转）时，可能把恶意片段拼接到 `ORDER BY`
- 加固建议：
  - 在 `orderBy()` 中增加运行时校验：仅允许 `'ASC' | 'DESC'`
  - 在 SQL 拼接点二次归一化方向值（非法值直接抛错）

### 中风险 3：事务选项基于连接级 `PRAGMA`，存在并发串扰

- 修复状态：已修复（2026-02-21）
- 风险描述：`read_only` 和 `read_uncommitted` 使用同一连接上的 `PRAGMA` 切换，数据库管理器为单例连接
- 证据位置：
  - `OCORM/src/main/ets/repository/TransactionManager.ets:199`
  - `OCORM/src/main/ets/repository/TransactionManager.ets:209`
  - `OCORM/src/main/ets/repository/TransactionManager.ets:143`
  - `OCORM/src/main/ets/repository/TransactionManager.ets:224`
  - `OCORM/src/main/ets/database/DatabaseManager.ets:34`
- 影响：并发事务之间可能互相影响隔离/只读语义，出现“只读失效”或“误拒绝写入”
- 加固建议：
  - 对 `transactionWithOptions` 增加串行互斥
  - 或引入连接池/独立连接，将事务选项限定在会话级

### 低风险 1：默认加密关闭，容易被误用

- 修复状态：已修复（2026-02-21）
- 风险描述：`DatabaseConfig` 默认 `encrypt = false`
- 证据位置：
  - `OCORM/src/main/ets/database/DatabaseConfig.ets:19`
- 影响：业务方未显式开启时，数据落盘保护不足
- 加固建议：
  - 生产配置默认开启加密，或要求初始化时显式声明加密策略

### 低风险 2：慢查询事件透传原始 SQL

- 修复状态：已修复（2026-02-21）
- 风险描述：慢查询事件携带 `event.sql = sql`，若监听器直接上报可能外泄
- 证据位置：
  - `OCORM/src/main/ets/core/OrmContext.ets:228`
  - `OCORM/src/main/ets/repository/Repository.ets:830`
  - `OCORM/src/main/ets/repository/Repository.ets:872`
- 影响：跨系统日志链路中暴露原始 SQL（包括敏感查询结构）
- 加固建议：
  - 事件层改为脱敏 SQL 或 SQL 摘要（hash + 模板）

---

## 测试覆盖补齐

- 已补齐 `orderBy` 非法方向输入的安全测试
  - 参考：`entry/src/test/EntryOrmSecurityFix.test.ets`
- 已补齐事务选项并发串扰（串行化互斥）相关回归测试
  - 参考：`entry/src/test/EntryOrmSecurityFix.test.ets`
  - 参考：`OCORM/src/test/Stage7Repository/RepositoryTransaction.test.ets`

---

## 测试统计口径说明

- 本次安全修复新增了 `entry/src/test/EntryOrmSecurityFix.test.ets`（7 条 Hypium 用例）
- `entry/src/test` 属于单元测试入口（`entry/src/test/List.test.ets`）的统计口径
- `entry/src/main/ets/suites` 属于应用内自定义套件口径（Dashboard 展示）
- 两套口径独立，新增 `src/test` 用例后，Dashboard 总数不变是正常现象

---

## 修复完成情况

1. 中风险 1（`HAVING` 约束）已完成
2. 中风险 2（`orderBy` 运行时白名单）已完成
3. 中风险 3（事务连接级 `PRAGMA` 并发隔离）已完成
4. 低风险 1（默认加密）已完成
5. 低风险 2（慢查询 SQL 脱敏）已完成
