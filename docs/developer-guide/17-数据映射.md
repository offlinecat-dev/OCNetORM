# 数据映射

OCORM 提供完整的数据映射层，负责实体对象与数据库记录之间的双向转换，支持类型安全转换和响应式数据绑定。

---

## EntityData - 实体数据类

`EntityData` 是 OCORM 的核心数据承载类，使用 `@ObservedV2` 装饰器支持 HarmonyOS 5.0+ 状态管理 V2 响应式。

### 创建实体数据

```typescript
import { EntityData } from '@offlinecat/ocorm'

// 方式一：手动创建
const user = new EntityData('User')
user.addProperty('id', 1, 'number')
user.addProperty('name', '张三', 'string')
user.addProperty('email', 'zhangsan@example.com', 'string')
user.addProperty('age', 25, 'number')
user.addProperty('isActive', true, 'boolean')

// 方式二：使用 EntityDataInput 快速构建
import { EntityDataInput } from '@offlinecat/ocorm'

const input = new EntityDataInput()
input.set('name', '李四')
input.set('email', 'lisi@example.com')
input.set('age', 30)

const user = EntityData.from('User', input)
```

### 属性操作

```typescript
const user = new EntityData('User')

// 添加属性
user.addProperty('name', '张三', 'string')

// 获取属性对象
const prop = user.getProperty('name')
if (prop !== null) {
  console.log(prop.propertyName)  // 'name'
  console.log(prop.value)         // '张三'
  console.log(prop.propertyType)  // 'string'
}

// 获取属性值（响应式版本，推荐）
const name = user.getPropertyValue('name')  // '张三'

// 设置属性值（触发 UI 刷新）
user.setPropertyValue('name', '李四')

// 检查属性是否存在
const exists = user.hasProperty('name')  // true

// 获取所有属性名
const names = user.getPropertyNames()  // ['name', 'email', ...]
```

### 临时数据存储

临时数据不会持久化到数据库，适用于存储计算值或 UI 状态：

```typescript
const user = new EntityData('User')

// 设置临时数据
user.setTransient('isEditing', true)
user.setTransient('displayName', '张三 (管理员)')

// 获取临时数据
const isEditing = user.getTransient('isEditing')  // true

// 检查是否存在
user.hasTransient('isEditing')  // true

// 删除临时数据
user.removeTransient('isEditing')

// 获取所有临时数据键
const keys = user.getTransientKeys()
```

### 关联数据管理

```typescript
const user = new EntityData('User')

// 设置一对多关联（数组）
const posts: Array<EntityData> = [post1, post2, post3]
user.setRelatedArray('posts', posts)

// 设置多对一关联（单个实体）
user.setRelatedSingle('department', departmentData)

// 获取关联数据
const userPosts = user.getRelatedArray('posts')        // Array<EntityData>
const dept = user.getRelatedSingle('department')       // EntityData | null

// 检查关联是否存在
user.hasRelated('posts')  // true

// 检查关联是否为数组类型
user.isRelatedArray('posts')  // true

// 获取所有关联属性名
const relNames = user.getRelatedPropertyNames()  // ['posts', 'department']

// 删除关联
user.removeRelated('posts')
```

### 延迟加载关联

```typescript
const user = new EntityData('User')

// 设置延迟加载器
user.setLazyRelation('posts', async () => {
  const posts = await postRepo.findByUserId(user.getPropertyValue('id') as number)
  return RelatedDataValue.fromArray(posts)
})

// 检查是否有延迟加载
user.hasLazyRelation('posts')  // true

// 触发延迟加载
const posts = await user.loadRelatedArray('posts')
const dept = await user.loadRelatedSingle('department')
```

### 响应式 UI 绑定

`EntityData` 使用 `@ObservedV2` 和 `@Trace` 装饰器，属性变更会自动触发 UI 刷新：

```typescript
@Entry
@Component
struct UserCard {
  @State user: EntityData = new EntityData('User')

  build() {
    Column() {
      // 属性变更会自动刷新 UI
      Text(this.user.getPropertyValue('name') as string)
      Text(this.user.getPropertyValue('email') as string)
      
      Button('修改名称')
        .onClick(() => {
          // 这会触发 UI 刷新
          this.user.setPropertyValue('name', '新名称')
        })
    }
  }
}
```

---

## DataMapper - 数据映射器

`DataMapper` 处理 `EntityData` 与数据库记录（`ValuesBucket`、`ResultSetRow`）之间的双向转换。

### 创建 DataMapper

```typescript
import { DataMapper } from '@offlinecat/ocorm'

// 根据实体名称创建（实体必须已注册）
const mapper = new DataMapper('User')

// 获取实体元数据
const metadata = mapper.getMetadata()
```

### 实体数据转 ValuesBucket

```typescript
const mapper = new DataMapper('User')
const user = new EntityData('User')
user.addProperty('name', '张三', 'string')
user.addProperty('email', 'zhangsan@example.com', 'string')

// 转换为 ValuesBucket（用于插入/更新）
const bucket = mapper.toValuesBucket(user)

// 包含自增主键（用于指定 ID 插入）
const bucketWithId = mapper.toValuesBucket(user, true)
```

### 结果集转实体数据

```typescript
import { DataMapper, ResultSetRow } from '@offlinecat/ocorm'

const mapper = new DataMapper('User')

// 从单行结果转换
const row = new ResultSetRow()
row.set('id', 1)
row.set('name', '张三')
row.set('email', 'zhangsan@example.com')

const user = mapper.fromResultSetRow(row)

// 从多行结果转换
const rows: Array<ResultSetRow> = [row1, row2, row3]
const users = mapper.fromResultSet(rows)
```

### 主键操作

```typescript
const mapper = new DataMapper('User')
const user = new EntityData('User')
user.addProperty('id', 1, 'number')

// 获取主键值
const pkValue = mapper.getPrimaryKeyValue(user)  // 1

// 设置主键值
mapper.setPrimaryKeyValue(user, 100)

// 检查是否为新记录（主键为空或为 0）
const isNew = mapper.isNewRecord(user)  // false
```

---

## TypeConverter - 类型转换器

`TypeConverter` 处理 ArkTS 类型与数据库类型之间的双向转换。

### 支持的类型转换

`EntityData` 的属性值类型为 `ValueType = string | number | boolean | null`，因此 `Date/object/BLOB` 等以约定的基础类型存储：

| 逻辑类型（propertyType） | ValueType 中存储 | 数据库类型 | 转换说明 |
|------------|------------|----------|----------|
| string | string | TEXT | 直接存储 |
| number | number | INTEGER/REAL | 整数存 INTEGER，浮点存 REAL |
| boolean | boolean | INTEGER | true → 1, false → 0 |
| Date | number | INTEGER | 时间戳（毫秒）；需要时用 `timestampToDate()` 转回 Date |
| object | string | TEXT | JSON 字符串；需要时用 `jsonToObject()` 解析为对象 |
| blob/Uint8Array | string | BLOB | 以字符串（例如 Base64）形式处理；原始二进制建议直接从底层查询结果读取 |

### 基础类型转换

```typescript
import { TypeConverter } from '@offlinecat/ocorm'

// Date 转时间戳
const timestamp = TypeConverter.dateToTimestamp(new Date())  // 毫秒时间戳

// 时间戳转 Date
const date = TypeConverter.timestampToDate(1704067200000)

// boolean 转整数
const intVal = TypeConverter.booleanToInt(true)   // 1
const intVal2 = TypeConverter.booleanToInt(false) // 0

// 整数转 boolean
const boolVal = TypeConverter.intToBoolean(1)  // true
const boolVal2 = TypeConverter.intToBoolean(0) // false

// 对象转 JSON
const json = TypeConverter.objectToJson({ name: '张三', age: 25 })
// '{"name":"张三","age":25}'

// JSON 转对象
const obj = TypeConverter.jsonToObject('{"name":"张三"}')
```

### 通用转换方法

```typescript
import { TypeConverter, ColumnType } from '@offlinecat/ocorm'

// ArkTS 值 → 数据库值
const dbValue = TypeConverter.toDbValue(
  '张三',           // 值
  ColumnType.TEXT,  // 目标列类型
  'string'          // 属性类型标识
)

// boolean 转换示例
const dbBool = TypeConverter.toDbValue(true, ColumnType.INTEGER, 'boolean')
// 结果: 1

// Date 转换示例（假设已转为时间戳）
const dbDate = TypeConverter.toDbValue(1704067200000, ColumnType.INTEGER, 'Date')
// 结果: 1704067200000

// 数据库值 → ArkTS 值
const value = TypeConverter.fromDbValue(
  1,         // 数据库值
  'boolean', // 目标属性类型
  'is_active' // 列名（用于错误报告）
)
// 结果: true
```

---

## ValuesBucket - 数据库键值对

`ValuesBucket` 用于数据库插入/更新操作的键值对容器：

```typescript
import { ValuesBucket } from '@offlinecat/ocorm'

const bucket = new ValuesBucket()

// 设置值
bucket.set('name', '张三')
bucket.set('age', 25)
bucket.set('is_active', 1)

// 获取值
const name = bucket.get('name')  // '张三'

// 检查键是否存在
bucket.has('name')  // true

// 获取所有键
const keys = bucket.keys()  // ['name', 'age', 'is_active']

// 获取内部 Map
const data = bucket.getData()
```

---

## ResultSetRow - 结果集行

`ResultSetRow` 模拟数据库查询结果的单行数据：

```typescript
import { ResultSetRow } from '@offlinecat/ocorm'

const row = new ResultSetRow()

// 设置列值
row.set('id', 1)
row.set('name', '张三')
row.set('created_at', 1704067200000)

// 获取列值
const id = row.get('id')  // 1

// 检查列是否存在
row.has('name')  // true

// 获取所有列名
const columns = row.getColumnNames()  // ['id', 'name', 'created_at']
```

---

## EntityDataInput - 快速输入

`EntityDataInput` 提供简洁的实体数据输入方式：

```typescript
import { EntityDataInput, EntityData } from '@offlinecat/ocorm'

const input = new EntityDataInput()
input.set('name', '张三')
input.set('email', 'zhangsan@example.com')
input.set('age', 25)

// 快速构建 EntityData
const user = EntityData.from('User', input)
```

---

## RelatedDataValue - 关联数据值

`RelatedDataValue` 用于存储关联实体数据：

```typescript
import { RelatedDataValue, EntityData } from '@offlinecat/ocorm'

// 创建数组类型关联（一对多）
const posts: Array<EntityData> = [post1, post2]
const arrayValue = RelatedDataValue.fromArray(posts)
console.log(arrayValue.isArray)       // true
console.log(arrayValue.entityArray)   // [post1, post2]

// 创建单个实体类型关联（多对一）
const singleValue = RelatedDataValue.fromSingle(departmentData)
console.log(singleValue.isArray)        // false
console.log(singleValue.singleEntity)   // departmentData
```

---

## 完整示例

### 用户实体 CRUD

```typescript
import { Repository, EntityData, EntityDataInput, DataMapper } from '@offlinecat/ocorm'

// 创建用户
async function createUser(name: string, email: string): Promise<EntityData> {
  const input = new EntityDataInput()
  input.set('name', name)
  input.set('email', email)
  input.set('createdAt', Date.now())
  
  const user = EntityData.from('User', input)
  
  const repo = new Repository('User')
  const result = await repo.save(user)
  
  // 设置插入后的 ID
  const mapper = new DataMapper('User')
  mapper.setPrimaryKeyValue(user, result.insertId)
  
  return user
}

// 更新用户
async function updateUser(user: EntityData, newName: string): Promise<void> {
  user.setPropertyValue('name', newName)
  user.setPropertyValue('updatedAt', Date.now())
  
  const repo = new Repository('User')
  await repo.save(user)
}

// 查询并显示
async function displayUser(id: number): Promise<void> {
  const repo = new Repository('User')
  const user = await repo.findById(id)
  
  if (user !== null) {
    console.log(`用户: ${user.getPropertyValue('name')}`)
    console.log(`邮箱: ${user.getPropertyValue('email')}`)
    
    // 加载关联的文章
    if (user.hasLazyRelation('posts')) {
      const posts = await user.loadRelatedArray('posts')
      console.log(`文章数: ${posts.length}`)
    }
  }
}
```

### 响应式列表组件

```typescript
import { EntityData } from '@offlinecat/ocorm'

@Entry
@Component
struct UserList {
  @State users: Array<EntityData> = []

  async aboutToAppear() {
    const repo = new Repository('User')
    this.users = await repo.findAll()
  }

  build() {
    List() {
      ForEach(this.users, (user: EntityData) => {
        ListItem() {
          Row() {
            Text(user.getPropertyValue('name') as string)
              .fontSize(16)
            Blank()
            Text(user.getPropertyValue('email') as string)
              .fontSize(14)
              .fontColor('#666')
          }
          .width('100%')
          .padding(12)
        }
      })
    }
  }
}
```

---

## 类型安全建议

1. **使用类型断言** - `getPropertyValue` 返回 `ValueType`，需要断言为具体类型
2. **验证空值** - 属性可能为 `null`，使用前需要检查
3. **属性类型标识** - `addProperty` 的第三个参数用于类型转换（boolean/Date/object 等），但属性值仍需符合 `ValueType`（Date 用时间戳 number，object 用 JSON string）

```typescript
// 推荐做法
const name = user.getPropertyValue('name') as string | null
if (name !== null) {
  console.log(name.toUpperCase())
}

// 数字类型
const age = user.getPropertyValue('age') as number
if (age > 0) {
  console.log(`年龄: ${age}`)
}
```

