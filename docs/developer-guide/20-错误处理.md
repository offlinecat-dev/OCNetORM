# 错误处理

OCORM 提供完整的错误处理体系，包括分类错误类型、统一错误码和多语言错误消息支持。

---

## OrmError - 错误基类

所有 OCORM 错误都继承自 `OrmError` 基类：

```typescript
class OrmError extends Error {
  code: string              // 错误码
  context: ErrorContext     // 错误上下文
  
  getFullMessage(): string  // 获取完整错误信息
}

class ErrorContext {
  entityName: string   // 实体名称
  columnName: string   // 列名
  tableName: string    // 表名
  operation: string    // 操作类型
  details: string      // 详细信息
}
```

### 使用示例

```typescript
import { Repository, OrmError } from '@aspect/ocorm'

try {
  const repo = new Repository('User')
  await repo.save(invalidData)
} catch (error) {
  if (error instanceof OrmError) {
    console.log(`错误码: ${error.code}`)
    console.log(`错误消息: ${error.message}`)
    console.log(`完整信息: ${error.getFullMessage()}`)
    
    // 访问上下文
    if (error.context.entityName) {
      console.log(`相关实体: ${error.context.entityName}`)
    }
  }
}
```

---

## 错误类型分类

### MetadataError - 元数据错误

与实体定义和元数据相关的错误：

```typescript
import {
  MetadataError,
  EntityNotRegisteredError,
  DuplicateEntityError,
  InvalidColumnTypeError,
  ColumnNotFoundError,
  PrimaryKeyNotDefinedError
} from '@aspect/ocorm'

// 实体未注册
throw new EntityNotRegisteredError('User')
// 错误码: ORM001, 消息: 实体 "User" 未注册

// 重复注册实体
throw new DuplicateEntityError('User')
// 错误码: ORM002, 消息: 实体 "User" 已存在，不能重复注册

// 无效列类型
throw new InvalidColumnTypeError('User', 'profile', 'CUSTOM_TYPE')
// 错误码: ORM003, 消息: 列 "profile" 的类型不受支持: CUSTOM_TYPE

// 列不存在
throw new ColumnNotFoundError('User', 'unknownColumn')
// 错误码: ORM004, 消息: 在实体 "User" 中未找到列 "unknownColumn"

// 未定义主键
throw new PrimaryKeyNotDefinedError('User')
// 错误码: ORM005, 消息: 实体 "User" 未定义主键
```

### QueryError - 查询错误

与查询构建相关的错误：

```typescript
import {
  QueryError,
  InvalidConditionError,
  PredicateBuildError,
  InvalidOperatorError,
  SubQueryError
} from '@aspect/ocorm'

// 无效查询条件
throw new InvalidConditionError('age', '值必须为数字')
// 错误码: ORM101, 消息: 查询条件无效: 值必须为数字

// Predicates 构建失败
throw new PredicateBuildError('User', '无法构建复杂条件')
// 错误码: ORM102, 消息: 构建 RdbPredicates 失败: 无法构建复杂条件

// 无效操作符
throw new InvalidOperatorError('LIKE_ANY')
// 错误码: ORM103, 消息: 不支持的查询操作符: LIKE_ANY

// 子查询错误
throw new SubQueryError('子查询返回多行')
// 错误码: ORM104, 消息: 子查询构建失败: 子查询返回多行
```

### MappingError - 映射错误

与数据映射和类型转换相关的错误：

```typescript
import {
  MappingError,
  TypeConversionError,
  NullValueError,
  EntityMappingError,
  TypeMismatchError
} from '@aspect/ocorm'

// 类型转换失败
throw new TypeConversionError('string', 'number', 'age')
// 错误码: ORM201, 消息: 类型转换失败: 无法将 string 转换为 number

// 非空列为空值
throw new NullValueError('User', 'email')
// 错误码: ORM202, 消息: 列 "email" 不允许为空值

// 实体映射失败
throw new EntityMappingError('User', '缺少必要字段')
// 错误码: ORM203, 消息: 实体 "User" 映射失败: 缺少必要字段

// 类型不匹配
throw new TypeMismatchError('number', 'string')
// 错误码: ORM204, 消息: 类型不匹配: 期望 'number'，实际 'string'
```

### TransactionError - 事务错误

与事务处理相关的错误：

```typescript
import {
  TransactionError,
  TransactionNotStartedError,
  TransactionRollbackError,
  TransactionCommitError
} from '@aspect/ocorm'

// 事务未启动
throw new TransactionNotStartedError()
// 错误码: ORM301, 消息: 事务未启动

// 事务回滚
throw new TransactionRollbackError('并发冲突')
// 错误码: ORM302, 消息: 事务已回滚: 并发冲突

// 提交失败
throw new TransactionCommitError('数据库锁定')
// 错误码: ORM303, 消息: 事务提交失败: 数据库锁定
```

### DatabaseError - 数据库错误

与数据库连接和 SQL 执行相关的错误：

```typescript
import {
  DatabaseError,
  ConnectionError,
  ExecutionError,
  DatabaseNotInitializedError
} from '@aspect/ocorm'

// 连接失败
throw new ConnectionError('myapp.db', 'Permission denied')
// 错误码: ORM401, 消息: 数据库 "myapp.db" 连接失败: Permission denied

// SQL 执行失败
throw new ExecutionError('INSERT INTO users...', 'UNIQUE constraint failed')
// 错误码: ORM402, 消息: SQL 执行失败: UNIQUE constraint failed

// 数据库未初始化
throw new DatabaseNotInitializedError()
// 错误码: ORM403, 消息: 数据库未初始化，请先调用 initialize() 方法
```

### RelationError - 关联关系错误

与实体关联相关的错误：

```typescript
import {
  RelationNotFoundError,
  InvalidRelationTypeError,
  InvalidForeignKeySideError,
  JoinTableNotFoundError
} from '@aspect/ocorm'

// 关联未找到
throw new RelationNotFoundError('User', 'posts')
// 错误码: ORM501, 消息: 实体 "User" 的关联关系未找到: posts

// 无效关系类型
throw new InvalidRelationTypeError('INVALID_TYPE')
// 错误码: ORM502, 消息: 无效的关系类型: INVALID_TYPE

// 外键位置错误
throw new InvalidForeignKeySideError('外键应定义在多的一方')
// 错误码: ORM503, 消息: 无效的外键位置: 外键应定义在多的一方

// 中间表未找到
throw new JoinTableNotFoundError('user_roles')
// 错误码: ORM504, 消息: 多对多关联中间表未找到: user_roles
```

### ValidationError - 验证错误

与数据验证相关的错误：

```typescript
import {
  ValidationError,
  RequiredValidationError,
  LengthValidationError,
  EmailValidationError,
  EntityValidationError
} from '@aspect/ocorm'

// 必填字段为空
throw new RequiredValidationError('User', 'name')
// 错误码: ORM802, 消息: 字段 name 为必填项

// 长度验证失败
throw new LengthValidationError('User', 'name', 2, 50)
// 错误码: ORM803, 消息: 字段 name 长度需在 2 到 50 之间

// 邮箱格式错误
throw new EmailValidationError('User', 'email', 'invalid-email')
// 错误码: ORM804, 消息: 字段 email 不是有效的邮箱地址

// 实体验证失败
throw new EntityValidationError('User', '多个字段验证失败')
// 错误码: ORM801, 消息: 实体 User 验证失败: 多个字段验证失败
```

### 其他错误类型

```typescript
import { HookExecutionError } from '@aspect/ocorm'
import { SoftDeleteNotEnabledError } from '@aspect/ocorm'

// 钩子执行失败
throw new HookExecutionError('User', 'beforeSave', '验证失败')
// 错误码: ORM601, 消息: 实体 "User" 的钩子 "beforeSave" 执行失败: 验证失败

// 软删除未启用
throw new SoftDeleteNotEnabledError('User')
// 错误码: ORM701, 消息: 实体 "User" 未启用软删除功能
```

---

## 错误码速查表

### 元数据错误码 (ORM001-ORM099)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| ORM001 | ERROR_ENTITY_NOT_REGISTERED | 实体未注册 |
| ORM002 | ERROR_DUPLICATE_ENTITY | 实体重复注册 |
| ORM003 | ERROR_INVALID_COLUMN_TYPE | 无效列类型 |
| ORM004 | ERROR_COLUMN_NOT_FOUND | 列未找到 |
| ORM005 | ERROR_PRIMARY_KEY_NOT_DEFINED | 未定义主键 |

### 查询错误码 (ORM101-ORM199)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| ORM101 | ERROR_INVALID_CONDITION | 无效查询条件 |
| ORM102 | ERROR_PREDICATE_BUILD_FAILED | Predicates 构建失败 |
| ORM103 | ERROR_INVALID_OPERATOR | 无效操作符 |
| ORM104 | ERROR_SUB_QUERY | 子查询错误 |

### 映射错误码 (ORM201-ORM299)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| ORM201 | ERROR_TYPE_CONVERSION_FAILED | 类型转换失败 |
| ORM202 | ERROR_NULL_VALUE_NOT_ALLOWED | 非空值为空 |
| ORM203 | ERROR_MAPPING_FAILED | 映射失败 |
| ORM204 | ERROR_TYPE_MISMATCH | 类型不匹配 |

### 事务错误码 (ORM301-ORM399)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| ORM301 | ERROR_TRANSACTION_NOT_STARTED | 事务未启动 |
| ORM302 | ERROR_TRANSACTION_ROLLBACK | 事务回滚 |
| ORM303 | ERROR_TRANSACTION_COMMIT_FAILED | 提交失败 |

### 数据库错误码 (ORM401-ORM499)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| ORM401 | ERROR_DATABASE_CONNECTION_FAILED | 连接失败 |
| ORM402 | ERROR_SQL_EXECUTION_FAILED | SQL 执行失败 |
| ORM403 | ERROR_DATABASE_NOT_INITIALIZED | 数据库未初始化 |

### 关联错误码 (ORM501-ORM599)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| ORM501 | ERROR_RELATION_NOT_FOUND | 关联未找到 |
| ORM502 | ERROR_INVALID_RELATION_TYPE | 无效关系类型 |
| ORM503 | ERROR_INVALID_FOREIGN_KEY_SIDE | 外键位置错误 |
| ORM504 | ERROR_JOIN_TABLE_NOT_FOUND | 中间表未找到 |

### 钩子错误码 (ORM601-ORM699)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| ORM601 | ERROR_HOOK_EXECUTION_FAILED | 钩子执行失败 |

### 软删除错误码 (ORM701-ORM799)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| ORM701 | ERROR_SOFT_DELETE_NOT_ENABLED | 软删除未启用 |

### 验证错误码 (ORM801-ORM899)

| 错误码 | 常量名 | 说明 |
|--------|--------|------|
| ORM801 | ERROR_VALIDATION_FAILED | 验证失败 |
| ORM802 | ERROR_VALIDATION_REQUIRED | 必填验证失败 |
| ORM803 | ERROR_VALIDATION_LENGTH | 长度验证失败 |
| ORM804 | ERROR_VALIDATION_EMAIL | 邮箱验证失败 |

---

## 错误国际化

OCORM 支持错误消息的多语言输出，内置中文和英文两种语言。

### 设置语言

```typescript
import { setErrorLocale, getErrorLocale } from '@aspect/ocorm'

// 设置为中文（默认）
setErrorLocale('zh')

// 设置为英文
setErrorLocale('en')

// 获取当前语言
const currentLocale = getErrorLocale()  // 'zh' 或 'en'
```

### 内置语言对比

| 错误码 | 中文消息 | 英文消息 |
|--------|----------|----------|
| ORM001 | 实体 "{entityName}" 未注册 | Entity "{entityName}" is not registered |
| ORM202 | 列 "{columnName}" 不允许为空值 | Column "{columnName}" does not allow null |
| ORM301 | 事务未启动 | Transaction not started |
| ORM403 | 数据库未初始化 | Database not initialized |

### 自定义错误消息

```typescript
import { registerErrorLocaleMessages, ErrorLocaleMessages } from '@aspect/ocorm'

// 创建自定义消息
const customMessages = new ErrorLocaleMessages()
customMessages.add('ORM001', '找不到实体: {entityName}，请检查是否已注册')
customMessages.add('ORM202', '字段 {columnName} 必须填写')

// 注册到指定语言
registerErrorLocaleMessages('zh', customMessages, true)  // true = 覆盖现有消息
```

### 添加新语言

```typescript
import { registerErrorLocaleMessages, ErrorLocaleMessages, setErrorLocale } from '@aspect/ocorm'

// 创建日语消息
const jaMessages = new ErrorLocaleMessages()
jaMessages.add('ORM001', 'エンティティ "{entityName}" が登録されていません')
jaMessages.add('ORM002', 'エンティティ "{entityName}" は既に登録されています')
jaMessages.add('ORM202', '列 "{columnName}" は空にできません')
// ... 添加更多消息

// 注册日语
registerErrorLocaleMessages('ja', jaMessages)

// 切换到日语
setErrorLocale('ja')
```

### 消息模板变量

错误消息支持使用 `{变量名}` 格式的模板变量：

| 变量名 | 说明 | 示例 |
|--------|------|------|
| `{entityName}` | 实体名称 | User |
| `{columnName}` | 列名 | email |
| `{tableName}` | 表名 | users |
| `{operation}` | 操作类型 | INSERT |
| `{details}` | 详细信息 | 具体错误描述 |
| `{min}` | 最小值 | 2 |
| `{max}` | 最大值 | 50 |

---

## 错误处理最佳实践

### 统一错误处理

```typescript
import { OrmError, DatabaseError, ValidationError, QueryError } from '@aspect/ocorm'

async function handleDatabaseOperation<T>(operation: () => Promise<T>): Promise<T | null> {
  try {
    return await operation()
  } catch (error) {
    if (error instanceof ValidationError) {
      // 验证错误：显示给用户
      showUserError(error.message)
      return null
    }
    
    if (error instanceof QueryError) {
      // 查询错误：记录日志，显示通用消息
      console.error(`查询错误 [${error.code}]: ${error.getFullMessage()}`)
      showUserError('查询失败，请稍后重试')
      return null
    }
    
    if (error instanceof DatabaseError) {
      // 数据库错误：记录日志，可能需要重试
      console.error(`数据库错误 [${error.code}]: ${error.getFullMessage()}`)
      showUserError('系统繁忙，请稍后重试')
      return null
    }
    
    if (error instanceof OrmError) {
      // 其他 ORM 错误
      console.error(`ORM 错误 [${error.code}]: ${error.getFullMessage()}`)
      showUserError('操作失败')
      return null
    }
    
    // 未知错误
    console.error('未知错误:', error)
    throw error
  }
}

// 使用
const user = await handleDatabaseOperation(async () => {
  const repo = new Repository('User')
  return await repo.findById(1)
})
```

### 按错误码处理

```typescript
import { OrmError, ERROR_DATABASE_NOT_INITIALIZED, ERROR_ENTITY_NOT_REGISTERED } from '@aspect/ocorm'

try {
  await someOperation()
} catch (error) {
  if (error instanceof OrmError) {
    switch (error.code) {
      case ERROR_DATABASE_NOT_INITIALIZED:
        // 数据库未初始化，尝试重新初始化
        await reinitializeDatabase()
        break
        
      case ERROR_ENTITY_NOT_REGISTERED:
        // 实体未注册，开发时错误
        console.error('开发错误: 实体未注册', error.context.entityName)
        break
        
      default:
        console.error(`未处理的错误 [${error.code}]`, error.message)
    }
  }
}
```

### 表单验证错误展示

```typescript
import { ValidationError, RequiredValidationError, LengthValidationError } from '@aspect/ocorm'

interface FormErrors {
  [fieldName: string]: string
}

function extractFormErrors(error: Error): FormErrors {
  const errors: FormErrors = {}
  
  if (error instanceof RequiredValidationError) {
    errors[error.context.columnName] = '此字段为必填项'
  } else if (error instanceof LengthValidationError) {
    errors[error.context.columnName] = error.message
  } else if (error instanceof ValidationError) {
    errors['_form'] = error.message
  }
  
  return errors
}

// 在 UI 组件中使用
@Component
struct UserForm {
  @State errors: FormErrors = {}
  
  async saveUser() {
    try {
      await this.repo.save(this.userData)
      this.errors = {}
    } catch (error) {
      this.errors = extractFormErrors(error)
    }
  }
  
  build() {
    Column() {
      TextInput({ placeholder: '姓名' })
      if (this.errors['name']) {
        Text(this.errors['name']).fontColor(Color.Red)
      }
      
      TextInput({ placeholder: '邮箱' })
      if (this.errors['email']) {
        Text(this.errors['email']).fontColor(Color.Red)
      }
      
      if (this.errors['_form']) {
        Text(this.errors['_form']).fontColor(Color.Red)
      }
    }
  }
}
```

### 重试机制

```typescript
import { DatabaseError, TransactionError } from '@aspect/ocorm'

async function withRetry<T>(
  operation: () => Promise<T>,
  maxRetries: number = 3,
  delay: number = 100
): Promise<T> {
  let lastError: Error | null = null
  
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await operation()
    } catch (error) {
      lastError = error as Error
      
      // 只对可重试的错误进行重试
      if (error instanceof TransactionError || error instanceof DatabaseError) {
        console.log(`操作失败，${delay}ms 后重试 (${i + 1}/${maxRetries})`)
        await new Promise(resolve => setTimeout(resolve, delay))
        delay *= 2  // 指数退避
        continue
      }
      
      // 其他错误直接抛出
      throw error
    }
  }
  
  throw lastError
}

// 使用
const result = await withRetry(async () => {
  return await repo.save(userData)
}, 3, 100)
```

---

## 导入错误类

```typescript
// 导入所有错误类型
import {
  // 基础
  OrmError,
  ErrorContext,
  
  // 错误码
  ERROR_ENTITY_NOT_REGISTERED,
  ERROR_DATABASE_NOT_INITIALIZED,
  // ... 更多错误码
  
  // 元数据错误
  MetadataError,
  EntityNotRegisteredError,
  DuplicateEntityError,
  
  // 查询错误
  QueryError,
  InvalidConditionError,
  
  // 映射错误
  MappingError,
  TypeConversionError,
  NullValueError,
  
  // 事务错误
  TransactionError,
  TransactionNotStartedError,
  
  // 数据库错误
  DatabaseError,
  ConnectionError,
  ExecutionError,
  
  // 验证错误
  ValidationError,
  RequiredValidationError,
  
  // 国际化
  setErrorLocale,
  getErrorLocale,
  registerErrorLocaleMessages
} from '@aspect/ocorm'
```
