# 实体定义

OCORM 支持两种方式定义实体：**Schema 方式**（推荐）和**装饰器方式**。

---

## 方式一：defineEntity + EntitySchema（推荐）

由于 ArkTS 装饰器的限制，推荐使用 `defineEntity` 函数配合 `EntitySchema` 进行实体定义。

### 基础示例

```typescript
import { defineEntity, ColumnType } from '@offlinecat/ocorm'

// 定义 User 实体
defineEntity('User', {
  tableName: 'users',
  columns: [
    { property: 'id', primaryKey: true, autoIncrement: true },
    { property: 'name', name: 'user_name', type: ColumnType.TEXT },
    { property: 'email', type: ColumnType.TEXT, unique: true },
    { property: 'age', type: ColumnType.INTEGER, nullable: true },
    { property: 'createdAt', name: 'created_at', type: ColumnType.INTEGER }
  ]
})
```

### EntitySchema 接口

```typescript
interface EntitySchema {
  tableName?: string              // 表名（可选，默认使用实体名）
  columns: Array<ColumnSchema>    // 列定义列表
  softDelete?: boolean | SoftDeleteSchema  // 软删除配置
}
```

### ColumnSchema 接口

```typescript
interface ColumnSchema {
  property: string           // 实体属性名（必填）
  name?: string              // 数据库列名（默认使用属性名）
  type?: ColumnType          // 列类型（默认 TEXT）
  nullable?: boolean         // 是否允许为空（默认 true）
  unique?: boolean           // 是否唯一（默认 false）
  defaultValue?: string | number | null  // 默认值
  length?: number            // TEXT 长度限制
  primaryKey?: boolean       // 是否主键
  autoIncrement?: boolean    // 是否自增（仅主键有效，默认 true）
}
```

### 完整实体定义示例

```typescript
import { defineEntity, ColumnType } from '@offlinecat/ocorm'

// 文章实体（带软删除）
defineEntity('Article', {
  tableName: 'articles',
  columns: [
    { property: 'id', primaryKey: true },
    { property: 'title', type: ColumnType.TEXT, nullable: false },
    { property: 'content', type: ColumnType.TEXT },
    { property: 'authorId', name: 'author_id', type: ColumnType.INTEGER },
    { property: 'viewCount', name: 'view_count', type: ColumnType.INTEGER, defaultValue: 0 },
    { property: 'createdAt', name: 'created_at', type: ColumnType.INTEGER },
    { property: 'updatedAt', name: 'updated_at', type: ColumnType.INTEGER }
  ],
  softDelete: true  // 启用软删除，使用默认列名 deleted_at
})

// 自定义软删除列名
defineEntity('Comment', {
  tableName: 'comments',
  columns: [
    { property: 'id', primaryKey: true },
    { property: 'content', type: ColumnType.TEXT }
  ],
  softDelete: {
    propertyName: 'deletedTime',
    columnName: 'deleted_time'
  }
})
```

### 非自增主键

```typescript
defineEntity('Config', {
  tableName: 'configs',
  columns: [
    { property: 'key', primaryKey: true, autoIncrement: false },  // 非自增主键
    { property: 'value', type: ColumnType.TEXT }
  ]
})
```

---

## 方式二：装饰器方式

OCORM 也支持类装饰器方式定义实体，但需要手动调用注册函数。

### @Table 装饰器

```typescript
import { Table, registerEntity } from '@offlinecat/ocorm'

@Table('users')
class User {
  id: number = 0
  name: string = ''
  email: string = ''
}

// 注意：装饰器执行后需确保实体已注册
// 如果装饰器未自动触发，手动调用：
registerEntity('User', { tableName: 'users' })
```

### registerEntity 函数

```typescript
import { registerEntity, createEntityOptions } from '@offlinecat/ocorm'

// 基础注册
registerEntity('User')

// 指定表名
registerEntity('User', createEntityOptions('users'))
```

### 列装饰器

```typescript
import { Table, Column, PrimaryKey, CreatedAt, UpdatedAt, SoftDelete, ColumnType } from '@offlinecat/ocorm'

@Table('users')
class User {
  @PrimaryKey()
  id: number = 0

  @Column({ name: 'user_name', type: ColumnType.TEXT })
  name: string = ''

  @Column({ type: ColumnType.TEXT, unique: true })
  email: string = ''

  @Column({ type: ColumnType.INTEGER, nullable: true })
  age: number | null = null

  @CreatedAt()
  createdAt: number = 0

  @UpdatedAt()
  updatedAt: number = 0

  @SoftDelete()
  deletedAt: number | null = null
}
```

### 手动注册列

```typescript
import { 
  registerEntity, 
  createEntityOptions,
  registerColumn, 
  registerPrimaryKey, 
  registerAutoIncrementPrimaryKey,
  createColumnOptions,
  ColumnType 
} from '@offlinecat/ocorm'

// 1. 先注册实体
registerEntity('User', createEntityOptions('users'))

// 2. 注册自增主键
registerAutoIncrementPrimaryKey('User', 'id')

// 3. 注册普通列
const nameOptions = createColumnOptions()
nameOptions.name = 'user_name'
nameOptions.type = ColumnType.TEXT
nameOptions.nullable = false
registerColumn('User', 'name', nameOptions)

// 4. 注册带约束的列
const emailOptions = createColumnOptions()
emailOptions.type = ColumnType.TEXT
emailOptions.unique = true
registerColumn('User', 'email', emailOptions)
```

---

## MetadataStorage 元数据存储

`MetadataStorage` 是单例类，全局管理所有实体的元数据。

### 常用方法

```typescript
import { MetadataStorage } from '@offlinecat/ocorm'

const storage = MetadataStorage.getInstance()

// 检查实体是否已注册
storage.hasEntity('User')  // boolean

// 获取实体元数据
const metadata = storage.getEntityMetadata('User')

// 获取所有已注册实体
const allEntities = storage.getAllEntities()

// 获取实体数量
const count = storage.getEntityCount()
```

### 获取列信息

```typescript
const metadata = storage.getEntityMetadata('User')
if (metadata) {
  // 通过属性名获取列
  const column = metadata.getColumnByProperty('name')
  
  // 通过列名获取列
  const columnByName = metadata.getColumnByName('user_name')
  
  // 获取主键列
  const pkColumn = metadata.getPrimaryKeyColumn()
  
  // 获取所有列
  const allColumns = metadata.columns
  
  // 获取非主键列
  const nonPkColumns = metadata.getNonPrimaryKeyColumns()
}
```

---

## 实体定义最佳实践

### 1. 统一在初始化前定义实体

```typescript
// entities/index.ets
import { defineEntity, ColumnType } from '@offlinecat/ocorm'

export function registerAllEntities() {
  defineEntity('User', {
    tableName: 'users',
    columns: [
      { property: 'id', primaryKey: true },
      { property: 'name', type: ColumnType.TEXT }
    ]
  })

  defineEntity('Article', {
    tableName: 'articles',
    columns: [
      { property: 'id', primaryKey: true },
      { property: 'title', type: ColumnType.TEXT }
    ],
    softDelete: true
  })
}

// 在 OCORMInit 之前调用
registerAllEntities()
await OCORMInit(context, { config })
```

### 2. 属性名与列名映射

```typescript
// 推荐：ArkTS 用驼峰命名，数据库用下划线命名
defineEntity('User', {
  columns: [
    { property: 'userId', name: 'user_id', type: ColumnType.INTEGER },
    { property: 'firstName', name: 'first_name', type: ColumnType.TEXT },
    { property: 'createdAt', name: 'created_at', type: ColumnType.INTEGER }
  ]
})
```

### 3. 时间戳字段

```typescript
// 使用 INTEGER 存储时间戳（毫秒）
defineEntity('User', {
  columns: [
    { property: 'id', primaryKey: true },
    { property: 'createdAt', name: 'created_at', type: ColumnType.INTEGER },
    { property: 'updatedAt', name: 'updated_at', type: ColumnType.INTEGER }
  ]
})

// Repository 会自动更新 updated_at 字段
```

### 4. 软删除配置

```typescript
// 方式1：使用默认配置
defineEntity('Article', {
  columns: [...],
  softDelete: true  // 自动添加 deletedAt/deleted_at 列
})

// 方式2：自定义列名
defineEntity('Article', {
  columns: [...],
  softDelete: {
    propertyName: 'deletedAt',
    columnName: 'deleted_at'
  }
})
```
