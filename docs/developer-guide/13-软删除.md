# 软删除

软删除（Soft Delete）是一种数据删除策略，不实际删除数据库记录，而是通过标记删除时间来表示记录已被"删除"。这种方式可以保留数据历史，支持数据恢复。

---

## 软删除配置

### 实体配置

在定义实体时启用软删除功能：

```typescript
import { defineEntity, ColumnType } from '@aspect/ocorm'

defineEntity('User', {
  tableName: 'users',
  columns: [
    { property: 'id', primaryKey: true, autoIncrement: true },
    { property: 'name', type: ColumnType.TEXT },
    { property: 'email', type: ColumnType.TEXT },
    { property: 'createdAt', name: 'created_at', type: ColumnType.INTEGER },
    { property: 'updatedAt', name: 'updated_at', type: ColumnType.INTEGER }
  ],
  // 启用软删除
  softDelete: {
    propertyName: 'deletedAt',   // 实体属性名
    columnName: 'deleted_at'      // 数据库列名
  }
})
```

### 检查软删除配置

```typescript
import { MetadataStorage } from '@aspect/ocorm'

const storage = MetadataStorage.getInstance()
const metadata = storage.getEntityMetadata('User')

if (metadata !== null) {
  // 检查是否启用软删除
  const isSoftDeleteEnabled = metadata.isSoftDeleteEnabled()
  console.log(`软删除已启用: ${isSoftDeleteEnabled}`)
  
  // 获取删除时间列名
  const deletedAtColumn = metadata.getDeletedAtColumn()
  console.log(`删除时间列: ${deletedAtColumn}`)
}
```

---

## 软删除操作

### remove - 软删除实体

```typescript
import { Repository, EntityData } from '@aspect/ocorm'

const repo = new Repository('User')

// 方式1：通过实体对象软删除
const user = await repo.findById(1)
if (user !== null) {
  const result = await repo.remove(user)
  console.log(`软删除成功: ${result.success}`)
  console.log(`影响行数: ${result.affectedRows}`)
}

// 方式2：通过 ID 软删除
const result = await repo.removeById(1)
console.log(`软删除成功: ${result.success}`)
```

### 软删除原理

软删除实际执行的是 UPDATE 操作，将 `deleted_at` 列设置为当前时间戳：

```sql
-- 实际执行的 SQL
UPDATE users SET deleted_at = 1706000000000 WHERE id = 1
```

### forceRemove - 强制物理删除

如果需要真正删除数据，使用强制删除方法：

```typescript
// 强制物理删除（不可恢复）
const result = await repo.forceRemoveById(1)
console.log(`物理删除成功: ${result.success}`)

// 验证：即使包含已删除也找不到
const notFound = await repo.findById(1, true)
console.log(`记录已完全删除: ${notFound === null}`)
```

---

## 查询过滤

### 默认行为

启用软删除后，所有查询默认过滤已删除的记录：

```typescript
const repo = new Repository('User')

// 默认不返回已删除的记录
const users = await repo.findAll()

// 按 ID 查询也默认过滤
const user = await repo.findById(1)  // 已软删除则返回 null
```

### withDeleted - 包含已删除记录

使用 `withDeleted()` 方法查询时包含已删除的记录：

```typescript
import { Repository, QueryBuilder, QueryExecutor } from '@aspect/ocorm'

const repo = new Repository('User')

// Repository 方式
const allUsers = await repo.findAll(true)  // 参数 true 表示包含已删除

const user = await repo.findById(1, true)  // 包含已删除的查询

// QueryBuilder 方式
const qb = new QueryBuilder('User')
  .withDeleted()  // 包含已删除记录
  .orderBy('createdAt', 'DESC')

const users = await new QueryExecutor(qb).get()
```

### onlyDeleted - 仅查询已删除记录

使用 `onlyDeleted()` 方法只查询已删除的记录（回收站功能）：

```typescript
const qb = new QueryBuilder('User')
  .onlyDeleted()  // 仅查询已删除记录
  .orderBy('deletedAt', 'DESC')

const deletedUsers = await new QueryExecutor(qb).get()
console.log(`回收站中有 ${deletedUsers.length} 条记录`)
```

### 检查查询状态

```typescript
const qb = new QueryBuilder('User')

// 默认状态
console.log(qb.isIncludeDeleted())  // false
console.log(qb.isOnlyDeleted())     // false

// withDeleted 后
qb.withDeleted()
console.log(qb.isIncludeDeleted())  // true

// onlyDeleted 后
const qb2 = new QueryBuilder('User').onlyDeleted()
console.log(qb2.isOnlyDeleted())    // true
```

---

## restore - 恢复记录

### 恢复已删除记录

```typescript
const repo = new Repository('User')

// 软删除
await repo.removeById(1)

// 验证已删除
const deleted = await repo.findById(1)
console.log(`已删除: ${deleted === null}`)  // true

// 恢复
const restoreResult = await repo.restore(1)
console.log(`恢复成功: ${restoreResult.success}`)

// 验证已恢复
const restored = await repo.findById(1)
console.log(`已恢复: ${restored !== null}`)  // true
```

### 恢复原理

恢复操作将 `deleted_at` 列设置为 NULL：

```sql
-- 实际执行的 SQL
UPDATE users SET deleted_at = NULL WHERE id = 1
```

---

## 软删除条件

### getSoftDeleteCondition

QueryBuilder 自动添加软删除过滤条件：

```typescript
import { QueryBuilder, ConditionOperator } from '@aspect/ocorm'

const qb = new QueryBuilder('User')
  .where('status', ConditionOperator.EQUAL, 1)

// 获取软删除条件
const softDeleteCondition = qb.getSoftDeleteCondition()

if (softDeleteCondition !== null) {
  console.log(`列名: ${softDeleteCondition.column}`)
  console.log(`操作符: ${softDeleteCondition.operator}`)  // IS_NULL
}
```

### getAllConditions

获取包含软删除条件在内的所有查询条件：

```typescript
import { QueryBuilder, ConditionOperator } from '@aspect/ocorm'

const qb = new QueryBuilder('User')
  .where('name', ConditionOperator.EQUAL, 'test')

const allConditions = qb.getAllConditions()

// 条件包括：
// 1. name = 'test'（用户条件）
// 2. deleted_at IS NULL（软删除条件）
console.log(`总条件数: ${allConditions.length}`)  // 2
```

### 软删除条件类型

| 查询模式 | 软删除条件 |
|----------|------------|
| 默认 | `deleted_at IS NULL` |
| withDeleted() | 无条件（不过滤） |
| onlyDeleted() | `deleted_at IS NOT NULL` |

---

## 软删除与计数

### count 方法

```typescript
const repo = new Repository('User')

// 默认计数（不含已删除）
const activeCount = await repo.count()
console.log(`活跃用户数: ${activeCount}`)

// 包含已删除的计数
const totalCount = await repo.count(true)
console.log(`总用户数（含已删除）: ${totalCount}`)
```

### QueryBuilder 计数

```typescript
// 默认计数
const qb1 = new QueryBuilder('User')
const count1 = await new QueryExecutor(qb1).count()

// 包含已删除
const qb2 = new QueryBuilder('User').withDeleted()
const count2 = await new QueryExecutor(qb2).count()

// 仅已删除
const qb3 = new QueryBuilder('User').onlyDeleted()
const count3 = await new QueryExecutor(qb3).count()
```

---

## 软删除与分页

分页查询同样遵循软删除过滤规则：

```typescript
import { Repository, QueryBuilder, QueryExecutor, ConditionOperator } from '@aspect/ocorm'

const repo = new Repository('User')

// 默认分页（不含已删除）
const page = await repo.findPaginated(1, 10)
console.log(`当前页数据: ${page.data.length}`)
console.log(`总记录数: ${page.total}`)

// QueryBuilder 分页
const qb = new QueryBuilder('User')
  .where('status', ConditionOperator.EQUAL, 1)
  .orderBy('createdAt', 'DESC')
  .paginate(1, 10)

const result = await new QueryExecutor(qb).getPaginated()

// 分页结果中的 total 不包含已删除记录
```

---

## 完整示例

### 用户管理（带软删除）

```typescript
import {
  defineEntity,
  ColumnType,
  Repository,
  EntityData,
  QueryBuilder,
  QueryExecutor,
  ConditionOperator
} from '@aspect/ocorm'

// 1. 定义带软删除的实体
defineEntity('User', {
  tableName: 'users',
  columns: [
    { property: 'id', primaryKey: true, autoIncrement: true },
    { property: 'name', type: ColumnType.TEXT, nullable: false },
    { property: 'email', type: ColumnType.TEXT, nullable: false },
    { property: 'status', type: ColumnType.INTEGER, defaultValue: 1 },
    { property: 'createdAt', name: 'created_at', type: ColumnType.INTEGER },
    { property: 'updatedAt', name: 'updated_at', type: ColumnType.INTEGER }
  ],
  softDelete: {
    propertyName: 'deletedAt',
    columnName: 'deleted_at'
  }
})

// 2. 用户服务
class UserService {
  private repo = new Repository('User')
  
  // 创建用户
  async createUser(name: string, email: string): Promise<number> {
    const user = new EntityData('User')
    user.addProperty('name', name, 'string')
    user.addProperty('email', email, 'string')
    user.addProperty('createdAt', Date.now(), 'number')
    
    const result = await this.repo.save(user)
    return result.insertId
  }
  
  // 获取活跃用户列表
  async getActiveUsers(): Promise<EntityData[]> {
    const qb = new QueryBuilder('User')
      .where('status', ConditionOperator.EQUAL, 1)
      .orderBy('createdAt', 'DESC')
    
    return await new QueryExecutor(qb).get()
  }
  
  // 软删除用户
  async deleteUser(userId: number): Promise<boolean> {
    const result = await this.repo.removeById(userId)
    return result.success
  }
  
  // 获取回收站用户
  async getDeletedUsers(): Promise<EntityData[]> {
    const qb = new QueryBuilder('User')
      .onlyDeleted()
      .orderBy('deletedAt', 'DESC')
    
    return await new QueryExecutor(qb).get()
  }
  
  // 恢复用户
  async restoreUser(userId: number): Promise<boolean> {
    const result = await this.repo.restore(userId)
    return result.success
  }
  
  // 永久删除用户
  async permanentlyDeleteUser(userId: number): Promise<boolean> {
    const result = await this.repo.forceRemoveById(userId)
    return result.success
  }
  
  // 获取用户统计
  async getUserStats(): Promise<{active: number, deleted: number, total: number}> {
    const active = await this.repo.count()
    const total = await this.repo.count(true)
    const deleted = total - active
    
    return { active, deleted, total }
  }
}

// 3. 使用示例
async function example() {
  const userService = new UserService()
  
  // 创建用户
  const userId = await userService.createUser('张三', 'zhangsan@example.com')
  console.log(`创建用户: ${userId}`)
  
  // 获取活跃用户
  const activeUsers = await userService.getActiveUsers()
  console.log(`活跃用户数: ${activeUsers.length}`)
  
  // 软删除用户
  await userService.deleteUser(userId)
  console.log('用户已软删除')
  
  // 查看回收站
  const deletedUsers = await userService.getDeletedUsers()
  console.log(`回收站用户数: ${deletedUsers.length}`)
  
  // 恢复用户
  await userService.restoreUser(userId)
  console.log('用户已恢复')
  
  // 查看统计
  const stats = await userService.getUserStats()
  console.log(`用户统计: 活跃=${stats.active}, 已删除=${stats.deleted}, 总计=${stats.total}`)
}
```

---

## 注意事项

1. **数据库字段**：需要在数据库表中创建 `deleted_at` 列（INTEGER 类型，存储时间戳）
2. **索引优化**：建议在 `deleted_at` 列上创建索引，提高查询性能
3. **唯一约束**：软删除后，唯一约束仍然生效，可能需要调整约束策略
4. **级联删除**：关联关系的级联删除会执行软删除，需注意数据一致性
5. **定期清理**：建议定期清理长期未恢复的软删除数据，释放存储空间
6. **审计需求**：软删除适合有审计需求的场景，保留数据变更历史
