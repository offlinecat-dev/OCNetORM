# 列类型与选项

本文档详细介绍 OCORM 支持的列类型、列选项配置以及主键定义方式。

---

## ColumnType 列类型枚举

OCORM 支持 SQLite 的四种基本数据类型：

```typescript
import { ColumnType } from '@aspect/ocorm'

enum ColumnType {
  TEXT = 'TEXT',       // 文本类型
  INTEGER = 'INTEGER', // 整数类型
  REAL = 'REAL',       // 浮点数类型
  BLOB = 'BLOB'        // 二进制类型
}
```

### 类型映射关系

| ColumnType | SQLite 类型 | ArkTS 类型 | 说明 |
|------------|-------------|------------|------|
| `TEXT` | TEXT | string | 字符串、JSON 序列化数据 |
| `INTEGER` | INTEGER | number | 整数、布尔值(0/1)、时间戳 |
| `REAL` | REAL | number | 浮点数 |
| `BLOB` | BLOB | Uint8Array | 二进制数据 |

### 类型自动推断

使用 `inferColumnType` 函数可根据 ArkTS 类型名推断数据库列类型：

```typescript
import { inferColumnType } from '@aspect/ocorm'

inferColumnType('string')   // ColumnType.TEXT
inferColumnType('number')   // ColumnType.REAL
inferColumnType('boolean')  // ColumnType.INTEGER (0/1)
inferColumnType('Date')     // ColumnType.INTEGER (时间戳)
inferColumnType('object')   // ColumnType.TEXT (JSON 序列化)
```

### 使用示例

```typescript
import { defineEntity, ColumnType } from '@aspect/ocorm'

defineEntity('Product', {
  tableName: 'products',
  columns: [
    { property: 'id', primaryKey: true },
    { property: 'name', type: ColumnType.TEXT },           // 字符串
    { property: 'price', type: ColumnType.REAL },          // 浮点数
    { property: 'stock', type: ColumnType.INTEGER },       // 整数
    { property: 'isActive', type: ColumnType.INTEGER },    // 布尔值存为 0/1
    { property: 'createdAt', type: ColumnType.INTEGER },   // 时间戳
    { property: 'metadata', type: ColumnType.TEXT },       // JSON 字符串
    { property: 'image', type: ColumnType.BLOB }           // 二进制数据
  ]
})
```

---

## ColumnOptions 列选项

### ColumnOptions 类

```typescript
class ColumnOptions {
  name: string = ''                      // 数据库列名
  type: ColumnType = ColumnType.TEXT     // 列类型
  nullable: boolean = true               // 是否允许为空
  unique: boolean = false                // 是否唯一
  defaultValue: string | number | null = null  // 默认值
  length: number = 0                     // TEXT 最大长度（0=无限制）
}
```

### 选项说明

| 选项 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `name` | string | 属性名 | 数据库中的列名 |
| `type` | ColumnType | TEXT | 数据库列类型 |
| `nullable` | boolean | true | 是否允许 NULL 值 |
| `unique` | boolean | false | 是否添加唯一约束 |
| `defaultValue` | string/number/null | null | 列默认值 |
| `length` | number | 0 | TEXT 类型最大长度 |

### 创建列选项

```typescript
import { createColumnOptions, ColumnType } from '@aspect/ocorm'

const options = createColumnOptions()
options.name = 'user_email'
options.type = ColumnType.TEXT
options.nullable = false
options.unique = true
```

### 在 defineEntity 中使用

```typescript
defineEntity('User', {
  columns: [
    { property: 'id', primaryKey: true },
    
    // 必填且唯一
    { 
      property: 'email', 
      type: ColumnType.TEXT, 
      nullable: false, 
      unique: true 
    },
    
    // 自定义列名
    { 
      property: 'userName', 
      name: 'user_name', 
      type: ColumnType.TEXT 
    },
    
    // 带默认值
    { 
      property: 'status', 
      type: ColumnType.INTEGER, 
      defaultValue: 1 
    },
    
    // 限制长度
    { 
      property: 'nickname', 
      type: ColumnType.TEXT, 
      length: 50 
    }
  ]
})
```

---

## 主键定义

### 自增主键（推荐）

```typescript
// 方式1：defineEntity
defineEntity('User', {
  columns: [
    { property: 'id', primaryKey: true }  // 默认自增
    // 或显式指定
    { property: 'id', primaryKey: true, autoIncrement: true }
  ]
})

// 方式2：registerAutoIncrementPrimaryKey
import { registerAutoIncrementPrimaryKey } from '@aspect/ocorm'
registerAutoIncrementPrimaryKey('User', 'id')
registerAutoIncrementPrimaryKey('User', 'id', 'user_id')  // 指定列名
```

### 非自增主键

```typescript
// 方式1：defineEntity
defineEntity('Config', {
  columns: [
    { property: 'key', primaryKey: true, autoIncrement: false }
  ]
})

// 方式2：registerPrimaryKey
import { registerPrimaryKey } from '@aspect/ocorm'
registerPrimaryKey('Config', 'key')
registerPrimaryKey('Config', 'key', 'config_key')  // 指定列名
```

### 主键特性

- 主键列类型固定为 `INTEGER`
- 主键列 `nullable` 固定为 `false`
- 自增主键在插入时无需指定值，数据库自动分配
- 非自增主键需要在插入时手动指定值

---

## ColumnMetadata 列元数据

`ColumnMetadata` 类存储单个列的完整映射信息。

### 属性

```typescript
class ColumnMetadata {
  propertyName: string     // ArkTS 属性名
  columnName: string       // 数据库列名
  columnType: ColumnType   // 列类型
  isPrimaryKey: boolean    // 是否主键
  isAutoIncrement: boolean // 是否自增
  isNullable: boolean      // 是否可空
  isUnique: boolean        // 是否唯一
  defaultValue: string | number | null  // 默认值
  length: number           // TEXT 长度限制
}
```

### 链式设置方法

```typescript
import { ColumnMetadata, ColumnType } from '@aspect/ocorm'

const column = new ColumnMetadata('email', 'user_email')
  .setType(ColumnType.TEXT)
  .setNullable(false)
  .setUnique(true)
  .setDefaultValue(null)
  .setLength(255)
```

### 获取列元数据

```typescript
import { MetadataStorage } from '@aspect/ocorm'

const storage = MetadataStorage.getInstance()
const metadata = storage.getEntityMetadata('User')

if (metadata) {
  // 通过属性名查找
  const emailColumn = metadata.getColumnByProperty('email')
  console.log(emailColumn?.columnName)  // 'user_email'
  
  // 通过列名查找
  const column = metadata.getColumnByName('user_email')
  console.log(column?.propertyName)  // 'email'
  
  // 获取主键列
  const pk = metadata.getPrimaryKeyColumn()
  console.log(pk?.propertyName)  // 'id'
}
```

---

## 特殊列装饰器

### @PrimaryKey - 主键

```typescript
import { PrimaryKey } from '@aspect/ocorm'

@PrimaryKey()  // 默认自增
id: number = 0

@PrimaryKey({ autoIncrement: false })  // 非自增
key: string = ''

@PrimaryKey({ name: 'user_id' })  // 自定义列名
id: number = 0
```

### @CreatedAt - 创建时间

```typescript
import { CreatedAt } from '@aspect/ocorm'

@CreatedAt()  // 默认列名 created_at，类型 INTEGER
createdAt: number = 0

@CreatedAt({ name: 'create_time' })  // 自定义列名
createdAt: number = 0
```

### @UpdatedAt - 更新时间

```typescript
import { UpdatedAt } from '@aspect/ocorm'

@UpdatedAt()  // 默认列名 updated_at，类型 INTEGER
updatedAt: number = 0
```

### @SoftDelete - 软删除时间

```typescript
import { SoftDelete } from '@aspect/ocorm'

@SoftDelete()  // 默认列名 deleted_at，类型 INTEGER，nullable=true
deletedAt: number | null = null

@SoftDelete({ name: 'deleted_time' })  // 自定义列名
deletedAt: number | null = null
```

---

## 常见列定义模式

### 用户表

```typescript
defineEntity('User', {
  tableName: 'users',
  columns: [
    { property: 'id', primaryKey: true },
    { property: 'username', type: ColumnType.TEXT, nullable: false, unique: true },
    { property: 'email', type: ColumnType.TEXT, nullable: false, unique: true },
    { property: 'password', name: 'password_hash', type: ColumnType.TEXT },
    { property: 'avatar', type: ColumnType.TEXT, nullable: true },
    { property: 'status', type: ColumnType.INTEGER, defaultValue: 1 },
    { property: 'createdAt', name: 'created_at', type: ColumnType.INTEGER },
    { property: 'updatedAt', name: 'updated_at', type: ColumnType.INTEGER }
  ]
})
```

### 文章表（带软删除）

```typescript
defineEntity('Article', {
  tableName: 'articles',
  columns: [
    { property: 'id', primaryKey: true },
    { property: 'title', type: ColumnType.TEXT, nullable: false, length: 200 },
    { property: 'content', type: ColumnType.TEXT },
    { property: 'authorId', name: 'author_id', type: ColumnType.INTEGER },
    { property: 'viewCount', name: 'view_count', type: ColumnType.INTEGER, defaultValue: 0 },
    { property: 'isPublished', name: 'is_published', type: ColumnType.INTEGER, defaultValue: 0 },
    { property: 'createdAt', name: 'created_at', type: ColumnType.INTEGER },
    { property: 'updatedAt', name: 'updated_at', type: ColumnType.INTEGER }
  ],
  softDelete: true
})
```

### 配置表（非自增主键）

```typescript
defineEntity('AppConfig', {
  tableName: 'app_configs',
  columns: [
    { property: 'key', name: 'config_key', primaryKey: true, autoIncrement: false },
    { property: 'value', name: 'config_value', type: ColumnType.TEXT },
    { property: 'description', type: ColumnType.TEXT, nullable: true },
    { property: 'updatedAt', name: 'updated_at', type: ColumnType.INTEGER }
  ]
})
```
