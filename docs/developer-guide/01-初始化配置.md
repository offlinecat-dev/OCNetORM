# 初始化配置
 
OCORM 提供了简洁的统一初始化入口，支持数据库连接、自动建表、自动迁移等功能。
 
---
 
## 快速开始
 
```typescript
import { OCORMInit, DatabaseConfig } from '@offlinecat/ocorm'
 
// 在 EntryAbility 的 onCreate 中初始化
async onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): Promise<void> {
  const config = new DatabaseConfig('myapp.db')
  await OCORMInit(this.context, { config })
}
```
 
---
 
## DatabaseConfig 配置类
 
`DatabaseConfig` 用于配置数据库连接参数。
 
### 构造函数
 
```typescript
new DatabaseConfig(
  name: string,                              // 数据库名称（必填）
  securityLevel?: relationalStore.SecurityLevel,  // 安全级别，默认 S1
  encrypt?: boolean,                         // 是否加密，默认 false
  enableLogger?: boolean,                    // 是否启用日志，默认 false
  loggerLevel?: LogLevel                     // 日志级别，默认 INFO
)
```
 
### 属性说明
 
| 属性 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `name` | string | - | 数据库文件名 |
| `securityLevel` | SecurityLevel | S1 | 安全级别 |
| `encrypt` | boolean | false | 是否加密存储 |
| `enableLogger` | boolean | false | 是否启用 SQL 日志 |
| `loggerLevel` | LogLevel | INFO | 日志级别 |
| `healthCheckIntervalMs` | number | 0 | 健康检查间隔（0=禁用） |
| `enableQueryCache` | boolean | false | 是否启用查询缓存 |
| `queryCacheMaxSize` | number | 100 | 缓存最大条目数 |
| `queryCacheTtlMs` | number | 60000 | 缓存过期时间（毫秒） |
 
### 链式配置方法
 
```typescript
const config = new DatabaseConfig('myapp.db')
  .setHealthCheckInterval(30000)           // 30秒健康检查
  .setQueryCache(true, 200, 120000)        // 启用缓存，200条，2分钟过期
```
 
### 完整配置示例
 
```typescript
import { DatabaseConfig, LogLevel } from '@offlinecat/ocorm'
import { relationalStore } from '@kit.ArkData'
 
const config = new DatabaseConfig(
  'myapp.db',
  relationalStore.SecurityLevel.S1,
  false,      // 不加密
  true,       // 启用日志
  LogLevel.DEBUG
)
config.setHealthCheckInterval(30000)
config.setQueryCache(true, 100, 60000)
```
 
---
 
## OCORMInit 初始化函数
 
`OCORMInit` 是 OCORM 的统一初始化入口，整合了数据库连接、建表、迁移等流程。
 
### 函数签名
 
```typescript
async function OCORMInit(
  context: Context,
  options: OCORMInitOptions
): Promise<CreateAllTablesResult | SchemaMigrationExecutionResult | null>
```
 
### OCORMInitOptions 选项
 
| 选项 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `config` | DatabaseConfig | - | **必填**，数据库配置 |
| `autoCreateTables` | boolean | true | 是否自动创建表 |
| `autoMigrate` | boolean | false | 是否启用自动迁移 |
| `autoMigrationOptions` | AutoMigrationOptions | - | 自动迁移选项 |
| `enableLogger` | boolean | 继承 config | 覆盖日志启用设置 |
| `logLevel` | LogLevel | 继承 config | 覆盖日志级别 |
| `databaseManager` | DatabaseManagerAdapter | - | 自定义数据库管理器（测试用） |
| `schemaBuilder` | SchemaBuilder | - | 自定义 Schema 构建器（测试用） |
| `migrationManager` | MigrationManager | - | 自定义迁移管理器（测试用） |
 
### 使用示例
 
#### 基础初始化（自动建表）
 
```typescript
import { OCORMInit, DatabaseConfig } from '@offlinecat/ocorm'
 
const config = new DatabaseConfig('myapp.db')
const result = await OCORMInit(this.context, { config })
 
if (result && result.success) {
  console.log(`成功创建 ${result.successCount} 张表`)
}
```
 
#### 禁用自动建表
 
```typescript
await OCORMInit(this.context, {
  config,
  autoCreateTables: false
})
```
 
#### 启用自动迁移
 
```typescript
await OCORMInit(this.context, {
  config,
  autoMigrate: true,
  autoMigrationOptions: {
    includeJoinTables: true
  }
})
```
 
#### 覆盖日志设置
 
```typescript
await OCORMInit(this.context, {
  config,
  enableLogger: true,
  logLevel: LogLevel.DEBUG
})
```
 
---
 
## OrmContext 上下文
 
`OrmContext` 是依赖注入容器，管理 ORM 核心组件的生命周期。通常用于测试场景。
 
### 获取实例
 
```typescript
import { OrmContext } from '@offlinecat/ocorm'
 
const context = OrmContext.getInstance()
```
 
### 配置注入（测试用）
 
```typescript
import { OrmContext, MetadataStorage, DatabaseManager, Logger, LogLevel } from '@offlinecat/ocorm'
 
OrmContext.configure({
  metadataStorage: MetadataStorage.getInstance(),
  databaseManager: DatabaseManager.getInstance(),
  logger: Logger.getInstance(),
  enableLogging: true,
  logLevel: LogLevel.DEBUG
})
```
 
### 获取组件
 
```typescript
const context = OrmContext.getInstance()
 
// 获取元数据存储
const metadataStorage = context.getMetadataStorage()
 
// 获取数据库管理器
const databaseManager = context.getDatabaseManager()
 
// 获取日志记录器
const logger = context.getLogger()
 
// 检查是否已配置
const configured = context.isConfigured()
```
 
### 重置（测试用）
 
```typescript
// 重置上下文状态
context.reset()
 
// 重置单例实例
OrmContext.resetInstance()
```
 
---
 
## DatabaseManager 数据库管理器
 
`DatabaseManager` 是单例类，负责管理 RdbStore 的生命周期。
 
### 获取实例
 
```typescript
import { DatabaseManager } from '@offlinecat/ocorm'
 
const dbManager = DatabaseManager.getInstance()
```
 
### 手动初始化
 
```typescript
await dbManager.initialize(context, config)
```
 
### 获取 RdbStore
 
```typescript
// 获取底层 RdbStore（需要先初始化）
const store = dbManager.getStore()
```
 
### 状态检查
 
```typescript
// 检查是否已初始化
const initialized = dbManager.isInitialized()
 
// 检查连接是否健康
const healthy = dbManager.isHealthy()
 
// 手动健康检查
const pingResult = await dbManager.ping()
 
// 获取当前配置
const currentConfig = dbManager.getConfig()
```
 
### 关闭连接
 
```typescript
await dbManager.close()
```
 
### 获取查询缓存
 
```typescript
const queryCache = dbManager.getQueryCache()
```
 
---
 
## 初始化流程图
 
```
OCORMInit()
    │
    ├─> DatabaseManager.initialize()  // 创建/打开数据库
    │
    ├─> Logger.configure()            // 配置日志
    │
    └─> 根据选项执行：
        ├─> autoMigrate=true  → MigrationManager.autoMigrateWithManager()
        ├─> autoCreateTables=true (默认) → SchemaBuilder.createAllTablesWithManager()
        └─> autoCreateTables=false → 返回 null
```
 
---
 
## 最佳实践
 
1. **在 EntryAbility.onCreate 中初始化** - 确保数据库在应用启动时就绑定好
2. **生产环境关闭 DEBUG 日志** - 避免性能损耗
3. **合理设置缓存参数** - 根据数据更新频率调整 TTL
4. **测试时使用依赖注入** - 通过 `OrmContext.configure()` 或 `OCORMInitOptions` 注入 Mock