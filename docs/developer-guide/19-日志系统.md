# 日志系统

OCORM 提供完善的 SQL 日志系统，基于 HarmonyOS 的 hilog 实现，支持多级别日志记录、敏感数据脱敏和耗时统计。

---

## Logger - 日志记录器

`Logger` 是单例类，负责记录 OCORM 的 SQL 执行日志。

### 获取实例

```typescript
import { Logger } from '@aspect/ocorm'

const logger = Logger.getInstance()
```

### 配置日志

```typescript
import { Logger, LogLevel } from '@aspect/ocorm'

const logger = Logger.getInstance()

// 配置日志系统
logger.configure(
  true,           // 是否启用日志
  LogLevel.DEBUG  // 日志级别
)

// 检查是否启用
console.log(logger.isEnabled())  // true

// 获取当前日志级别
console.log(logger.getLevel())   // LogLevel.DEBUG
```

### 在初始化时配置

```typescript
import { OCORMInit, DatabaseConfig, LogLevel } from '@aspect/ocorm'

// 方式一：通过 DatabaseConfig 配置
const config = new DatabaseConfig(
  'myapp.db',
  relationalStore.SecurityLevel.S1,
  false,      // 不加密
  true,       // 启用日志
  LogLevel.DEBUG
)

await OCORMInit(this.context, { config })

// 方式二：通过 OCORMInitOptions 覆盖
await OCORMInit(this.context, {
  config,
  enableLogger: true,
  logLevel: LogLevel.DEBUG
})
```

---

## LogLevel - 日志级别

```typescript
enum LogLevel {
  ERROR = 0,  // 仅记录错误日志
  INFO = 1,   // 记录错误和基本操作日志（事务）
  DEBUG = 2   // 记录所有日志包括详细 SQL
}
```

### 级别说明

| 级别 | 值 | 记录内容 | 适用场景 |
|------|-----|----------|----------|
| ERROR | 0 | 仅错误日志 | 生产环境 |
| INFO | 1 | 错误 + 事务操作 | 生产环境（需要监控） |
| DEBUG | 2 | 所有日志（含 SQL 详情） | 开发调试 |

### 日志级别选择

```typescript
import { LogLevel } from '@aspect/ocorm'

// 生产环境：仅记录错误
logger.configure(true, LogLevel.ERROR)

// 需要监控事务：INFO 级别
logger.configure(true, LogLevel.INFO)

// 开发调试：DEBUG 级别
logger.configure(true, LogLevel.DEBUG)
```

---

## 日志方法

### logQuery - 查询日志

记录 SQL 查询语句和执行耗时（仅 DEBUG 级别）：

```typescript
const logger = Logger.getInstance()

// 记录查询日志
logger.logQuery('SELECT * FROM users WHERE id = 1', 15)
// 输出: [OCORM][QUERY][15ms] SELECT * FROM users WHERE id = [***]

// 敏感数据会自动脱敏
logger.logQuery("SELECT * FROM users WHERE name = '张三'", 10)
// 输出: [OCORM][QUERY][10ms] SELECT * FROM users WHERE name = '[***]'
```

### logTransaction - 事务日志

记录事务操作（INFO 及以上级别）：

```typescript
logger.logTransaction('BEGIN')    // [OCORM][TRANSACTION][-] BEGIN
logger.logTransaction('COMMIT')   // [OCORM][TRANSACTION][-] COMMIT
logger.logTransaction('ROLLBACK') // [OCORM][TRANSACTION][-] ROLLBACK
```

### logError - 错误日志

记录错误信息（所有级别）：

```typescript
logger.logError('数据库连接失败: Connection refused')
// 输出: [OCORM][ERROR][-] 数据库连接失败: Connection refused
```

### logDebug - 调试日志

记录调试信息（仅 DEBUG 级别）：

```typescript
logger.logDebug('开始加载用户关联数据')
// 输出: [OCORM][DEBUG][-] 开始加载用户关联数据
```

### logInfo - 信息日志

记录一般信息（INFO 及以上级别）：

```typescript
logger.logInfo('数据库初始化完成')
// 输出: [OCORM][INFO][-] 数据库初始化完成
```

---

## 专用日志方法

### logTaskPool - TaskPool 任务日志

记录 TaskPool 任务执行情况（仅 DEBUG 级别）：

```typescript
logger.logTaskPool(
  'DataMapping',  // 任务名称
  25,             // 执行耗时（毫秒）
  100,            // 处理的数据量
  true            // 是否使用了 TaskPool
)
// 输出: [OCORM][TASKPOOL][25ms] DataMapping - 数据量: 100, 线程: TaskPool

// 降级到主线程时
logger.logTaskPool('DataMapping', 30, 100, false)
// 输出: [OCORM][TASKPOOL][30ms] DataMapping - 数据量: 100, 线程: 主线程(降级)
```

### logPagination - 分页查询日志

记录分页查询信息（仅 DEBUG 级别）：

```typescript
logger.logPagination(
  1,    // 当前页码
  20,   // 每页数量
  100,  // 总记录数
  35    // 查询耗时（毫秒）
)
// 输出: [OCORM][PAGINATION][35ms] 页码: 1/5, 每页: 20, 总数: 100
```

### logParallelRelation - 并行关联加载日志

记录并行关联加载情况（仅 DEBUG 级别）：

```typescript
logger.logParallelRelation(
  ['posts', 'comments', 'likes'],  // 关联名称数组
  50,                               // 总耗时（毫秒）
  3                                 // 成功加载的数量
)
// 输出: [OCORM][PARALLEL_RELATION][50ms] 关联: [posts, comments, likes], 成功: 3/3
```

### logBatchInsert - 批量插入日志

记录批量插入操作（仅 DEBUG 级别）：

```typescript
logger.logBatchInsert(
  'users',   // 表名
  100,       // 总数据量
  100,       // 成功插入数量
  120,       // 执行耗时（毫秒）
  true       // 是否使用事务
)
// 输出: [OCORM][BATCH_INSERT][120ms] 表: users, 插入: 100/100, 模式: 事务模式
```

---

## 敏感数据脱敏

Logger 自动对 SQL 日志中的敏感数据进行脱敏处理：

### 脱敏规则

1. **字符串值** - 引号内的内容替换为 `[***]`
2. **长数字** - 超过 6 位的连续数字替换为 `[***]`（可能是手机号、身份证等）

### 脱敏示例

```typescript
// 原始 SQL
"SELECT * FROM users WHERE name = '张三' AND phone = '13800138000'"

// 脱敏后
"SELECT * FROM users WHERE name = '[***]' AND phone = '[***]'"

// 原始 SQL（数字脱敏）
"SELECT * FROM users WHERE id_card = 110101199001011234"

// 脱敏后
"SELECT * FROM users WHERE id_card = [***]"
```

### 错误日志脱敏

错误日志也会进行敏感数据脱敏：

```typescript
logger.logError("插入失败: name='张三', phone='13800138000'")
// 输出: [OCORM][ERROR][-] 插入失败: name='[***]', phone='[***]'
```

---

## 日志历史（测试用）

Logger 支持记录日志历史，便于测试验证：

```typescript
const logger = Logger.getInstance()

// 启用日志历史记录
logger.setRecordHistory(true)

// 执行一些操作...
logger.logQuery('SELECT * FROM users', 10)
logger.logTransaction('BEGIN')

// 获取日志历史
const history = logger.getLogHistory()
console.log(history)
// [
//   '[OCORM][QUERY][10ms] SELECT * FROM users',
//   '[OCORM][TRANSACTION][-] BEGIN'
// ]

// 清空日志历史
logger.clearLogHistory()

// 禁用日志历史记录
logger.setRecordHistory(false)
```

---

## 日志格式

所有日志遵循统一格式：

```
[OCORM][类型][耗时] 消息内容
```

### 格式说明

| 部分 | 说明 | 示例 |
|------|------|------|
| `[OCORM]` | 固定前缀，标识 OCORM 日志 | `[OCORM]` |
| `[类型]` | 日志类型 | `[QUERY]`, `[TRANSACTION]`, `[ERROR]` |
| `[耗时]` | 执行耗时（毫秒），无耗时显示 `-` | `[15ms]`, `[-]` |
| 消息内容 | 具体日志内容 | SQL 语句、错误信息等 |

### 日志类型

| 类型 | 说明 |
|------|------|
| QUERY | SQL 查询 |
| TRANSACTION | 事务操作 |
| ERROR | 错误信息 |
| DEBUG | 调试信息 |
| INFO | 一般信息 |
| TASKPOOL | TaskPool 任务 |
| PAGINATION | 分页查询 |
| PARALLEL_RELATION | 并行关联加载 |
| BATCH_INSERT | 批量插入 |

---

## 日志长度限制

为避免日志过长，消息内容超过 512 字符时会被截断：

```typescript
// 超长消息会被截断
logger.logDebug('非常长的消息...(超过512字符)...')
// 输出: [OCORM][DEBUG][-] 非常长的消息...(前512字符)...
```

---

## 完整示例

### 开发环境配置

```typescript
// EntryAbility.ets
import { OCORMInit, DatabaseConfig, LogLevel } from '@aspect/ocorm'

export default class EntryAbility extends UIAbility {
  async onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): Promise<void> {
    const config = new DatabaseConfig('myapp.db')
    
    await OCORMInit(this.context, {
      config,
      enableLogger: true,
      logLevel: LogLevel.DEBUG  // 开发环境使用 DEBUG
    })
  }
}
```

### 生产环境配置

```typescript
// EntryAbility.ets
import { OCORMInit, DatabaseConfig, LogLevel } from '@aspect/ocorm'

export default class EntryAbility extends UIAbility {
  async onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): Promise<void> {
    const config = new DatabaseConfig('myapp.db')
    
    await OCORMInit(this.context, {
      config,
      enableLogger: true,
      logLevel: LogLevel.ERROR  // 生产环境仅记录错误
    })
  }
}
```

### 手动记录业务日志

```typescript
import { Logger, LogLevel } from '@aspect/ocorm'

async function importUsers(data: Array<UserData>): Promise<void> {
  const logger = Logger.getInstance()
  
  logger.logInfo(`开始导入 ${data.length} 条用户数据`)
  
  const startTime = Date.now()
  try {
    // 执行导入逻辑...
    const repo = new Repository('User')
    let successCount = 0
    
    for (const item of data) {
      await repo.save(createEntityData(item))
      successCount++
    }
    
    const duration = Date.now() - startTime
    logger.logInfo(`导入完成: ${successCount}/${data.length}, 耗时 ${duration}ms`)
  } catch (error) {
    logger.logError(`导入失败: ${error.message}`)
    throw error
  }
}
```

---

## 最佳实践

1. **生产环境关闭 DEBUG 日志** - 避免性能损耗和敏感数据泄露风险
2. **使用适当的日志级别** - 错误用 `logError`，调试用 `logDebug`
3. **不要记录敏感数据** - 虽然有自动脱敏，但最好从源头避免
4. **监控关键操作** - 使用 INFO 级别记录重要的业务操作
5. **测试时启用历史记录** - 便于验证日志输出
