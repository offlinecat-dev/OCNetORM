# 生命周期钩子

生命周期钩子（Lifecycle Hooks）允许在实体数据操作的关键节点执行自定义逻辑，如数据验证、自动填充字段、审计日志等。

---

## 钩子类型

OCORM 支持以下生命周期钩子：

| 钩子 | 触发时机 | 典型用途 |
|------|----------|----------|
| `beforeSave` | 保存（插入/更新）之前 | 数据验证、自动填充、格式化 |
| `afterLoad` | 从数据库加载之后 | 数据转换、计算属性、解密 |
| `beforeDelete` | 删除之前 | 权限检查、关联清理、审计 |

---

## 钩子配置

### 通过元数据配置钩子

```typescript
import { defineEntity, ColumnType, EntityData, MetadataStorage, EntityHooks } from '@aspect/ocorm'

defineEntity('User', {
  tableName: 'users',
  columns: [
    { property: 'id', primaryKey: true, autoIncrement: true },
    { property: 'name', type: ColumnType.TEXT },
    { property: 'email', type: ColumnType.TEXT },
    { property: 'createdAt', name: 'created_at', type: ColumnType.INTEGER },
    { property: 'updatedAt', name: 'updated_at', type: ColumnType.INTEGER }
  ]
})

// 配置生命周期钩子（通过元数据设置）
const metadata = MetadataStorage.getInstance().getEntityMetadata('User')
if (metadata !== null) {
  const hooks = new EntityHooks()
  hooks.beforeSave = (data: EntityData) => {
    // 保存前自动设置更新时间
    data.setPropertyValue('updatedAt', Date.now())
  }
  hooks.afterLoad = (data: EntityData) => {
    // 加载后的数据处理
    console.log(`加载了用户: ${data.getPropertyValue('name')}`)
  }
  hooks.beforeDelete = (data: EntityData) => {
    // 删除前的检查
    console.log(`即将删除用户: ${data.getPropertyValue('id')}`)
  }
  metadata.setHooks(hooks)
}
```

### EntityHooks 类型

```typescript
import { EntityData, HookCallback, EntityHooks } from '@aspect/ocorm'

// HookCallback: (data: EntityData) => void | Promise<void>

// EntityHooks 支持两种用法：
// 1) 先 new 再赋值
const hooks1 = new EntityHooks()
hooks1.beforeSave = (data: EntityData) => {
  data.setPropertyValue('updatedAt', Date.now())
}

// 2) 使用构造函数参数初始化（beforeSave / afterLoad / beforeDelete）
const hooks2 = new EntityHooks(
  (data: EntityData) => {
    data.setPropertyValue('updatedAt', Date.now())
  },
  null,
  null
)
```

---

## beforeSave 钩子

### 基本用法

在保存实体数据到数据库之前执行：

```typescript
import { defineEntity, ColumnType, EntityData, MetadataStorage, EntityHooks } from '@aspect/ocorm'

defineEntity('Article', {
  tableName: 'articles',
  columns: [
    { property: 'id', primaryKey: true, autoIncrement: true },
    { property: 'title', type: ColumnType.TEXT },
    { property: 'content', type: ColumnType.TEXT },
    { property: 'slug', type: ColumnType.TEXT },
    { property: 'createdAt', name: 'created_at', type: ColumnType.INTEGER },
    { property: 'updatedAt', name: 'updated_at', type: ColumnType.INTEGER }
  ]
})

const metadata = MetadataStorage.getInstance().getEntityMetadata('Article')
if (metadata !== null) {
  const hooks = new EntityHooks()
  hooks.beforeSave = (data: EntityData) => {
    const now = Date.now()
    
    // 设置更新时间
    data.setPropertyValue('updatedAt', now)
    
    // 如果是新记录，设置创建时间
    if (!data.hasProperty('id') || data.getPropertyValue('id') === null) {
      data.setPropertyValue('createdAt', now)
    }
    
    // 自动生成 slug
    const title = data.getPropertyValue('title') as string
    if (title && !data.getPropertyValue('slug')) {
      const slug = title.toLowerCase().replace(/\s+/g, '-')
      data.setPropertyValue('slug', slug)
    }
  }
  metadata.setHooks(hooks)
}
```

### 异步钩子

钩子支持异步操作：

```typescript
const hooks = new EntityHooks()
hooks.beforeSave = async (data: EntityData) => {
  // 异步验证
  const email = data.getPropertyValue('email') as string
  const isValid = await validateEmailAsync(email)
  
  if (!isValid) {
    throw new Error('邮箱地址无效')
  }
}
```

### 使用场景

- **自动时间戳**：自动设置 createdAt、updatedAt
- **数据格式化**：统一数据格式（如邮箱小写、去除空格）
- **数据验证**：自定义验证逻辑
- **默认值填充**：根据业务规则设置默认值
- **数据加密**：敏感数据加密后存储

---

## afterLoad 钩子

### 基本用法

在从数据库加载实体数据之后执行：

```typescript
import { defineEntity, ColumnType, EntityData, MetadataStorage, EntityHooks } from '@aspect/ocorm'

defineEntity('User', {
  tableName: 'users',
  columns: [
    { property: 'id', primaryKey: true, autoIncrement: true },
    { property: 'name', type: ColumnType.TEXT },
    { property: 'settings', type: ColumnType.TEXT }  // JSON 字符串
  ]
})

const metadata = MetadataStorage.getInstance().getEntityMetadata('User')
if (metadata !== null) {
  const hooks = new EntityHooks()
  hooks.afterLoad = (data: EntityData) => {
    // 将 JSON 字符串解析为对象
    const settingsStr = data.getPropertyValue('settings') as string
    if (settingsStr) {
      try {
        const settings = JSON.parse(settingsStr)
        data.setPropertyValue('settingsObj', settings)
      } catch (e) {
        data.setPropertyValue('settingsObj', {})
      }
    }
  }
  metadata.setHooks(hooks)
}
```

### 批量加载

afterLoad 钩子会为每条加载的记录执行：

```typescript
// 查询多条记录
const users = await repo.findAll()

// afterLoad 钩子为每条记录执行
// 内部调用：HooksProcessor.executeAfterLoadBatch(entityName, users)
```

### 使用场景

- **数据解密**：解密敏感字段
- **JSON 解析**：将 JSON 字符串转为对象
- **计算属性**：添加派生属性
- **格式转换**：日期格式化、数值格式化
- **审计日志**：记录数据访问

---

## beforeDelete 钩子

### 基本用法

在删除实体数据之前执行：

```typescript
import { defineEntity, ColumnType, EntityData, MetadataStorage, EntityHooks } from '@aspect/ocorm'

defineEntity('User', {
  tableName: 'users',
  columns: [
    { property: 'id', primaryKey: true, autoIncrement: true },
    { property: 'name', type: ColumnType.TEXT },
    { property: 'role', type: ColumnType.TEXT }
  ]
})

const metadata = MetadataStorage.getInstance().getEntityMetadata('User')
if (metadata !== null) {
  const hooks = new EntityHooks()
  hooks.beforeDelete = (data: EntityData) => {
    // 检查是否为管理员
    const role = data.getPropertyValue('role') as string
    if (role === 'admin') {
      throw new Error('不能删除管理员账户')
    }
    
    // 记录删除日志
    console.log(`用户 ${data.getPropertyValue('name')} 即将被删除`)
  }
  metadata.setHooks(hooks)
}
```

### 使用场景

- **权限检查**：验证是否有权删除
- **业务规则**：检查是否满足删除条件
- **关联清理**：清理关联数据
- **审计日志**：记录删除操作
- **数据备份**：删除前备份数据

---

## HooksProcessor

`HooksProcessor` 是 OCORM 的钩子处理器，负责管理和执行实体生命周期钩子。

### 获取实例

```typescript
import { HooksProcessor } from '@aspect/ocorm'

const processor = HooksProcessor.getInstance()
```

### 检查钩子配置

```typescript
// 检查是否有 beforeSave 钩子
const hasBeforeSave = processor.hasBeforeSaveHook('User')

// 检查是否有 afterLoad 钩子
const hasAfterLoad = processor.hasAfterLoadHook('User')

// 检查是否有 beforeDelete 钩子
const hasBeforeDelete = processor.hasBeforeDeleteHook('User')

// 检查是否有任何钩子
const hasAny = processor.hasAnyHook('User')
```

### 手动执行钩子

```typescript
const processor = HooksProcessor.getInstance()

// 执行 beforeSave 钩子
await processor.executeBeforeSave('User', entityData)

// 执行 afterLoad 钩子
await processor.executeAfterLoad('User', entityData)

// 批量执行 afterLoad 钩子
await processor.executeAfterLoadBatch('User', entityDataList)

// 执行 beforeDelete 钩子
await processor.executeBeforeDelete('User', entityData)
```

---

## 钩子执行流程

### 保存操作流程

```
Repository.save(entity)
    │
    ▼
┌───────────────────┐
│  beforeSave 钩子  │  ← 数据验证、自动填充
└───────────────────┘
    │
    ▼
┌───────────────────┐
│   数据库操作      │  ← INSERT 或 UPDATE
└───────────────────┘
    │
    ▼
   返回结果
```

### 查询操作流程

```
Repository.findById(id)
    │
    ▼
┌───────────────────┐
│   数据库查询      │  ← SELECT
└───────────────────┘
    │
    ▼
┌───────────────────┐
│  afterLoad 钩子   │  ← 数据转换、解密
└───────────────────┘
    │
    ▼
   返回实体
```

### 删除操作流程

```
Repository.remove(entity)
    │
    ▼
┌───────────────────┐
│ beforeDelete 钩子 │  ← 权限检查、审计
└───────────────────┘
    │
    ▼
┌───────────────────┐
│   数据库操作      │  ← DELETE 或 软删除
└───────────────────┘
    │
    ▼
   返回结果
```

---

## 错误处理

### HookExecutionError

钩子执行失败时会抛出 `HookExecutionError`：

```typescript
import { HookExecutionError } from '@aspect/ocorm'

try {
  await repo.save(userData)
} catch (error) {
  if (error instanceof HookExecutionError) {
    console.log(`钩子执行失败:`)
    console.log(`  实体: ${error.context.entityName}`)
    console.log(`  钩子: ${error.context.operation}`)
    console.log(`  原因: ${error.context.details}`)
  }
}
```

### 钩子中抛出错误

在钩子中抛出错误会中断操作：

```typescript
const hooks = new EntityHooks()
hooks.beforeSave = (data: EntityData) => {
  const name = data.getPropertyValue('name') as string
  
  if (!name || name.trim().length === 0) {
    throw new Error('用户名不能为空')
  }
  
  if (name.length < 2) {
    throw new Error('用户名长度不能少于 2 个字符')
  }
}
```

---

## 完整示例

### 用户实体（带完整钩子）

```typescript
import {
  defineEntity,
  ColumnType,
  Repository,
  EntityData,
  HooksProcessor,
  MetadataStorage,
  EntityHooks
} from '@aspect/ocorm'

// 1. 定义带钩子的实体
defineEntity('User', {
  tableName: 'users',
  columns: [
    { property: 'id', primaryKey: true, autoIncrement: true },
    { property: 'name', type: ColumnType.TEXT, nullable: false },
    { property: 'email', type: ColumnType.TEXT, nullable: false },
    { property: 'password', type: ColumnType.TEXT },
    { property: 'role', type: ColumnType.TEXT, defaultValue: 'user' },
    { property: 'loginCount', name: 'login_count', type: ColumnType.INTEGER, defaultValue: 0 },
    { property: 'lastLoginAt', name: 'last_login_at', type: ColumnType.INTEGER },
    { property: 'createdAt', name: 'created_at', type: ColumnType.INTEGER },
    { property: 'updatedAt', name: 'updated_at', type: ColumnType.INTEGER }
  ]
})

const metadata = MetadataStorage.getInstance().getEntityMetadata('User')
if (metadata !== null) {
  const hooks = new EntityHooks()
  // 保存前处理
  hooks.beforeSave = (data: EntityData) => {
    const now = Date.now()
    
    // 自动设置时间戳
    data.setPropertyValue('updatedAt', now)
    
    // 新记录处理
    const id = data.getPropertyValue('id')
    if (id === null || id === undefined) {
      data.setPropertyValue('createdAt', now)
      data.setPropertyValue('loginCount', 0)
    }
    
    // 邮箱格式化（小写）
    const email = data.getPropertyValue('email') as string
    if (email) {
      data.setPropertyValue('email', email.toLowerCase().trim())
    }
    
    // 用户名格式化（去除首尾空格）
    const name = data.getPropertyValue('name') as string
    if (name) {
      data.setPropertyValue('name', name.trim())
    }
  }
  
  // 加载后处理
  hooks.afterLoad = (data: EntityData) => {
    // 添加计算属性：是否为管理员
    const role = data.getPropertyValue('role') as string
    data.setPropertyValue('isAdmin', role === 'admin')
    
    // 格式化最后登录时间
    const lastLoginAt = data.getPropertyValue('lastLoginAt') as number
    if (lastLoginAt) {
      const date = new Date(lastLoginAt)
      data.setPropertyValue('lastLoginFormatted', date.toLocaleString())
    }
  }
  
  // 删除前处理
  hooks.beforeDelete = (data: EntityData) => {
    const role = data.getPropertyValue('role') as string
    
    // 禁止删除管理员
    if (role === 'admin') {
      throw new Error('不允许删除管理员账户')
    }
    
    // 记录删除日志
    const name = data.getPropertyValue('name')
    const id = data.getPropertyValue('id')
    console.log(`[审计] 用户 ${name}(ID:${id}) 即将被删除`)
  }
  metadata.setHooks(hooks)
}

// 2. 使用示例
async function example() {
  const repo = new Repository('User')
  const processor = HooksProcessor.getInstance()
  
  // 检查钩子配置
  console.log('beforeSave 钩子:', processor.hasBeforeSaveHook('User'))
  console.log('afterLoad 钩子:', processor.hasAfterLoadHook('User'))
  console.log('beforeDelete 钩子:', processor.hasBeforeDeleteHook('User'))
  
  // 创建用户（会触发 beforeSave）
  const user = new EntityData('User')
  user.addProperty('name', '  张三  ', 'string')  // 会被自动 trim
  user.addProperty('email', 'ZhangSan@Example.COM', 'string')  // 会被转为小写
  user.addProperty('password', 'hashed_password', 'string')
  
  const result = await repo.save(user)
  console.log(`创建用户 ID: ${result.insertId}`)
  
  // 查询用户（会触发 afterLoad）
  const loaded = await repo.findById(result.insertId)
  if (loaded !== null) {
    console.log('用户名:', loaded.getPropertyValue('name'))
    console.log('邮箱:', loaded.getPropertyValue('email'))
    console.log('是否管理员:', loaded.getPropertyValue('isAdmin'))
  }
  
  // 尝试删除普通用户（会触发 beforeDelete）
  try {
    await repo.removeById(result.insertId)
    console.log('用户已删除')
  } catch (error) {
    console.log('删除失败:', error.message)
  }
}
```

### 文章实体（带审计钩子）

```typescript
import { defineEntity, ColumnType, EntityData, MetadataStorage, EntityHooks } from '@aspect/ocorm'

defineEntity('Article', {
  tableName: 'articles',
  columns: [
    { property: 'id', primaryKey: true, autoIncrement: true },
    { property: 'title', type: ColumnType.TEXT },
    { property: 'content', type: ColumnType.TEXT },
    { property: 'authorId', name: 'author_id', type: ColumnType.INTEGER },
    { property: 'status', type: ColumnType.TEXT, defaultValue: 'draft' },
    { property: 'viewCount', name: 'view_count', type: ColumnType.INTEGER, defaultValue: 0 },
    { property: 'createdAt', name: 'created_at', type: ColumnType.INTEGER },
    { property: 'updatedAt', name: 'updated_at', type: ColumnType.INTEGER },
    { property: 'publishedAt', name: 'published_at', type: ColumnType.INTEGER }
  ]
})

const metadata = MetadataStorage.getInstance().getEntityMetadata('Article')
if (metadata !== null) {
  const hooks = new EntityHooks()
  hooks.beforeSave = (data: EntityData) => {
    const now = Date.now()
    data.setPropertyValue('updatedAt', now)
    
    // 新文章设置创建时间
    if (!data.getPropertyValue('id')) {
      data.setPropertyValue('createdAt', now)
      data.setPropertyValue('viewCount', 0)
    }
    
    // 发布时设置发布时间
    const status = data.getPropertyValue('status') as string
    if (status === 'published' && !data.getPropertyValue('publishedAt')) {
      data.setPropertyValue('publishedAt', now)
    }
  }
  
  hooks.afterLoad = (data: EntityData) => {
    // 添加阅读时间估算（按中文 500 字/分钟）
    const content = data.getPropertyValue('content') as string
    if (content) {
      const readingTime = Math.ceil(content.length / 500)
      data.setPropertyValue('readingTimeMinutes', readingTime)
    }
  }
  
  hooks.beforeDelete = (data: EntityData) => {
    const status = data.getPropertyValue('status') as string
    
    // 已发布文章不能直接删除
    if (status === 'published') {
      throw new Error('已发布文章请先下架后再删除')
    }
  }
  metadata.setHooks(hooks)
}
```

---

## 注意事项

1. **执行顺序**：钩子按配置顺序执行，确保逻辑依赖正确
2. **异步处理**：异步钩子会等待完成后再继续，注意性能影响
3. **错误处理**：钩子中的错误会中断操作，确保错误信息清晰
4. **数据修改**：beforeSave 中的修改会反映到数据库，afterLoad 中的修改只影响内存对象
5. **性能考虑**：避免在钩子中执行耗时操作，特别是批量查询时的 afterLoad
6. **测试覆盖**：为钩子逻辑编写单元测试，确保行为符合预期
