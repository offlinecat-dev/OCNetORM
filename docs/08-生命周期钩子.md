# 生命周期钩子

本章节介绍 OCORM 的生命周期钩子功能，包括 beforeSave、afterLoad 和 beforeDelete 三种钩子，以及如何在实体操作中嵌入业务逻辑。

## 概述

生命周期钩子允许你在实体数据保存、加载、删除前后执行自定义逻辑，常用于：

- 自动填充时间戳
- 数据格式转换
- 数据校验
- 复杂业务逻辑

## 钩子类型

### 支持的钩子

| 钩子 | 触发时机 | 用途 |
|------|---------|------|
| `beforeSave` | 保存前（INSERT/UPDATE） | 数据校验、自动填充、格式转换 |
| `afterLoad` | 查询后 | 数据解析、计算字段、反序列化 |
| `beforeDelete` | 删除前 | 删除关联数据、记录日志 |

## 定义钩子

### 使用 EntityHooks 类

```typescript
import { EntityHooks } from 'ocorm'

const hooks = new EntityHooks(
  // beforeSave: 保存前自动填充时间戳
  (data) => {
    const now = Date.now()
    
    if (!data.getProperty('createdAt')) {
      data.setPropertyValue('createdAt', now)
    }
    data.setPropertyValue('updatedAt', now)
  },
  
  // afterLoad: 加载后解析 JSON 字段
  (data) => {
    const configStr = data.getProperty('config')?.value as string
    if (configStr) {
      try {
        const configObj = JSON.parse(configStr)
        data.setTransient('configObj', configObj)
      } catch (e) {
        console.warn('解析 config JSON 失败')
      }
    }
  },
  
  // beforeDelete: 删除前检查
  (data) => {
    const status = data.getProperty('status')?.value as number
    if (status === 0) {
      throw new Error('禁止删除已禁用的用户')
    }
  }
)
```

### 注册钩子到实体

```typescript
import {
  registerEntity,
  createEntityOptions,
  EntityHooks
} from 'ocorm'

const hooks = new EntityHooks(
  (data) => { /* beforeSave */ },
  (data) => { /* afterLoad */ },
  (data) => { /* beforeDelete */ }
)

registerEntity('User', createEntityOptions('users', true, hooks))
```

## 常用场景

### 自动填充时间戳

```typescript
// 创建时间戳钩子工厂函数
function createTimestampHooks(): EntityHooks {
  return new EntityHooks(
    // beforeSave
    (data) => {
      const now = Date.now()
      
      // 创建时填充 createdAt
      if (!data.getProperty('createdAt')) {
        data.setPropertyValue('createdAt', now)
      }
      
      // 每次保存都更新 updatedAt
      data.setPropertyValue('updatedAt', now)
    }
  )
}

// 注册到实体
registerEntity('User', createEntityOptions('users', createTimestampHooks()))
```

### JSON 字段序列化/反序列化

```typescript
// 配置文件钩子
function createConfigHooks(): EntityHooks {
  return new EntityHooks(
    // beforeSave: 对象序列化为 JSON 字符串
    (data) => {
      const configObj = data.getTransient('configObj')
      if (configObj) {
        data.setPropertyValue('config', JSON.stringify(configObj))
      }
    },
    
    // afterLoad: JSON 字符串解析为对象
    (data) => {
      const configStr = data.getProperty('config')?.value as string
      if (configStr) {
        try {
          const configObj = JSON.parse(configStr)
          data.setTransient('configObj', configObj)
        } catch (e) {
          data.setTransient('configObj', {})
        }
      } else {
        data.setTransient('configObj', {})
      }
    }
  )
}

// 使用示例
const user = await repo.findById(1)

// 获取解析后的配置对象
const config = user.getTransient('configObj') as UserConfig
config.theme = 'dark'

// 保存时自动序列化为 JSON
await repo.save(user)
```

### 数据校验

```typescript
// 用户数据校验钩子
function createUserValidationHooks(): EntityHooks {
  return new EntityHooks(
    // beforeSave: 校验数据
    (data) => {
      const name = data.getProperty('name')?.value as string
      const email = data.getProperty('email')?.value as string
      const age = data.getProperty('age')?.value as number
      
      // 校验姓名
      if (!name || name.trim().length === 0) {
        throw new Error('姓名不能为空')
      }
      if (name.length > 50) {
        throw new Error('姓名不能超过 50 个字符')
      }
      
      // 校验邮箱格式
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
      if (!emailRegex.test(email)) {
        throw new Error('邮箱格式不正确')
      }
      
      // 校验年龄
      if (age < 0 || age > 150) {
        throw new Error('年龄不合法')
      }
      
      // 统一邮箱为小写
      data.setPropertyValue('email', email.toLowerCase())
    }
  )
}
```

### 软删除钩子

```typescript
// 自动记录删除时间
function createSoftDeleteHooks(): EntityHooks {
  return new EntityHooks(
    null,  // beforeSave: 无需处理
    null,  // afterLoad: 无需处理
    
    // beforeDelete: 记录删除时间
    (data) => {
      data.setPropertyValue('deletedAt', Date.now())
      data.setPropertyValue('deletedBy', 'currentUserId')
    }
  )
}
```

### 计算字段

```typescript
// 计算总金额钩子
function createCalculateHooks(): EntityHooks {
  return new EntityHooks(
    // beforeSave: 计算折扣后的价格
    (data) => {
      const price = data.getProperty('price')?.value as number
      const discount = data.getProperty('discount')?.value as number
      
      if (price && discount !== undefined) {
        const finalPrice = price * (1 - discount / 100)
        data.setPropertyValue('finalPrice', Math.round(finalPrice * 100) / 100)
      }
    },
    
    // afterLoad: 计算年龄
    (data) => {
      const birthDate = data.getProperty('birthDate')?.value as number
      if (birthDate) {
        const age = Math.floor((Date.now() - birthDate) / (365.25 * 24 * 60 * 60 * 1000))
        data.setTransient('calculatedAge', age)
      }
    }
  )
}
```

## 异步钩子

钩子函数可以返回 `Promise<void>` 以支持异步操作：

```typescript
const hooks = new EntityHooks(
  // 异步 beforeSave
  async (data) => {
    const email = data.getProperty('email')?.value as string
    
    // 检查邮箱是否已被使用
    const repo = new Repository('User')
    const existing = await repo.createQueryBuilder()
      .where('email', ConditionOperator.EQUAL, email)
      .getOne()
    
    if (existing) {
      throw new Error('邮箱已被使用')
    }
  },
  
  // 异步 afterLoad
  async (data) => {
    // 从远程服务获取额外数据
    // const extraData = await fetchUserExtraData(data.getPropertyValue('id'))
    // data.setTransient('extraData', extraData)
  }
)
```

## 在 Repository 中使用钩子

钩子在 Repository 操作中自动触发：

```typescript
const repo = new Repository('User')

// save() 会触发 beforeSave 钩子
const user = EntityData.from('User', {
  name: '张三',
  email: 'zhangsan@example.com'
})
await repo.save(user)  // 自动填充 createdAt、updatedAt

// findById() 会触发 afterLoad 钩子
const loadedUser = await repo.findById(1)
const config = loadedUser.getTransient('configObj')  // 已解析的 JSON

// remove() 会触发 beforeDelete 钩子
await repo.removeById(1)  // 自动记录 deletedAt
```

## 批量操作中的钩子

### batchInsert 中的钩子

```typescript
const batchOptions = new BatchInsertOptions()
batchOptions.executeHooks = true  // 启用钩子

const users = [
  EntityData.from('User', { name: '用户1', email: 'user1@example.com' }),
  EntityData.from('User', { name: '用户2', email: 'user2@example.com' })
]

// 每个实体都会执行 beforeSave 钩子
const result = await repo.batchInsert(users, batchOptions)
```

### 禁用钩子

如果需要跳过钩子执行，可以设置 `executeHooks = false`：

```typescript
const batchOptions = new BatchInsertOptions()
batchOptions.executeHooks = false  // 禁用钩子，提高批量插入性能

const users = [
  EntityData.from('User', { name: '用户1', email: 'user1@example.com' }),
  EntityData.from('User', { name: '用户2', email: 'user2@example.com' })
]

// 跳过 beforeSave 钩子，直接插入
await repo.batchInsert(users, batchOptions)
```

## 钩子执行顺序

当涉及多个实体操作时，钩子按以下顺序执行：

```
save() 操作:
  1. beforeSave (当前实体)
  2. INSERT/UPDATE
  3. 返回结果

findById() 操作:
  1. SELECT
  2. afterLoad (当前实体)
  3. 返回结果

remove() 操作:
  1. beforeDelete (当前实体)
  2. DELETE
  3. 返回结果
```

## 钩子错误处理

钩子中抛出的错误会中断操作并向上传递：

```typescript
const hooks = new EntityHooks(
  (data) => {
    throw new Error('校验失败')  // 会中断 save() 操作
  }
)

const result = await repo.save(userData)

if (!result.success) {
  console.error(`保存失败: ${result.errorMessage}`)
}
```

## 完整示例

```typescript
// hooks/UserHooks.ts
import { EntityHooks } from 'ocorm'

// 用户完整钩子
export function createUserHooks(): EntityHooks {
  return new EntityHooks(
    // beforeSave
    async (data) => {
      const now = Date.now()
      
      // 自动填充时间戳
      if (!data.getProperty('createdAt')) {
        data.setPropertyValue('createdAt', now)
      }
      data.setPropertyValue('updatedAt', now)
      
      // 校验邮箱格式
      const email = data.getProperty('email')?.value as string
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        throw new Error('邮箱格式不正确')
      }
      
      // 邮箱转小写
      data.setPropertyValue('email', email.toLowerCase())
      
      // 序列化 JSON 字段
      const profile = data.getTransient('profileObj')
      if (profile) {
        data.setPropertyValue('profile', JSON.stringify(profile))
      }
    },
    
    // afterLoad
    (data) => {
      // 反序列化 JSON 字段
      const profileStr = data.getProperty('profile')?.value as string
      if (profileStr) {
        try {
          data.setTransient('profileObj', JSON.parse(profileStr))
        } catch (e) {
          data.setTransient('profileObj', null)
        }
      }
      
      // 计算年龄
      const birthDate = data.getProperty('birthDate')?.value as number
      if (birthDate) {
        const age = Math.floor((Date.now() - birthDate) / (365.25 * 24 * 60 * 60 * 1000))
        data.setTransient('age', age)
      }
    },
    
    // beforeDelete
    (data) => {
      // 检查是否可以删除
      const status = data.getProperty('status')?.value as number
      if (status === -1) {
        throw new Error('该用户已被永久禁用，无法删除')
      }
    }
  )
}

// 在实体注册中使用
import { registerEntity, createEntityOptions } from 'ocorm'

registerEntity('User', createEntityOptions('users', createUserHooks()))
```

## 注意事项

1. **性能考虑**：钩子会增加每次操作的开销，复杂逻辑建议异步执行
2. **循环依赖**：避免在钩子中触发其他实体的钩子导致循环
3. **错误处理**：钩子中的错误会中断当前操作，请做好错误处理
4. **批量操作**：批量操作中的钩子是逐条执行的

## 下一步

- [软删除](09-软删除.md) - 与钩子配合实现逻辑删除
- [错误处理](12-错误处理.md) - 了解如何处理钩子错误
- [最佳实践](15-项目结构推荐.md) - 钩子的组织方式




