# 查询构建器

本章节介绍 OCORM 的链式查询 API，使用 QueryBuilder 可以构建复杂的数据查询。

## 概述

QueryBuilder 提供流畅的链式 API，支持条件筛选、排序、分页、关联加载等功能。

```typescript
const repo = new Repository('User')

// 创建查询构建器
const queryBuilder = repo.createQueryBuilder()
```

## 列名解析规则

QueryBuilder 的 `column` 参数支持 **实体属性名** 或 **数据库列名**，内部会根据实体元数据解析为最终列名。

```typescript
// 假设实体属性名为 createdAt，数据库列名为 created_at
await repo.createQueryBuilder()
  .where('createdAt', ConditionOperator.GREATER, 0)
  .getMany()

// 也可以直接使用数据库列名
await repo.createQueryBuilder()
  .where('created_at', ConditionOperator.GREATER, 0)
  .getMany()
```

## 条件查询

### 基本条件

```typescript
import { ConditionOperator } from 'ocorm'

// 等于
await repo.createQueryBuilder()
  .where('status', ConditionOperator.EQUAL, 1) // column 可为属性名或列名
  .getMany()

// 不等于
await repo.createQueryBuilder()
  .where('status', ConditionOperator.NOT_EQUAL, 0)
  .getMany()

// 大于
await repo.createQueryBuilder()
  .where('age', ConditionOperator.GREATER, 18)
  .getMany()

// 大于等于
await repo.createQueryBuilder()
  .where('age', ConditionOperator.GREATER_OR_EQUAL, 18)
  .getMany()

// 小于
await repo.createQueryBuilder()
  .where('age', ConditionOperator.LESS, 65)
  .getMany()

// 小于等于
await repo.createQueryBuilder()
  .where('age', ConditionOperator.LESS_OR_EQUAL, 65)
  .getMany()
```

### AND/OR 条件

```typescript
// AND 条件
await repo.createQueryBuilder()
  .where('age', ConditionOperator.GREATER_OR_EQUAL, 18)
  .andWhere('status', ConditionOperator.EQUAL, 1)
  .andWhere('deleted', ConditionOperator.EQUAL, 0)
  .getMany()

// OR 条件
await repo.createQueryBuilder()
  .where('name', ConditionOperator.EQUAL, '张三')
  .orWhere('email', ConditionOperator.EQUAL, 'zhangsan@example.com')
  .getMany()

// 组合 AND 和 OR
await repo.createQueryBuilder()
  .where('age', ConditionOperator.GREATER_OR_EQUAL, 18)
  .andWhere((builder) => {
    builder.where('status', ConditionOperator.EQUAL, 1)
      .orWhere('status', ConditionOperator.EQUAL, 2)
  })
  .getMany()
```

### 特殊条件

```typescript
// IN 条件
await repo.createQueryBuilder()
  .whereIn('status', [1, 2, 3])
  .getMany()

// NOT IN 条件
await repo.createQueryBuilder()
  .whereNotIn('status', [0, -1])
  .getMany()

// IS NULL
await repo.createQueryBuilder()
  .whereNull('deletedAt')
  .getMany()

// IS NOT NULL
await repo.createQueryBuilder()
  .whereNotNull('email')
  .getMany()

// BETWEEN
await repo.createQueryBuilder()
  .whereBetween('age', 18, 65)
  .getMany()

// LIKE（模糊查询）
await repo.createQueryBuilder()
  .whereLike('name', '%张%')    // 包含"张"
  .getMany()

await repo.createQueryBuilder()
  .whereLike('email', '%@example.com')  // 以@example.com结尾
  .getMany()
```

## 排序与分页

### 排序

```typescript
import { SortDirection } from 'ocorm'

// 单字段排序
await repo.createQueryBuilder()
  .orderBy('createdAt', 'DESC') // column 可为属性名或列名
  .getMany()

// 多字段排序
await repo.createQueryBuilder()
  .orderBy('status', 'ASC')
  .orderBy('createdAt', 'DESC')
  .getMany()
```

### 分页

```typescript
// 方式一：使用 paginate
await repo.createQueryBuilder()
  .where('status', ConditionOperator.EQUAL, 1)
  .orderBy('createdAt', 'DESC')
  .paginate(1, 20)  // 第 1 页，每页 20 条
  .getPaginated()

// 方式二：使用 limit/offset
await repo.createQueryBuilder()
  .where('status', ConditionOperator.EQUAL, 1)
  .orderBy('createdAt', 'DESC')
  .limit(20)
  .offset(0)
  .getMany()

// 分页结果
const result = await repo.createQueryBuilder()
  .paginate(2, 10)
  .getPaginated()

console.info(`总数据: ${result.total}`)
console.info(`总页数: ${result.totalPages}`)
console.info(`当前页: ${result.page}`)
console.info(`每页数量: ${result.pageSize}`)
console.info(`当前数据: ${result.data.length} 条`)
```

## 关联加载

```typescript
// 加载关联数据
const orders = await repo.createQueryBuilder()
  .where('userId', ConditionOperator.EQUAL, 1)
  .with('orders')  // 加载 orders 关联
  .getMany()

// 获取关联数据
orders.forEach(order => {
  const userData = order.getRelatedData('user')
  console.info(`订单用户: ${userData?.getPropertyValue('name')}`)
})
```

## 执行查询

### 获取单条记录

```typescript
// getOne 返回一条记录或 null
const user = await repo.createQueryBuilder()
  .where('id', ConditionOperator.EQUAL, 1)
  .getOne()
```

### 获取多条记录

```typescript
// getMany 返回记录数组
const users = await repo.createQueryBuilder()
  .where('status', ConditionOperator.EQUAL, 1)
  .getMany()
```

### 获取分页结果

```typescript
// getPaginated 返回分页结果
const result = await repo.createQueryBuilder()
  .paginate(1, 20)
  .getPaginated()

// result 类型 PaginatedResult
console.info(result.data)      // 当前页数据
console.info(result.total)     // 总记录数
console.info(result.page)      // 当前页码
console.info(result.pageSize)  // 每页大小
console.info(result.totalPages) // 总页数
```

## 条件操作符常量

| 常量 | 对应 SQL | 说明 |
|------|---------|------|
| `ConditionOperator.EQUAL` | `=` | 等于 |
| `ConditionOperator.NOT_EQUAL` | `!=` | 不等于 |
| `ConditionOperator.GREATER` | `>` | 大于 |
| `ConditionOperator.GREATER_OR_EQUAL` | `>=` | 大于等于 |
| `ConditionOperator.LESS` | `<` | 小于 |
| `ConditionOperator.LESS_OR_EQUAL` | `<=` | 小于等于 |

## 完整示例

```typescript
// 查询条件构建器示例
class UserQueryBuilder {
  private repo: Repository

  constructor() {
    this.repo = new Repository('User')
  }

  // 搜索用户
  async searchUsers(params: {
    keyword?: string
    status?: number
    minAge?: number
    maxAge?: number
    page?: number
    pageSize?: number
  }) {
    const builder = this.repo.createQueryBuilder()

    // 关键词搜索（姓名或邮箱）
    if (params.keyword) {
      builder.andWhere((b) => {
        b.where('name', ConditionOperator.LIKE, `%${params.keyword}%`)
          .orWhere('email', ConditionOperator.LIKE, `%${params.keyword}%`)
      })
    }

    // 状态筛选
    if (params.status !== undefined) {
      builder.where('status', ConditionOperator.EQUAL, params.status)
    }

    // 年龄范围
    if (params.minAge !== undefined) {
      builder.andWhere('age', ConditionOperator.GREATER_OR_EQUAL, params.minAge)
    }
    if (params.maxAge !== undefined) {
      builder.andWhere('age', ConditionOperator.LESS_OR_EQUAL, params.maxAge)
    }

    // 排序
    builder.orderBy('createdAt', 'DESC')

    // 分页
    const page = params.page || 1
    const pageSize = params.pageSize || 20
    builder.paginate(page, pageSize)

    return await builder.getPaginated()
  }
}
```




