# 实体定义

本章节详细介绍如何在 OCORM 中定义数据实体，包括实体注册、列定义、主键配置和列属性设置。

## 概述

OCORM 使用**装饰器 + 手动注册**的方式定义实体。由于 ArkTS 装饰器的限制，需要通过代码显式注册实体和列的元数据。

## 注册实体

### 基本实体注册

每个实体需要先注册到 `MetadataStorage` 中：

```typescript
import {
  MetadataStorage,
  registerEntity,
  createEntityOptions
} from 'ocorm'

// 注册实体（使用默认表名，即类名）
registerEntity('User')

// 或指定自定义表名
registerEntity('User', createEntityOptions('t_users'))
```

### EntityOptions 配置

`createEntityOptions` 函数接受以下配置：

| 属性 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `tableName` | string | 类名 | 数据库表名 |
| `softDelete` | boolean | false | 是否启用软删除 |
| `hooks` | EntityHooks | null | 生命周期钩子 |

```typescript
import { EntityHooks, createEntityOptions } from 'ocorm'

// 启用软删除
registerEntity('User', createEntityOptions('users'))

// 配置生命周期钩子
const hooks = new EntityHooks(
  (data) => {
    // beforeSave 钩子
    data.setPropertyValue('updatedAt', Date.now())
  },
  (data) => {
    // afterLoad 钩子
    // 可以在这里解析 JSON 字段
  }
)

registerEntity('User', createEntityOptions('users'))
```

## 定义列

### 列元数据

使用 `ColumnMetadata` 类定义列：

```typescript
import {
  MetadataStorage,
  ColumnMetadata,
  ColumnType
} from 'ocorm'

const storage = MetadataStorage.getInstance()

// 创建列元数据
const nameColumn = new ColumnMetadata('name', 'name')
nameColumn.columnType = ColumnType.TEXT
nameColumn.isNullable = false
nameColumn.isUnique = false
storage.registerColumn('User', nameColumn)
```

### 使用 ColumnOptions

也可以使用 `ColumnOptions` 类简化列定义：

```typescript
import {
  registerColumn,
  registerPrimaryKey,
  registerAutoIncrementPrimaryKey,
  createColumnOptions
} from 'ocorm'

// 注册普通列
registerColumn(
  'User',
  'name',
  createColumnOptions()
    .setType(ColumnType.TEXT)
    .setNullable(false)
)

// 注册主键
registerAutoIncrementPrimaryKey('User', 'id', 'id')
```

### 列属性说明

| 属性 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `columnType` | ColumnType | TEXT | 列数据类型 |
| `isNullable` | boolean | true | 是否允许为空 |
| `isUnique` | boolean | false | 是否唯一 |
| `isPrimaryKey` | boolean | false | 是否为主键 |
| `isAutoIncrement` | boolean | false | 是否自增（仅 INTEGER 主键） |
| `defaultValue` | string \| number | null | 默认值 |
| `length` | number | 0 | TEXT 类型最大长度 |

## 主键配置

### 自增主键（推荐）

推荐使用自增主键作为实体标识：

```typescript
import {
  registerEntity,
  registerAutoIncrementPrimaryKey,
  createEntityOptions
} from 'ocorm'

registerEntity('User', createEntityOptions('users'))
registerAutoIncrementPrimaryKey('User', 'id', 'id')
```

生成的 SQL：

```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  ...
)
```

### 手动主键

如果需要使用 UUID 或其他自定义主键：

```typescript
import {
  registerEntity,
  registerPrimaryKey,
  createEntityOptions
} from 'ocorm'

registerEntity('User', createEntityOptions('users'))
registerPrimaryKey('User', 'uuid', 'uuid')
```

生成的 SQL：

```sql
CREATE TABLE users (
  uuid TEXT PRIMARY KEY,
  ...
)
```

### 复合主键

SQLite 支持复合主键，但 OCORM 建议使用单字段主键。如需复合主键，可通过原生 SQL 实现。

## 列类型

### 支持的列类型

| ColumnType | SQLite 类型 | 对应 ArkTS 类型 |
|------------|-------------|----------------|
| `ColumnType.TEXT` | TEXT | string |
| `ColumnType.INTEGER` | INTEGER | number, boolean |
| `ColumnType.REAL` | REAL | number |
| `ColumnType.BLOB` | BLOB | Uint8Array |

### 类型映射

```typescript
import { ColumnType, inferColumnType } from 'ocorm'

// 手动设置列类型
const nameColumn = new ColumnMetadata('name', 'name')
nameColumn.columnType = ColumnType.TEXT

// 自动推断列类型
const ageColumn = new ColumnMetadata('age', 'age')
ageColumn.columnType = inferColumnType('number')
```

### 特殊类型处理

#### Date 类型

Date 类型存储为 Unix 时间戳（毫秒）：

```typescript
const createdAtColumn = new ColumnMetadata('createdAt', 'created_at')
createdAtColumn.columnType = ColumnType.INTEGER
storage.registerColumn('Order', createdAtColumn)

// 存储时
data.setPropertyValue('createdAt', Date.now())

// 读取时
const timestamp = data.getProperty('createdAt')?.value as number
const date = new Date(timestamp)
```

#### JSON 对象

复杂对象序列化为 JSON 字符串存储：

```typescript
const configColumn = new ColumnMetadata('config', 'config')
configColumn.columnType = ColumnType.TEXT
storage.registerColumn('User', configColumn)

// 存储时
const configObj = { theme: 'dark', fontSize: 14 }
data.setPropertyValue('config', JSON.stringify(configObj))

// 读取后解析（建议在 afterLoad 钩子中处理）
const configStr = data.getProperty('config')?.value as string
const config = JSON.parse(configStr)
```

## 完整实体示例

### User 实体

```typescript
// entities/User.ts
import {
  MetadataStorage,
  ColumnMetadata,
  ColumnType,
  registerEntity,
  registerAutoIncrementPrimaryKey,
  createEntityOptions,
  EntityHooks
} from 'ocorm'

export function registerUserEntity(): void {
  // 1. 注册实体
  registerEntity('User', createEntityOptions('users'))
  
  // 2. 注册主键
  registerAutoIncrementPrimaryKey('User', 'id', 'id')
  
  // 3. 注册列
  const storage = MetadataStorage.getInstance()
  
  // name 列
  const nameColumn = new ColumnMetadata('name', 'name')
  nameColumn.columnType = ColumnType.TEXT
  nameColumn.isNullable = false
  storage.registerColumn('User', nameColumn)
  
  // email 列
  const emailColumn = new ColumnMetadata('email', 'email')
  emailColumn.columnType = ColumnType.TEXT
  emailColumn.isUnique = true
  storage.registerColumn('User', emailColumn)
  
  // password 列
  const passwordColumn = new ColumnMetadata('password', 'password')
  passwordColumn.columnType = ColumnType.TEXT
  passwordColumn.isNullable = false
  storage.registerColumn('User', passwordColumn)
  
  // age 列
  const ageColumn = new ColumnMetadata('age', 'age')
  ageColumn.columnType = ColumnType.INTEGER
  ageColumn.defaultValue = 0
  storage.registerColumn('User', ageColumn)
  
  // status 列
  const statusColumn = new ColumnMetadata('status', 'status')
  statusColumn.columnType = ColumnType.INTEGER
  statusColumn.defaultValue = 1  // 1: 启用, 0: 禁用
  storage.registerColumn('User', statusColumn)
  
  // created_at 列
  const createdAtColumn = new ColumnMetadata('createdAt', 'created_at')
  createdAtColumn.columnType = ColumnType.INTEGER
  storage.registerColumn('User', createdAtColumn)
  
  // updated_at 列
  const updatedAtColumn = new ColumnMetadata('updatedAt', 'updated_at')
  updatedAtColumn.columnType = ColumnType.INTEGER
  storage.registerColumn('User', updatedAtColumn)
}
```

### Order 实体（带外键）

```typescript
// entities/Order.ts
import {
  MetadataStorage,
  ColumnMetadata,
  ColumnType,
  registerEntity,
  registerAutoIncrementPrimaryKey,
  createEntityOptions
} from 'ocorm'

export function registerOrderEntity(): void {
  registerEntity('Order', createEntityOptions('orders'))
  registerAutoIncrementPrimaryKey('Order', 'id', 'id')
  
  const storage = MetadataStorage.getInstance()
  
  // user_id 外键列
  const userIdColumn = new ColumnMetadata('userId', 'user_id')
  userIdColumn.columnType = ColumnType.INTEGER
  userIdColumn.isNullable = false
  storage.registerColumn('Order', userIdColumn)
  
  // order_no 列（订单号）
  const orderNoColumn = new ColumnMetadata('orderNo', 'order_no')
  orderNoColumn.columnType = ColumnType.TEXT
  orderNoColumn.isUnique = true
  storage.registerColumn('Order', orderNoColumn)
  
  // amount 列（金额）
  const amountColumn = new ColumnMetadata('amount', 'amount')
  amountColumn.columnType = ColumnType.REAL
  amountColumn.isNullable = false
  amountColumn.defaultValue = 0
  storage.registerColumn('Order', amountColumn)
  
  // status 列
  const statusColumn = new ColumnMetadata('status', 'status')
  statusColumn.columnType = ColumnType.INTEGER
  statusColumn.defaultValue = 0  // 0: 待付款, 1: 已付款, 2: 已发货, 3: 已完成
  storage.registerColumn('Order', statusColumn)
  
  // created_at 列
  const createdAtColumn = new ColumnMetadata('createdAt', 'created_at')
  createdAtColumn.columnType = ColumnType.INTEGER
  storage.registerColumn('Order', createdAtColumn)
}
```

## 统一导出

```typescript
// entities/index.ts
import { registerUserEntity } from './User'
import { registerOrderEntity } from './Order'

export function registerAllEntities(): void {
  registerUserEntity()
  registerOrderEntity()
  
  const count = MetadataStorage.getInstance().getAllEntities().length
  console.info(`已注册 ${count} 个实体`)
}
```

## 验证实体定义

### 检查实体元数据

```typescript
import { MetadataStorage } from 'ocorm'

const storage = MetadataStorage.getInstance()

// 获取实体元数据
const userMetadata = storage.getEntityMetadata('User')
if (userMetadata) {
  console.info(`实体: ${userMetadata.entityName}`)
  console.info(`表名: ${userMetadata.tableName}`)
  console.info(`列数: ${userMetadata.columns.length}`)
  
  // 遍历列
  userMetadata.columns.forEach(column => {
    console.info(`  - ${column.propertyName} (${column.columnName}): ${column.columnType}`)
  })
}

// 检查实体是否存在
if (storage.hasEntity('User')) {
  console.info('User 实体已注册')
}
```

### 获取所有实体

```typescript
const entities = storage.getAllEntities()
entities.forEach(entity => {
  console.info(`实体: ${entity.entityName}, 表: ${entity.tableName}`)
})
```

## 常见问题

### 问题 1：实体未注册错误

**症状**：`EntityNotRegisteredError: Entity 'User' is not registered`

**解决方案**：确保在使用 Repository 之前调用了实体注册函数。

```typescript
// 错误用法
const repo = new Repository('User')  // 可能报错

// 正确用法
registerUserEntity()  // 先注册
const repo = new Repository('User')  // 再使用
```

### 问题 2：列名与属性名不同

**症状**：查询结果为空或字段值不对

**解决方案**：在创建 `ColumnMetadata` 时指定正确的列名。

```typescript
// 属性名是 userId，但数据库列名是 user_id
const userIdColumn = new ColumnMetadata('userId', 'user_id')
```

### 问题 3：主键自增不生效

**症状**：插入数据后主键没有自动增长

**解决方案**：确保主键是 INTEGER 类型。

```typescript
// 正确
const pkColumn = new ColumnMetadata('id', 'id')
pkColumn.setPrimaryKey(true)
pkColumn.setAutoIncrement(true)
pkColumn.setType(ColumnType.INTEGER)

// 错误：TEXT 类型不支持自增
const wrongColumn = new ColumnMetadata('id', 'id')
wrongColumn.setPrimaryKey(true)
wrongColumn.setAutoIncrement(true)
wrongColumn.setType(ColumnType.TEXT)  // 无效！
```

## 下一步

- [CRUD 操作](04-CRUD操作.md) - 学习如何操作实体数据
- [关联关系](06-关联关系.md) - 定义实体间的关联关系
- [生命周期钩子](08-生命周期钩子.md) - 使用钩子处理业务逻辑

## 安全与稳定性修复记录

### v2.1.19 安全修复

#### SQL 注入防护

OCORM 的 `SchemaBuilder` 在生成 SQL 语句时会自动对表名和列名进行转义处理，使用双引号包裹并转义内部的双引号字符，防止 SQL 注入攻击。

```typescript
import { SchemaBuilder } from 'ocorm'

const builder = new SchemaBuilder()
const sql = builder.generateCreateTableSql(metadata)
// 输出示例: CREATE TABLE IF NOT EXISTS "User" ("id" INTEGER PRIMARY KEY, "name" TEXT NOT NULL)
```

> **安全提示**: OCORM 已内置 SQL 注入防护，但开发者仍需注意：
> - 不要将用户输入直接拼接到 SQL 语句中
> - 使用参数化查询而非字符串拼接
> - 对特殊字符进行必要的过滤

#### 类型枚举使用规范

OCORM 内部使用 `ColumnType` 枚举来确保类型安全，在进行类型判断和值转换时请始终使用枚举值而非字符串字面量：

```typescript
// ✅ 正确：使用枚举
switch (columnMetadata.columnType) {
  case ColumnType.INTEGER:
    value = resultSet.getLong(columnIndex)
    break
  case ColumnType.TEXT:
    value = resultSet.getString(columnIndex)
    break
}

// ❌ 错误：使用字符串字面量
switch (columnMetadata.columnType) {
  case 'INTEGER':  // 不推荐
    value = resultSet.getLong(columnIndex)
    break
}
```
