# 日志系统

本章节介绍 OCORM 的日志系统，包括 SQL 日志、性能监控和日志级别配置。

## 概述

OCORM 提供完整的日志功能，帮助开发者：

- 调试 SQL 查询
- 监控数据库性能
- 排查问题
- 审计操作

## 日志配置

### 启用日志

```typescript
import { DatabaseConfig, LogLevel } from 'ocorm'
import { relationalStore } from '@kit.ArkData'

const config = new DatabaseConfig('myapp.db', relationalStore.SecurityLevel.S1)

// 启用日志
config.enableLogger = true

// 设置日志级别
config.loggerLevel = LogLevel.DEBUG  // DEBUG / INFO / WARN / ERROR / NONE
```

### 日志级别

| 级别 | 说明 | 用途 |
|------|------|------|
| `LogLevel.DEBUG` | 详细调试信息 | 开发调试 |
| `LogLevel.INFO` | 一般信息 | 生产环境监控 |
| `LogLevel.WARN` | 警告信息 | 潜在问题 |
| `LogLevel.ERROR` | 错误信息 | 错误排查 |
| `LogLevel.NONE` | 不输出日志 | 禁用日志 |

## 日志输出示例

### SQL 查询日志

```
[OCORM][Query][12ms] SELECT * FROM users WHERE id = 1
[OCORM][Query][5ms] SELECT * FROM users WHERE status = 1 ORDER BY created_at DESC
[OCORM][Insert][8ms] INSERT INTO users (name, email) VALUES (?, ?)
[OCORM][Update][3ms] UPDATE users SET name = ? WHERE id = ?
[OCORM][Delete][2ms] DELETE FROM users WHERE id = ?
```

### 事务日志

```
[OCORM][Trans][Start] Transaction started
[OCORM][Trans][Commit] Transaction committed
[OCORM][Trans][Rollback] Transaction rolled back
```

### 错误日志

```
[OCORM][Error] INSERT 失败: UNIQUE constraint failed: users.email
[OCORM][Error] SELECT 失败: no such table: users
```

### 性能日志

```
[OCORM][Performance] 批量插入 1000 条数据耗时: 152ms
[OCORM][Performance] 复杂查询耗时: 45ms
```

## 获取日志记录器

### Logger 单例

```typescript
import { Logger, LogLevel } from 'ocorm'

// 获取日志记录器
const logger = Logger.getInstance()

// 设置日志级别
logger.setLevel(LogLevel.DEBUG)

// 手动记录日志
logger.logDebug('调试信息')
logger.logInfo('一般信息')
logger.logWarn('警告信息')
logger.logError('错误信息')
```

### 日志查询

```typescript
import { Logger } from 'ocorm'

const logger = Logger.getInstance()

// 查询最近的 SQL 日志
const recentLogs = logger.getRecentLogs(100)

// 按类型查询
const queryLogs = logger.getLogsByType('Query')
const errorLogs = logger.getLogsByType('Error')

// 清空日志
logger.clearLogs()
```

## 自定义日志输出

### 日志格式化

```typescript
import { Logger, LogFormat } from 'ocorm'

const logger = Logger.getInstance()

// 自定义日志格式
logger.setFormatter((entry) => {
  return `[${entry.timestamp}] [${entry.level}] [${entry.type}] ${entry.message}`
})
```

### 日志级别动态调整

```typescript
// 根据环境动态设置日志级别
function configureLogger(): void {
  const logger = Logger.getInstance()
  
  if (__DEV__) {
    // 开发环境：详细日志
    logger.setLevel(LogLevel.DEBUG)
  } else {
    // 生产环境：只记录错误
    logger.setLevel(LogLevel.ERROR)
  }
}
```

## 日志分析

### 慢查询日志

```typescript
import { Logger } from 'ocorm'

const logger = Logger.getInstance()

// 获取所有查询日志
const queryLogs = logger.getLogsByType('Query')

// 找出慢查询（超过 100ms）
const slowQueries = queryLogs.filter(log => {
  return log.duration && log.duration > 100
})

slowQueries.forEach(log => {
  console.info(`慢查询 (${log.duration}ms): ${log.message}`)
})
```

### 错误统计

```typescript
import { Logger } from 'ocorm'

const logger = Logger.getInstance()

// 统计错误类型
const errorLogs = logger.getLogsByType('Error')

const errorCounts: Record<string, number> = {}
errorLogs.forEach(log => {
  const type = log.message.split(':')[0]  // 提取错误类型
  errorCounts[type] = (errorCounts[type] || 0) + 1
})

console.info('错误统计:', errorCounts)
```

### 查询频率分析

```typescript
import { Logger } from 'ocorm'

const logger = Logger.getInstance()

// 分析查询频率
const queryLogs = logger.getLogsByType('Query')

const queryCounts: Record<string, number> = {}
queryLogs.forEach(log => {
  // 提取查询语句（去除参数）
  const query = log.message.split('[')[0].trim()
  queryCounts[query] = (queryCounts[query] || 0) + 1
})

// 排序并输出高频查询
const sortedQueries = Object.entries(queryCounts)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10)

sortedQueries.forEach(([query, count]) => {
  console.info(`次数: ${count}, 查询: ${query}`)
})
```

## 生产环境建议

### 1. 日志级别选择

```typescript
// 生产环境配置
const config = new DatabaseConfig('myapp.db', relationalStore.SecurityLevel.S1)
config.enableLogger = true
config.loggerLevel = LogLevel.WARN  // 只记录警告和错误
```

### 2. 日志轮转

```typescript
// 限制日志数量
const logger = Logger.getInstance()
logger.setMaxEntries(1000)  // 只保留最近 1000 条

// 定期清理
setInterval(() => {
  if (logger.getCount() > 1000) {
    logger.clearLogs()
  }
}, 60 * 60 * 1000)  // 每小时检查一次
```

### 3. 性能影响

```typescript
// 日志会影响性能，生产环境注意：
const config = new DatabaseConfig('myapp.db', relationalStore.SecurityLevel.S1)
config.enableLogger = true
config.loggerLevel = LogLevel.ERROR  // 生产环境用 ERROR 级别
```

## 完整示例

```typescript
// utils/Logger.ts
import { Logger, LogLevel } from 'ocorm'

class AppLogger {
  private logger: Logger

  constructor() {
    this.logger = Logger.getInstance()
    this.configure()
  }

  private configure(): void {
    // 根据环境设置日志级别
    const isDebugMode = __APP_DEBUG__  // 或通过配置获取
    this.logger.setLevel(isDebugMode ? LogLevel.DEBUG : LogLevel.WARN)
  }

  // 封装日志方法
  debug(message: string, data?: any): void {
    if (data) {
      this.logger.logDebug(`${message} ${JSON.stringify(data)}`)
    } else {
      this.logger.logDebug(message)
    }
  }

  info(message: string, data?: any): void {
    if (data) {
      this.logger.logInfo(`${message} ${JSON.stringify(data)}`)
    } else {
      this.logger.logInfo(message)
    }
  }

  warn(message: string, data?: any): void {
    if (data) {
      this.logger.logWarn(`${message} ${JSON.stringify(data)}`)
    } else {
      this.logger.logWarn(message)
    }
  }

  error(message: string, error?: Error): void {
    const msg = error ? `${message}: ${error.message}` : message
    this.logger.logError(msg)
    
    // 同时输出堆栈
    if (error?.stack) {
      this.logger.logError(error.stack)
    }
  }

  // 查询相关
  getQueryLogs(): any[] {
    return this.logger.getLogsByType('Query')
  }

  getErrorLogs(): any[] {
    return this.logger.getLogsByType('Error')
  }

  // 性能分析
  getSlowQueries(thresholdMs: number = 100): any[] {
    return this.logger.getLogsByType('Query')
      .filter(log => log.duration && log.duration > thresholdMs)
  }

  // 清理
  clear(): void {
    this.logger.clearLogs()
  }
}

export const appLogger = new AppLogger()
```

## 下一步

- [错误处理](12-错误处理.md) - 了解错误日志处理
- [性能优化](13-性能优化.md) - 使用日志分析优化性能

## 安全修复记录

### v2.1.19 敏感数据脱敏

OCORM 的日志系统内置了敏感数据脱敏功能。在 DEBUG 级别记录 SQL 日志时，会自动对以下内容进行脱敏处理：

- **字符串值**: 将引号内的字符串替换为 `[***]`
- **长数字**: 将超过 6 位的连续数字替换为 `[***]`（可能是手机号、身份证号等）

```typescript
// 原始 SQL
// INSERT INTO users (name, phone, id_card) VALUES ('张三', '13812345678', '110101199001011234')

// 脱敏后的日志
// INSERT INTO users (name, phone, id_card) VALUES ('[***]', '[***]', '[***]')
```

> **安全建议**: 虽然 OCORM 已内置脱敏功能，但在生产环境建议：
> - 使用 `LogLevel.WARN` 或 `LogLevel.ERROR` 级别，避免记录详细 SQL
> - 不要在日志中输出完整的用户敏感信息
> - 定期审计日志内容，确保无敏感数据泄露
